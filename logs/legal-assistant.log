2025-10-11 09:43:54.520 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 27532 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 09:43:54.531 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 09:43:57.472 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 09:43:57.642 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@2dc77962
2025-10-11 09:43:57.720 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 09:43:57.747 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 09:43:57.757 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 09:43:57.867 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 09:43:57.871 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 09:43:58.467 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 09:44:00.552 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 09:44:00.619 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 09:44:00.621 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 7 个模板
2025-10-11 09:44:00.647 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 09:44:00.647 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 09:44:00.648 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 09:44:00.648 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 09:44:00.648 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 09:44:00.648 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 09:44:00.648 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 09:44:00.704 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 09:44:00.866 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 09:44:00.867 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 09:44:01.620 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 09:44:01.657 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 09:44:01.660 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 09:44:01.665 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 09:44:01.665 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 09:44:01.666 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 09:44:01.704 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 09:44:01.926 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 09:44:01.929 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 09:44:01.930 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 09:44:01.930 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 09:44:02.168 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 09:44:02.179 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 09:44:02.182 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 09:44:02.182 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 09:44:02.182 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 09:44:02.192 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 09:44:02.192 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 09:44:02.226 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 09:44:02.226 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 09:44:02.226 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 09:44:02.226 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 09:44:02.226 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 09:44:02.226 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 09:44:02.226 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 09:44:02.250 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 09:44:02.261 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 09:44:02.276 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 09:44:02.276 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 09:44:02.290 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 09:44:02.290 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 09:44:02.292 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 09:44:02.293 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 09:44:02.295 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 09:44:02.296 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 09:44:02.359 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 09:44:03.309 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 09:44:03.484 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 09:44:03.486 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 09:44:03.516 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 09:44:03.519 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 09:44:03.662 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 09:44:03.906 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 09:44:04.279 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 09:44:04.465 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 09:44:05.520 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 11.42 seconds (process running for 11.704)
2025-10-11 09:44:05.526 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 09:44:05.527 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 09:44:05.646 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 09:44:08.477 [main] INFO  c.r.L.u.ReportContentValidatorTest - Starting ReportContentValidatorTest using Java 21.0.5 with PID 17416 (started by river in F:\LegalAssistant)
2025-10-11 09:44:08.478 [main] INFO  c.r.L.u.ReportContentValidatorTest - The following 1 profile is active: "test"
2025-10-11 09:44:13.516 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 09:44:13.874 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection conn0: url=jdbc:h2:mem:testdb user=SA
2025-10-11 09:44:13.938 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 09:44:13.969 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: H2Dialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 09:44:15.331 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 09:44:15.332 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 7 个模板
2025-10-11 09:44:15.374 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 09:44:15.374 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 09:44:15.374 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 09:44:15.375 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 09:44:15.375 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 09:44:15.375 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 09:44:15.375 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 09:44:17.097 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 09:44:17.329 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化测试环境内存嵌入存储
2025-10-11 09:44:18.244 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 09:44:18.298 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 09:44:18.302 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 09:44:18.309 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 09:44:18.311 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 09:44:18.312 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 09:44:18.347 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 09:44:18.549 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 09:44:18.553 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 09:44:18.554 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 09:44:18.554 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 09:44:18.898 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 09:44:18.912 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 09:44:18.914 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 09:44:18.914 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 09:44:18.914 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 09:44:18.955 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 09:44:18.955 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 09:44:19.001 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 09:44:19.002 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 09:44:19.002 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 09:44:19.002 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 09:44:19.002 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 09:44:19.002 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 09:44:19.002 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 09:44:19.018 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 09:44:19.028 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 09:44:19.045 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 09:44:19.045 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 09:44:19.059 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 09:44:19.060 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 09:44:19.066 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 09:44:19.066 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 09:44:19.069 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 09:44:19.069 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 09:44:19.861 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 09:44:20.066 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 09:44:20.069 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 09:44:20.117 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 09:44:20.119 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 09:44:20.298 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 09:44:20.536 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 09:44:20.937 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 09:44:21.296 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 09:44:21.427 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 09:44:22.313 [main] INFO  c.r.L.u.ReportContentValidatorTest - Started ReportContentValidatorTest in 14.657 seconds (process running for 17.172)
2025-10-11 09:44:22.324 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 09:44:22.326 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 09:44:22.483 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 开始自动索引...
2025-10-11 09:44:22.483 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始批量索引目录: uploads/law, 递归: false
2025-10-11 09:44:22.484 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 发现 6 个文档待索引
2025-10-11 09:44:22.484 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\刑法.pdf
2025-10-11 09:44:25.375 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 09:44:25.379 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 09:45:16.224 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 09:45:16.227 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 09:45:44.677 [main] INFO  c.r.L.u.ReportContentValidatorTest - Starting ReportContentValidatorTest using Java 21.0.5 with PID 7584 (started by river in F:\LegalAssistant)
2025-10-11 09:45:44.678 [main] INFO  c.r.L.u.ReportContentValidatorTest - The following 1 profile is active: "test"
2025-10-11 09:45:49.851 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 09:45:50.200 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection conn0: url=jdbc:h2:mem:testdb user=SA
2025-10-11 09:45:50.274 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 09:45:50.308 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: H2Dialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 09:45:51.670 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 09:45:51.671 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 7 个模板
2025-10-11 09:45:51.714 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 09:45:51.714 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 09:45:51.714 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 09:45:51.714 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 09:45:51.714 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 09:45:51.714 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 09:45:51.714 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 09:45:53.338 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 09:45:53.589 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化测试环境内存嵌入存储
2025-10-11 09:45:54.524 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 09:45:54.580 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 09:45:54.583 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 09:45:54.590 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 09:45:54.591 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 09:45:54.592 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 09:45:54.634 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 09:45:54.816 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 09:45:54.819 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 09:45:54.820 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 09:45:54.820 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 09:45:55.229 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 09:45:55.243 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 09:45:55.245 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 09:45:55.245 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 09:45:55.245 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 09:45:55.259 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 09:45:55.259 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 09:45:55.305 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 09:45:55.305 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 09:45:55.305 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 09:45:55.305 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 09:45:55.305 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 09:45:55.305 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 09:45:55.306 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 09:45:55.321 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 09:45:55.332 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 09:45:55.345 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 09:45:55.345 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 09:45:55.358 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 09:45:55.358 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 09:45:55.365 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 09:45:55.365 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 09:45:55.368 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 09:45:55.368 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 09:45:56.176 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 09:45:56.355 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 09:45:56.357 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 09:45:56.391 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 09:45:56.392 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 09:45:56.544 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 09:45:56.793 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 09:45:57.268 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 09:45:57.551 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 09:45:57.698 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 09:45:58.562 [main] INFO  c.r.L.u.ReportContentValidatorTest - Started ReportContentValidatorTest in 14.601 seconds (process running for 16.743)
2025-10-11 09:45:58.570 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 09:45:58.572 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 09:45:58.732 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 开始自动索引...
2025-10-11 09:45:58.732 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始批量索引目录: uploads/law, 递归: false
2025-10-11 09:45:58.732 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 发现 6 个文档待索引
2025-10-11 09:45:58.733 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\刑法.pdf
2025-10-11 09:46:01.682 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 09:46:01.686 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 09:46:35.802 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 39192 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 09:46:35.803 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 09:46:38.798 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 09:46:38.931 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@6dadcf58
2025-10-11 09:46:38.973 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 09:46:38.991 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 09:46:38.997 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 09:46:39.074 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 09:46:39.076 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 09:46:39.432 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 09:46:40.914 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 09:46:40.961 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 09:46:40.962 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 7 个模板
2025-10-11 09:46:40.981 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 09:46:40.982 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 09:46:40.982 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 09:46:40.982 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 09:46:40.982 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 09:46:40.982 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 09:46:40.982 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 09:46:41.016 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 09:46:41.119 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 09:46:41.119 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 09:46:41.689 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 09:46:41.717 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 09:46:41.719 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 09:46:41.723 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 09:46:41.723 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 09:46:41.724 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 09:46:41.754 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 09:46:41.937 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 09:46:41.939 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 09:46:41.939 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 09:46:41.940 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 09:46:42.124 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 09:46:42.132 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 09:46:42.133 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 09:46:42.133 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 09:46:42.134 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 09:46:42.139 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 09:46:42.139 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 09:46:42.159 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 09:46:42.160 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 09:46:42.160 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 09:46:42.160 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 09:46:42.161 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 09:46:42.161 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 09:46:42.161 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 09:46:42.173 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 09:46:42.180 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 09:46:42.191 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 09:46:42.192 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 09:46:42.200 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 09:46:42.200 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 09:46:42.202 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 09:46:42.203 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 09:46:42.204 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 09:46:42.204 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 09:46:42.252 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 09:46:42.659 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 09:46:42.791 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 09:46:42.793 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 09:46:42.816 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 09:46:42.817 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 09:46:42.943 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 09:46:43.132 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 09:46:43.420 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 09:46:43.611 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 09:46:44.439 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.042 seconds (process running for 9.33)
2025-10-11 09:46:44.445 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 09:46:44.446 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 09:46:44.527 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 09:46:46.766 [http-nio-8080-exec-1] INFO  c.r.L.c.AuthenticationController - 用户登录请求: admin
2025-10-11 09:46:46.984 [http-nio-8080-exec-1] INFO  c.r.L.c.AuthenticationController - 用户 admin 登录成功
2025-10-11 09:46:46.999 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=bb3ca3e8, method=POST, uri=/api/v1/auth/login, status=200, duration=259ms
2025-10-11 09:46:47.346 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b15c81b3, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=45ms
2025-10-11 09:46:49.162 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3c0b28c9, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=8ms
2025-10-11 09:46:56.309 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 25
2025-10-11 09:46:56.352 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 25, 文件大小: 341043 bytes
2025-10-11 09:46:56.352 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 农村土地经营权出租合同分析报告.pdf
2025-10-11 09:46:56.353 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 25, 文件大小: 341043 bytes, 文件名: 农村土地经营权出租合同分析报告.pdf
2025-10-11 09:46:56.355 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=373b6ca2, method=GET, uri=/api/v1/contracts/25/report, status=200, duration=48ms
2025-10-11 09:47:06.670 [http-nio-8080-exec-5] INFO  c.r.L.service.ContractReviewService - 删除审查记录: 25
2025-10-11 09:47:06.725 [http-nio-8080-exec-5] INFO  c.r.L.c.ContractReviewController - 用户 admin 删除了审查记录 25
2025-10-11 09:47:06.727 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5e1ae6f9, method=DELETE, uri=/api/v1/contracts/25, status=200, duration=67ms
2025-10-11 09:47:10.205 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=d7312256, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=5ms
2025-10-11 09:47:20.868 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 09:47:20.891 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3c9c18fa, method=GET, uri=/api/v1/chat/sessions, status=200, duration=24ms
2025-10-11 09:47:46.238 [http-nio-8080-exec-9] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我农村土地承包需要注意哪些事项, modelType=UNIFIED
2025-10-11 09:47:46.240 [http-nio-8080-exec-9] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 09:47:46.262 [http-nio-8080-exec-9] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760147266185_pl9emds6w, userId=1, title=请你告诉我农村土地承包需要注意哪些事项
2025-10-11 09:47:46.287 [http-nio-8080-exec-9] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 09:47:46.288 [http-nio-8080-exec-9] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 09:47:46.290 [Async-1] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='请你告诉我农村土地承包需要注意哪些事项', length=19
2025-10-11 09:47:46.290 [Async-1] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 09:47:46.291 [Async-1] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 09:47:46.294 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b0384c58, method=POST, uri=/api/v1/chat/stream, status=200, duration=90ms
2025-10-11 09:49:06.300 [ForkJoinPool.commonPool-worker-2] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 3261
2025-10-11 09:49:06.308 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 09:49:06.334 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 09:49:06.342 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=84ec7b56, method=GET, uri=/api/v1/chat/sessions, status=200, duration=9ms
2025-10-11 09:49:35.201 [http-nio-8080-exec-1] INFO  c.r.L.service.FileStorageService - 文件已存在，跳过保存: F:\LegalAssistant\uploads\contracts\bf28389098fa937be57de5fa649c01f7b136b425a044e3dfd55d13dd1412502f_农村土地经营权出租合同.docx
2025-10-11 09:49:35.203 [http-nio-8080-exec-1] INFO  c.r.L.service.ContractReviewService - 创建待处理审查记录，用户: admin, 文件: 农村土地经营权出租合同.docx
2025-10-11 09:49:35.218 [http-nio-8080-exec-1] INFO  c.r.L.service.ContractReviewService - 待处理审查记录已创建 - ID: 26, 文件: 农村土地经营权出租合同.docx
2025-10-11 09:49:35.223 [Async-2] INFO  c.r.L.service.ContractReviewService - 开始异步处理合同文件，审查ID: 26
2025-10-11 09:49:35.223 [Async-2] INFO  c.r.L.service.ContractReviewService - 异步处理线程: Async-2
2025-10-11 09:49:35.224 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=db07b337, method=POST, uri=/api/v1/contracts/upload, status=202, duration=51ms
2025-10-11 09:49:35.228 [Async-2] INFO  c.r.L.service.ContractReviewService - 开始解析文件: 农村土地经营权出租合同.docx, 路径: F:\LegalAssistant\uploads\contracts\bf28389098fa937be57de5fa649c01f7b136b425a044e3dfd55d13dd1412502f_农村土地经营权出租合同.docx
2025-10-11 09:49:35.228 [Async-2] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 农村土地经营权出租合同.docx, 类型: docx, 大小: 30836 bytes
2025-10-11 09:49:35.246 [http-nio-8080-exec-3] INFO  c.r.L.c.ContractReviewController - 开始异步合同分析，审查ID: 26
2025-10-11 09:49:35.247 [http-nio-8080-exec-3] INFO  c.r.L.c.ContractReviewController - 用户 admin 通过JWT验证，开始处理合同分析，reviewId: 26
2025-10-11 09:49:35.248 [http-nio-8080-exec-3] INFO  c.r.L.c.ContractReviewController - SSE连接已建立: reviewId=26
2025-10-11 09:49:35.250 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=bb9beaeb, method=GET, uri=/api/v1/contracts/26/analyze-async, status=200, duration=6ms
2025-10-11 09:49:35.251 [Async-3] INFO  c.r.L.service.ContractReviewService - 开始异步分析合同（四步流程版），审查ID: 26
2025-10-11 09:49:35.251 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=26
2025-10-11 09:49:35.253 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 09:49:35.738 [Async-2] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 农村土地经营权出租合同.docx, 内容长度: 3686 字符
2025-10-11 09:49:35.739 [Async-2] INFO  c.r.L.service.ContractReviewService - 文件解析成功: 农村土地经营权出租合同.docx, 内容长度: 3686
2025-10-11 09:49:35.739 [Async-2] INFO  c.r.L.service.ContractReviewService - 文档解析完成，文本内容已保存: reviewId=26, 文本长度: 3686
2025-10-11 09:49:35.739 [Async-2] INFO  c.r.L.service.EtlService - 开始处理文本内容，长度: 3686 字符
2025-10-11 09:49:35.742 [Async-2] INFO  c.r.L.service.EtlService - 文本分块完成，生成 403 个文本块
2025-10-11 09:49:36.269 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=26
2025-10-11 09:49:36.271 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 09:49:37.286 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=26
2025-10-11 09:49:37.289 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 09:49:38.300 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=26
2025-10-11 09:49:38.302 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 09:49:39.314 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=26
2025-10-11 09:49:39.315 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 09:49:40.324 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=26
2025-10-11 09:49:40.326 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 09:49:41.336 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=26
2025-10-11 09:49:41.338 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 09:49:41.914 [Async-2] INFO  c.r.L.service.EtlService - 文本内容处理完成，403 个向量块已存储
2025-10-11 09:49:41.914 [Async-2] INFO  c.r.L.service.ContractReviewService - 已成功将合同内容添加到AI知识库，审查ID: 26, 块数: 403
2025-10-11 09:49:41.915 [Async-2] INFO  c.r.L.service.ContractReviewService - 合同文件处理完成，审查ID: 26
2025-10-11 09:49:41.916 [Async-2] INFO  c.r.L.service.ContractReviewService - 异步处理合同文件方法结束，审查ID: 26
2025-10-11 09:49:42.349 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=26
2025-10-11 09:49:42.350 [Async-3] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 3686
2025-10-11 09:49:42.351 [Async-3] INFO  c.r.L.service.ContractReviewService - 文件解析完成，等待时间: 7秒, reviewId=26
2025-10-11 09:49:42.352 [Async-3] INFO  c.r.L.service.ContractReviewService - 步骤1完成：文档解析成功, reviewId=26
2025-10-11 09:49:42.366 [Async-3] INFO  c.r.LegalAssistant.service.AiService - 进行结构化合同风险分析，内容长度: 3686
2025-10-11 09:51:03.006 [Async-3] INFO  c.r.LegalAssistant.service.AiService - 结构化风险分析完成，识别出 10 个风险维度
2025-10-11 09:51:03.009 [Async-3] INFO  c.r.L.service.ContractReviewService - 步骤2完成：风险识别成功, reviewId=26
2025-10-11 09:51:03.010 [Async-3] INFO  c.r.L.service.AgentService - 开始分析合同关键条款，内容长度: 3686
2025-10-11 09:52:58.678 [Async-3] INFO  c.r.L.service.AgentService - JSON格式验证成功，包含 7 个关键条款
2025-10-11 09:52:58.678 [Async-3] INFO  c.r.L.service.AgentService - 关键条款分析完成，原始响应长度: 2288, 清理后长度: 2288
2025-10-11 09:52:58.678 [Async-3] INFO  c.r.L.service.ContractReviewService - 关键条款分析成功，识别出 7 个关键条款
2025-10-11 09:52:58.679 [Async-3] INFO  c.r.L.service.ContractReviewService - 步骤3完成：条款分析成功, reviewId=26
2025-10-11 09:52:58.705 [Async-3] INFO  c.r.L.service.ContractReviewService - 步骤4完成：分析结果保存成功, reviewId=26
2025-10-11 09:52:58.716 [Async-3] INFO  c.r.L.s.ReportGenerationService - 开始生成PDF报告，审查ID: 26
2025-10-11 09:52:58.716 [Async-3] INFO  c.r.L.s.ReportGenerationService - 初始化PDF中文字体支持...
2025-10-11 09:52:58.795 [Async-3] INFO  c.r.L.s.ReportGenerationService - ✓ 成功加载系统字体: C:/Windows/Fonts/STSONG.TTF (华文宋体优先，PDF兼容性最佳)
2025-10-11 09:52:58.827 [Async-3] INFO  c.r.L.s.ReportGenerationService - ✓ PDF文档字体设置成功
2025-10-11 09:52:58.828 [Async-3] INFO  c.r.L.s.ReportGenerationService - 准备生成增强内容...
2025-10-11 09:52:58.828 [Async-3] INFO  c.r.L.s.ReportGenerationService - 使用DeepSeek生成增强报告内容（带降级处理），审查ID: 26
2025-10-11 09:52:58.828 [Async-3] INFO  c.r.L.s.ReportGenerationService - 使用结构化方式生成增强报告内容，审查ID: 26
2025-10-11 09:53:03.787 [Async-3] INFO  c.r.L.s.ReportGenerationService - 开始使用结构化内容生成器生成报告，合同内容长度: 3686
2025-10-11 09:53:03.788 [ForkJoinPool.commonPool-worker-4] INFO  c.r.L.s.StructuredContentGenerator - 生成执行摘要结构化内容，审查ID: 26
2025-10-11 09:53:03.789 [ForkJoinPool.commonPool-worker-5] INFO  c.r.L.s.StructuredContentGenerator - 生成深度分析结构化内容，审查ID: 26
2025-10-11 09:53:03.789 [ForkJoinPool.commonPool-worker-6] INFO  c.r.L.s.StructuredContentGenerator - 生成改进建议结构化内容，审查ID: 26
2025-10-11 09:53:50.079 [Async-3] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成成功
2025-10-11 09:53:50.080 [Async-3] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成完成，耗时: 51252ms
2025-10-11 09:53:50.080 [Async-3] INFO  c.r.L.util.ReportContentValidator - 【报告完整性验证通过】所有必要内容齐全
2025-10-11 09:53:50.082 [Async-3] INFO  c.r.L.s.ReportGenerationService - ✓ 增强内容生成成功
2025-10-11 09:53:50.082 [Async-3] INFO  c.r.L.s.ReportGenerationService - 开始添加报告各部分内容...
2025-10-11 09:53:50.198 [Async-3] INFO  c.r.L.s.ReportGenerationService - 所有PDF内容添加完成
2025-10-11 09:53:50.243 [Async-3] INFO  c.r.L.s.ReportGenerationService - PDF报告生成成功，审查ID: 26, 文件大小: 335128 bytes
2025-10-11 09:53:50.245 [Async-3] INFO  c.r.L.service.ContractReviewService - PDF报告已保存到文件系统: F:\LegalAssistant\uploads\reports\26_report.pdf
2025-10-11 09:53:50.258 [Async-3] INFO  c.r.L.service.ContractReviewService - 步骤5完成：PDF报告生成并保存成功, reviewId=26, 文件大小: 335128 bytes
2025-10-11 09:53:50.269 [Async-3] INFO  c.r.L.service.ContractReviewService - 合同异步分析流程全部完成, reviewId=26
2025-10-11 09:53:50.272 [http-nio-8080-exec-10] INFO  c.r.L.service.ContractReviewService - SSE连接完成: reviewId=26
2025-10-11 09:54:48.561 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 26
2025-10-11 09:54:48.566 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 26, 文件大小: 335128 bytes
2025-10-11 09:54:48.566 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 农村土地经营权出租合同分析报告.pdf
2025-10-11 09:54:48.566 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 26, 文件大小: 335128 bytes, 文件名: 农村土地经营权出租合同分析报告.pdf
2025-10-11 09:54:48.569 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=32996f62, method=GET, uri=/api/v1/contracts/26/report, status=200, duration=9ms
2025-10-11 09:58:16.692 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=c913269d, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=7ms
2025-10-11 09:58:17.583 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 26
2025-10-11 09:58:17.588 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 26, 文件大小: 335128 bytes
2025-10-11 09:58:17.589 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 农村土地经营权出租合同分析报告.pdf
2025-10-11 09:58:17.589 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 26, 文件大小: 335128 bytes, 文件名: 农村土地经营权出租合同分析报告.pdf
2025-10-11 09:58:17.591 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=a84db928, method=GET, uri=/api/v1/contracts/26/report, status=200, duration=9ms
2025-10-11 09:59:46.729 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=99247176, method=GET, uri=/api/v1/users, status=200, duration=11ms
2025-10-11 09:59:47.661 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 09:59:47.694 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b9c4e96b, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=57ms
2025-10-11 10:03:55.544 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 10:03:55.549 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 10:07:52.793 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 6380 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 10:07:52.794 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 10:07:55.343 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 10:07:55.607 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@48d24d63
2025-10-11 10:07:55.660 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 10:07:55.679 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 10:07:55.685 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 10:07:55.762 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 10:07:55.764 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 10:07:56.199 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 10:07:57.744 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 10:07:57.807 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 10:07:57.809 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 7 个模板
2025-10-11 10:07:57.831 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 10:07:57.831 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 10:07:57.831 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 10:07:57.831 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 10:07:57.831 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 10:07:57.832 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 10:07:57.832 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 10:07:57.862 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 10:07:57.991 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 10:07:57.992 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 10:07:58.449 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 10:07:58.477 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 10:07:58.479 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 10:07:58.483 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 10:07:58.484 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 10:07:58.485 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 10:07:58.514 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 10:07:58.685 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 10:07:58.688 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 10:07:58.688 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 10:07:58.689 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 10:07:58.877 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 10:07:58.885 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 10:07:58.887 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 10:07:58.887 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 10:07:58.887 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 10:07:58.895 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 10:07:58.895 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 10:07:58.924 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 10:07:58.924 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 10:07:58.924 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 10:07:58.924 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 10:07:58.925 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 10:07:58.925 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 10:07:58.925 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 10:07:58.936 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 10:07:58.944 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 10:07:58.956 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 10:07:58.956 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 10:07:58.965 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 10:07:58.965 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 10:07:58.968 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 10:07:58.969 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 10:07:58.970 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 10:07:58.970 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 10:07:59.019 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 10:07:59.465 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 10:07:59.626 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 10:07:59.628 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 10:07:59.655 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 10:07:59.657 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 10:07:59.787 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 10:08:00.005 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 10:08:00.307 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 10:08:00.472 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 10:08:01.393 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.045 seconds (process running for 9.368)
2025-10-11 10:08:01.399 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 10:08:01.400 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 10:08:01.500 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 10:08:04.779 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f03b6aac, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=78ms
2025-10-11 10:08:09.287 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 26
2025-10-11 10:08:09.336 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 26, 文件大小: 335128 bytes
2025-10-11 10:08:09.336 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 农村土地经营权出租合同分析报告.pdf
2025-10-11 10:08:09.336 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 26, 文件大小: 335128 bytes, 文件名: 农村土地经营权出租合同分析报告.pdf
2025-10-11 10:08:09.340 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b2b6c464, method=GET, uri=/api/v1/contracts/26/report, status=200, duration=56ms
2025-10-11 10:10:32.698 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 10:10:32.702 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 10:30:47.803 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 20900 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 10:30:47.804 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 10:30:50.577 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 10:30:50.732 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@6dadcf58
2025-10-11 10:30:50.791 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 10:30:50.811 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 10:30:50.817 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 10:30:50.897 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 10:30:50.898 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 10:30:51.371 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 10:30:52.961 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 10:30:53.021 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 10:30:53.025 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 10:30:53.045 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 10:30:53.046 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 10:30:53.046 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 10:30:53.046 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 10:30:53.046 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 10:30:53.046 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 10:30:53.046 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 10:30:53.077 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 10:30:53.217 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 10:30:53.217 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 10:30:53.672 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 10:30:53.705 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 10:30:53.706 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 10:30:53.711 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 10:30:53.712 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 10:30:53.712 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 10:30:53.750 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 10:30:53.921 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 10:30:53.923 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 10:30:53.923 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 10:30:53.924 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 10:30:54.111 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 10:30:54.119 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 10:30:54.121 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 10:30:54.121 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 10:30:54.121 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 10:30:54.127 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 10:30:54.127 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 10:30:54.152 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 10:30:54.153 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 10:30:54.153 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 10:30:54.153 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 10:30:54.153 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 10:30:54.153 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 10:30:54.154 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 10:30:54.176 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 10:30:54.183 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 10:30:54.196 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 10:30:54.196 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 10:30:54.208 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 10:30:54.208 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 10:30:54.210 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 10:30:54.210 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 10:30:54.212 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 10:30:54.212 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 10:30:54.288 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 10:30:54.766 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 10:30:54.913 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 10:30:54.915 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 10:30:54.943 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 10:30:54.944 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 10:30:55.072 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 10:30:55.289 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 10:30:55.614 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 10:30:55.768 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 10:30:56.705 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.305 seconds (process running for 9.613)
2025-10-11 10:30:56.710 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 10:30:56.712 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 10:30:56.809 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 10:31:03.111 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 10:31:03.141 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=db52455b, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=117ms
2025-10-11 10:31:07.450 [http-nio-8080-exec-6] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 24
2025-10-11 10:31:07.451 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 24
2025-10-11 10:31:07.480 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 获取到 103 个向量块
2025-10-11 10:31:07.505 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=90dc4b3f, method=GET, uri=/api/v1/knowledge-base/documents/24/chunks, status=200, duration=73ms
2025-10-11 10:31:16.422 [http-nio-8080-exec-3] INFO  c.r.L.c.KnowledgeBaseController - 管理员删除单个文档: 24
2025-10-11 10:31:16.423 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 开始删除文档: 24
2025-10-11 10:31:16.428 [http-nio-8080-exec-3] WARN  c.r.L.service.KnowledgeBaseService - 删除文档块功能需要根据具体的VectorStore实现来完成: F:\LegalAssistant\uploads\law\民事诉讼法.pdf
2025-10-11 10:31:16.499 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 文档删除成功: 民事诉讼法.pdf (ID: 24)
2025-10-11 10:31:16.507 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ef1d571c, method=DELETE, uri=/api/v1/knowledge-base/documents/24, status=200, duration=89ms
2025-10-11 10:31:16.549 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=8
2025-10-11 10:31:16.554 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0a2fbe53, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=21ms
2025-10-11 10:31:35.526 [http-nio-8080-exec-5] INFO  c.r.L.service.FileStorageService - 文件已存在，跳过保存: F:\LegalAssistant\uploads\contracts\0b0e8e2a4601b55fa602df155d13f17a9bbcc9dc8b7199b0646500369166ec4b_《危险化学品生产经营企业自建网站销售合同（示范文本）》.docx
2025-10-11 10:31:35.528 [http-nio-8080-exec-5] INFO  c.r.L.service.ContractReviewService - 创建待处理审查记录，用户: admin, 文件: 《危险化学品生产经营企业自建网站销售合同（示范文本）》.docx
2025-10-11 10:31:35.560 [http-nio-8080-exec-5] INFO  c.r.L.service.ContractReviewService - 待处理审查记录已创建 - ID: 27, 文件: 《危险化学品生产经营企业自建网站销售合同（示范文本）》.docx
2025-10-11 10:31:35.569 [Async-1] INFO  c.r.L.service.ContractReviewService - 开始异步处理合同文件，审查ID: 27
2025-10-11 10:31:35.569 [Async-1] INFO  c.r.L.service.ContractReviewService - 异步处理线程: Async-1
2025-10-11 10:31:35.572 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=8910698c, method=POST, uri=/api/v1/contracts/upload, status=202, duration=81ms
2025-10-11 10:31:35.581 [Async-1] INFO  c.r.L.service.ContractReviewService - 开始解析文件: 《危险化学品生产经营企业自建网站销售合同（示范文本）》.docx, 路径: F:\LegalAssistant\uploads\contracts\0b0e8e2a4601b55fa602df155d13f17a9bbcc9dc8b7199b0646500369166ec4b_《危险化学品生产经营企业自建网站销售合同（示范文本）》.docx
2025-10-11 10:31:35.582 [Async-1] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 《危险化学品生产经营企业自建网站销售合同（示范文本）》.docx, 类型: docx, 大小: 38784 bytes
2025-10-11 10:31:35.591 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - 开始异步合同分析，审查ID: 27
2025-10-11 10:31:35.594 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - 用户 admin 通过JWT验证，开始处理合同分析，reviewId: 27
2025-10-11 10:31:35.594 [http-nio-8080-exec-2] INFO  c.r.L.c.ContractReviewController - SSE连接已建立: reviewId=27
2025-10-11 10:31:35.597 [Async-2] INFO  c.r.L.service.ContractReviewService - 开始异步分析合同（四步流程版），审查ID: 27
2025-10-11 10:31:35.598 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:35.600 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:35.605 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ff9741da, method=GET, uri=/api/v1/contracts/27/analyze-async, status=200, duration=17ms
2025-10-11 10:31:36.241 [Async-1] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 《危险化学品生产经营企业自建网站销售合同（示范文本）》.docx, 内容长度: 7321 字符
2025-10-11 10:31:36.242 [Async-1] INFO  c.r.L.service.ContractReviewService - 文件解析成功: 《危险化学品生产经营企业自建网站销售合同（示范文本）》.docx, 内容长度: 7321
2025-10-11 10:31:36.243 [Async-1] INFO  c.r.L.service.ContractReviewService - 文档解析完成，文本内容已保存: reviewId=27, 文本长度: 7321
2025-10-11 10:31:36.243 [Async-1] INFO  c.r.L.service.EtlService - 开始处理文本内容，长度: 7321 字符
2025-10-11 10:31:36.247 [Async-1] INFO  c.r.L.service.EtlService - 文本分块完成，生成 405 个文本块
2025-10-11 10:31:36.630 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:36.632 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:37.640 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:37.642 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:38.657 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:38.659 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:39.673 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:39.675 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:40.685 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:40.686 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:41.696 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:41.698 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:42.708 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:42.709 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:43.719 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:43.721 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:44.725 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:44.726 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:31:44.805 [Async-1] INFO  c.r.L.service.EtlService - 文本内容处理完成，405 个向量块已存储
2025-10-11 10:31:44.805 [Async-1] INFO  c.r.L.service.ContractReviewService - 已成功将合同内容添加到AI知识库，审查ID: 27, 块数: 405
2025-10-11 10:31:44.805 [Async-1] INFO  c.r.L.service.ContractReviewService - 合同文件处理完成，审查ID: 27
2025-10-11 10:31:44.806 [Async-1] INFO  c.r.L.service.ContractReviewService - 异步处理合同文件方法结束，审查ID: 27
2025-10-11 10:31:45.729 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=27
2025-10-11 10:31:45.731 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 7321
2025-10-11 10:31:45.731 [Async-2] INFO  c.r.L.service.ContractReviewService - 文件解析完成，等待时间: 10秒, reviewId=27
2025-10-11 10:31:45.733 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤1完成：文档解析成功, reviewId=27
2025-10-11 10:31:45.746 [Async-2] INFO  c.r.LegalAssistant.service.AiService - 进行结构化合同风险分析，内容长度: 7321
2025-10-11 10:33:12.163 [Async-2] INFO  c.r.LegalAssistant.service.AiService - 结构化风险分析完成，识别出 10 个风险维度
2025-10-11 10:33:12.167 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤2完成：风险识别成功, reviewId=27
2025-10-11 10:33:12.168 [Async-2] INFO  c.r.L.service.AgentService - 开始分析合同关键条款，内容长度: 7321
2025-10-11 10:33:12.169 [Async-2] WARN  c.r.L.service.PromptTemplateService - 模板变量未提供: {
  "keyClauses": [{{
    "title": "条款标题",
    "content": "条款摘录(50-100字)",
    "analysis": "分析评价",
    "importance": "HIGH/MEDIUM/LOW",
    "isComplete": true,
    "suggestion": "改进建议"
  
2025-10-11 10:34:25.478 [Async-2] INFO  c.r.L.service.AgentService - JSON格式验证成功，包含 8 个关键条款
2025-10-11 10:34:25.479 [Async-2] INFO  c.r.L.service.AgentService - 关键条款分析完成，原始响应长度: 2522, 清理后长度: 2480
2025-10-11 10:34:25.479 [Async-2] INFO  c.r.L.service.ContractReviewService - 关键条款分析成功，识别出 8 个关键条款
2025-10-11 10:34:25.479 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤3完成：条款分析成功, reviewId=27
2025-10-11 10:34:25.513 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤4完成：分析结果保存成功, reviewId=27
2025-10-11 10:34:25.529 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始生成PDF报告，审查ID: 27
2025-10-11 10:34:25.529 [Async-2] INFO  c.r.L.s.ReportGenerationService - 初始化PDF中文字体支持...
2025-10-11 10:34:25.609 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ 成功加载系统字体: C:/Windows/Fonts/STSONG.TTF (华文宋体优先，PDF兼容性最佳)
2025-10-11 10:34:25.646 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ PDF文档字体设置成功
2025-10-11 10:34:25.646 [Async-2] INFO  c.r.L.s.ReportGenerationService - 准备生成增强内容...
2025-10-11 10:34:25.646 [Async-2] INFO  c.r.L.s.ReportGenerationService - 使用DeepSeek生成增强报告内容（带降级处理），审查ID: 27
2025-10-11 10:34:25.647 [Async-2] INFO  c.r.L.s.ReportGenerationService - 使用结构化方式生成增强报告内容，审查ID: 27
2025-10-11 10:34:29.380 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始使用结构化内容生成器生成报告，合同内容长度: 7321
2025-10-11 10:34:29.381 [ForkJoinPool.commonPool-worker-2] INFO  c.r.L.s.StructuredContentGenerator - 生成执行摘要结构化内容，审查ID: 27
2025-10-11 10:34:29.382 [ForkJoinPool.commonPool-worker-3] INFO  c.r.L.s.StructuredContentGenerator - 生成深度分析结构化内容，审查ID: 27
2025-10-11 10:34:29.382 [ForkJoinPool.commonPool-worker-4] INFO  c.r.L.s.StructuredContentGenerator - 生成改进建议结构化内容，审查ID: 27
2025-10-11 10:34:29.382 [ForkJoinPool.commonPool-worker-2] WARN  c.r.L.service.PromptTemplateService - 模板变量未提供: {
  "contractType": "合同类型",
  "riskLevel": "高/中/低",
  "riskReason": "判定理由(50-100字)",
  "coreRisks": ["核心风险1", "核心风险2", "核心风险3"],
  "actionSuggestions": ["具体建议1", "具体建议2"]

2025-10-11 10:34:29.382 [ForkJoinPool.commonPool-worker-4] WARN  c.r.L.service.PromptTemplateService - 模板变量未提供: {
  "suggestions": [{{
    "priority": "高/中/低",
    "problemDescription": "问题描述",
    "suggestedModification": "修改建议(可操作)",
    "expectedEffect": "预期效果"
  
2025-10-11 10:34:29.382 [ForkJoinPool.commonPool-worker-3] WARN  c.r.L.service.PromptTemplateService - 模板变量未提供: {
  "legalNature": {{
    "contractType": "合同类型",
    "governingLaws": "适用法规",
    "legalRelationship": "法律关系"
  
2025-10-11 10:34:29.382 [ForkJoinPool.commonPool-worker-3] WARN  c.r.L.service.PromptTemplateService - 模板变量未提供: {
    "clauseName": "条款名称",
    "interpretation": "专业解读(100-200字)",
    "risk": "风险说明"
  
2025-10-11 10:34:29.383 [ForkJoinPool.commonPool-worker-3] WARN  c.r.L.service.PromptTemplateService - 模板变量未提供: {
    "riskCategory": "风险类别",
    "level": "高/中/低",
    "description": "风险描述",
    "prevention": "防范措施"
  
2025-10-11 10:34:29.383 [ForkJoinPool.commonPool-worker-3] WARN  c.r.L.service.PromptTemplateService - 模板变量未提供: {
    "regulation": "适用法规",
    "conformity": "符合性评估",
    "gaps": "合规差距"
  
2025-10-11 10:34:29.383 [ForkJoinPool.commonPool-worker-3] WARN  c.r.L.service.PromptTemplateService - 模板变量未提供: {
    "party": "受影响方",
    "impact": "影响描述",
    "financialImpact": "财务影响"
  
2025-10-11 10:35:14.544 [Async-2] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成成功
2025-10-11 10:35:14.545 [Async-2] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成完成，耗时: 48898ms
2025-10-11 10:35:14.546 [Async-2] INFO  c.r.L.util.ReportContentValidator - 【报告完整性验证通过】所有必要内容齐全
2025-10-11 10:35:14.548 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ 增强内容生成成功
2025-10-11 10:35:14.548 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始添加报告各部分内容...
2025-10-11 10:35:14.664 [Async-2] INFO  c.r.L.s.ReportGenerationService - 所有PDF内容添加完成
2025-10-11 10:35:14.709 [Async-2] INFO  c.r.L.s.ReportGenerationService - PDF报告生成成功，审查ID: 27, 文件大小: 335384 bytes
2025-10-11 10:35:14.711 [Async-2] INFO  c.r.L.service.ContractReviewService - PDF报告已保存到文件系统: F:\LegalAssistant\uploads\reports\27_report.pdf
2025-10-11 10:35:14.725 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤5完成：PDF报告生成并保存成功, reviewId=27, 文件大小: 335384 bytes
2025-10-11 10:35:14.737 [Async-2] INFO  c.r.L.service.ContractReviewService - 合同异步分析流程全部完成, reviewId=27
2025-10-11 10:35:14.747 [http-nio-8080-exec-7] INFO  c.r.L.service.ContractReviewService - SSE连接完成: reviewId=27
2025-10-11 10:36:03.533 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 27
2025-10-11 10:36:03.542 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 27, 文件大小: 335384 bytes
2025-10-11 10:36:03.543 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 《危险化学品生产经营企业自建网站销售合同（示范文本）》分析报告.pdf
2025-10-11 10:36:03.543 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 27, 文件大小: 335384 bytes, 文件名: 《危险化学品生产经营企业自建网站销售合同（示范文本）》分析报告.pdf
2025-10-11 10:36:03.545 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5017875b, method=GET, uri=/api/v1/contracts/27/report, status=200, duration=14ms
2025-10-11 10:36:28.295 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b58b7322, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=18ms
2025-10-11 10:36:31.356 [http-nio-8080-exec-1] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 27
2025-10-11 10:36:31.363 [http-nio-8080-exec-1] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 27, 文件大小: 335384 bytes
2025-10-11 10:36:31.364 [http-nio-8080-exec-1] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 《危险化学品生产经营企业自建网站销售合同（示范文本）》分析报告.pdf
2025-10-11 10:36:31.364 [http-nio-8080-exec-1] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 27, 文件大小: 335384 bytes, 文件名: 《危险化学品生产经营企业自建网站销售合同（示范文本）》分析报告.pdf
2025-10-11 10:36:31.367 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=42d392b1, method=GET, uri=/api/v1/contracts/27/report, status=200, duration=12ms
2025-10-11 10:36:36.869 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f8b54d59, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=10ms
2025-10-11 10:36:44.463 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 10:36:44.483 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=90b9d49b, method=GET, uri=/api/v1/chat/sessions, status=200, duration=21ms
2025-10-11 10:40:18.147 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 10:40:18.153 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 10:47:38.543 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 39544 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 10:47:38.544 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 10:47:40.939 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 10:47:41.097 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@789f5552
2025-10-11 10:47:41.144 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 10:47:41.170 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 10:47:41.176 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 10:47:41.265 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 10:47:41.267 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 10:47:41.732 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 10:47:43.175 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 10:47:43.224 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 10:47:43.227 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 10:47:43.246 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 10:47:43.247 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 10:47:43.247 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 10:47:43.247 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 10:47:43.247 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 10:47:43.248 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 10:47:43.248 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 10:47:43.275 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 10:47:43.372 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 10:47:43.372 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 10:47:43.784 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 10:47:43.817 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 10:47:43.819 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 10:47:43.821 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 10:47:43.822 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 10:47:43.823 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 10:47:43.851 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 10:47:44.078 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 10:47:44.080 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 10:47:44.081 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 10:47:44.081 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 10:47:44.270 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 10:47:44.278 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 10:47:44.279 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 10:47:44.280 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 10:47:44.280 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 10:47:44.286 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 10:47:44.286 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 10:47:44.309 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 10:47:44.309 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 10:47:44.309 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 10:47:44.309 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 10:47:44.309 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 10:47:44.309 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 10:47:44.309 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 10:47:44.320 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 10:47:44.328 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 10:47:44.340 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 10:47:44.340 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 10:47:44.349 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 10:47:44.349 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 10:47:44.352 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 10:47:44.352 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 10:47:44.354 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 10:47:44.354 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 10:47:44.406 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 10:47:44.801 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 10:47:45.010 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 10:47:45.013 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 10:47:45.044 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 10:47:45.047 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 10:47:45.247 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 10:47:45.457 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 10:47:45.730 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 10:47:45.877 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 10:47:46.712 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.567 seconds (process running for 8.922)
2025-10-11 10:47:46.716 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 10:47:46.718 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 10:47:46.801 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 开始自动索引...
2025-10-11 10:47:46.802 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始批量索引目录: uploads/law, 递归: false
2025-10-11 10:47:46.802 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 发现 6 个文档待索引
2025-10-11 10:47:46.802 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\刑法.pdf
2025-10-11 10:47:46.804 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\刑法.pdf
2025-10-11 10:47:46.804 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\劳动法.pdf
2025-10-11 10:47:46.805 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\劳动法.pdf
2025-10-11 10:47:46.805 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\宪法.pdf
2025-10-11 10:47:46.806 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\宪法.pdf
2025-10-11 10:47:46.806 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\民事诉讼法.pdf
2025-10-11 10:47:50.223 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档索引完成: F:\LegalAssistant\uploads\law\民事诉讼法.pdf, 片段数: 20, 耗时: 3417ms
2025-10-11 10:47:50.223 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 10:47:50.225 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 10:47:50.225 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\环境保护法.pdf
2025-10-11 10:47:50.226 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\环境保护法.pdf
2025-10-11 10:47:50.227 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 批量索引完成: 总计 6 个文档, 成功 6 个, 生成 20 个片段, 耗时 3425ms
2025-10-11 10:47:50.227 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 自动索引完成 - 总文档: 6, 成功: 6, 总片段: 20, 耗时: 3425ms
2025-10-11 10:47:50.227 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 法律文档索引完成，AI聊天功能现在可以使用这些文档进行问答
2025-10-11 10:48:41.931 [http-nio-8080-exec-2] INFO  c.r.L.service.FileStorageService - 文件保存成功: F:\LegalAssistant\uploads\contracts\f88b824f787ed59f141462eae75e7f642376f5138bc46bc147a5255388774726_杭州市消防检测技术服务合同.pdf, 大小: 189350 bytes
2025-10-11 10:48:41.932 [http-nio-8080-exec-2] INFO  c.r.L.service.ContractReviewService - 创建待处理审查记录，用户: admin, 文件: 杭州市消防检测技术服务合同.pdf
2025-10-11 10:48:41.951 [http-nio-8080-exec-2] INFO  c.r.L.service.ContractReviewService - 待处理审查记录已创建 - ID: 28, 文件: 杭州市消防检测技术服务合同.pdf
2025-10-11 10:48:41.971 [Async-1] INFO  c.r.L.service.ContractReviewService - 开始异步处理合同文件，审查ID: 28
2025-10-11 10:48:41.971 [Async-1] INFO  c.r.L.service.ContractReviewService - 异步处理线程: Async-1
2025-10-11 10:48:41.993 [Async-1] INFO  c.r.L.service.ContractReviewService - 开始解析文件: 杭州市消防检测技术服务合同.pdf, 路径: F:\LegalAssistant\uploads\contracts\f88b824f787ed59f141462eae75e7f642376f5138bc46bc147a5255388774726_杭州市消防检测技术服务合同.pdf
2025-10-11 10:48:41.994 [Async-1] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 杭州市消防检测技术服务合同.pdf, 类型: pdf, 大小: 189350 bytes
2025-10-11 10:48:41.994 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=53bbf776, method=POST, uri=/api/v1/contracts/upload, status=202, duration=135ms
2025-10-11 10:48:42.018 [http-nio-8080-exec-10] INFO  c.r.L.c.ContractReviewController - 开始异步合同分析，审查ID: 28
2025-10-11 10:48:42.021 [http-nio-8080-exec-10] INFO  c.r.L.c.ContractReviewController - 用户 admin 通过JWT验证，开始处理合同分析，reviewId: 28
2025-10-11 10:48:42.022 [http-nio-8080-exec-10] INFO  c.r.L.c.ContractReviewController - SSE连接已建立: reviewId=28
2025-10-11 10:48:42.024 [Async-2] INFO  c.r.L.service.ContractReviewService - 开始异步分析合同（四步流程版），审查ID: 28
2025-10-11 10:48:42.025 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:42.027 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:48:42.030 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=83088e1b, method=GET, uri=/api/v1/contracts/28/analyze-async, status=200, duration=16ms
2025-10-11 10:48:42.053 [Async-1] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 杭州市消防检测技术服务合同.pdf, 内容长度: 5495 字符
2025-10-11 10:48:42.053 [Async-1] INFO  c.r.L.service.ContractReviewService - 文件解析成功: 杭州市消防检测技术服务合同.pdf, 内容长度: 5495
2025-10-11 10:48:42.054 [Async-1] INFO  c.r.L.service.ContractReviewService - 文档解析完成，文本内容已保存: reviewId=28, 文本长度: 5495
2025-10-11 10:48:42.054 [Async-1] INFO  c.r.L.service.EtlService - 开始处理文本内容，长度: 5495 字符
2025-10-11 10:48:42.059 [Async-1] INFO  c.r.L.service.EtlService - 文本分块完成，生成 404 个文本块
2025-10-11 10:48:43.041 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:43.043 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:48:44.054 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:44.056 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:48:45.072 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:45.074 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:48:46.082 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:46.084 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:48:47.092 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:47.094 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:48:48.108 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:48.109 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:48:49.119 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:49.121 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 10:48:49.743 [Async-1] INFO  c.r.L.service.EtlService - 文本内容处理完成，404 个向量块已存储
2025-10-11 10:48:49.743 [Async-1] INFO  c.r.L.service.ContractReviewService - 已成功将合同内容添加到AI知识库，审查ID: 28, 块数: 404
2025-10-11 10:48:49.744 [Async-1] INFO  c.r.L.service.ContractReviewService - 合同文件处理完成，审查ID: 28
2025-10-11 10:48:49.744 [Async-1] INFO  c.r.L.service.ContractReviewService - 异步处理合同文件方法结束，审查ID: 28
2025-10-11 10:48:50.129 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=28
2025-10-11 10:48:50.130 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 5495
2025-10-11 10:48:50.131 [Async-2] INFO  c.r.L.service.ContractReviewService - 文件解析完成，等待时间: 8秒, reviewId=28
2025-10-11 10:48:50.133 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤1完成：文档解析成功, reviewId=28
2025-10-11 10:48:50.141 [Async-2] INFO  c.r.LegalAssistant.service.AiService - 进行结构化合同风险分析，内容长度: 5495
2025-10-11 10:50:20.232 [Async-2] INFO  c.r.LegalAssistant.service.AiService - 结构化风险分析完成，识别出 10 个风险维度
2025-10-11 10:50:20.234 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤2完成：风险识别成功, reviewId=28
2025-10-11 10:50:20.236 [Async-2] INFO  c.r.L.service.AgentService - 开始分析合同关键条款，内容长度: 5495
2025-10-11 10:50:22.926 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 分类筛选: 前端值=law, 数据库值=LAW
2025-10-11 10:50:22.939 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=law, 总数=9
2025-10-11 10:50:22.942 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=35bf5a35, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=19ms
2025-10-11 10:50:24.172 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 分类筛选: 前端值=contract, 数据库值=CONTRACT_TEMPLATE
2025-10-11 10:50:24.175 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=contract, 总数=0
2025-10-11 10:50:24.176 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3323e373, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=5ms
2025-10-11 10:50:25.484 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 10:50:25.485 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5fb8c3ee, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=12ms
2025-10-11 10:52:10.572 [Async-2] INFO  c.r.L.service.AgentService - JSON格式验证成功，包含 7 个关键条款
2025-10-11 10:52:10.572 [Async-2] INFO  c.r.L.service.AgentService - 关键条款分析完成，原始响应长度: 2217, 清理后长度: 2217
2025-10-11 10:52:10.573 [Async-2] INFO  c.r.L.service.ContractReviewService - 关键条款分析成功，识别出 7 个关键条款
2025-10-11 10:52:10.573 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤3完成：条款分析成功, reviewId=28
2025-10-11 10:52:10.595 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤4完成：分析结果保存成功, reviewId=28
2025-10-11 10:52:10.611 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始生成PDF报告，审查ID: 28
2025-10-11 10:52:10.612 [Async-2] INFO  c.r.L.s.ReportGenerationService - 初始化PDF中文字体支持...
2025-10-11 10:52:10.658 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ 成功加载系统字体: C:/Windows/Fonts/STSONG.TTF (华文宋体优先，PDF兼容性最佳)
2025-10-11 10:52:10.686 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ PDF文档字体设置成功
2025-10-11 10:52:10.686 [Async-2] INFO  c.r.L.s.ReportGenerationService - 准备生成增强内容...
2025-10-11 10:52:10.687 [Async-2] INFO  c.r.L.s.ReportGenerationService - 使用DeepSeek生成增强报告内容（带降级处理），审查ID: 28
2025-10-11 10:52:10.687 [Async-2] INFO  c.r.L.s.ReportGenerationService - 使用结构化方式生成增强报告内容，审查ID: 28
2025-10-11 10:52:14.867 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始使用结构化内容生成器生成报告，合同内容长度: 5495
2025-10-11 10:52:14.869 [ForkJoinPool.commonPool-worker-3] INFO  c.r.L.s.StructuredContentGenerator - 生成执行摘要结构化内容，审查ID: 28
2025-10-11 10:52:14.870 [ForkJoinPool.commonPool-worker-4] INFO  c.r.L.s.StructuredContentGenerator - 生成深度分析结构化内容，审查ID: 28
2025-10-11 10:52:14.870 [ForkJoinPool.commonPool-worker-5] INFO  c.r.L.s.StructuredContentGenerator - 生成改进建议结构化内容，审查ID: 28
2025-10-11 10:52:57.242 [Async-2] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成成功
2025-10-11 10:52:57.242 [Async-2] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成完成，耗时: 46555ms
2025-10-11 10:52:57.242 [Async-2] INFO  c.r.L.util.ReportContentValidator - 【报告完整性验证通过】所有必要内容齐全
2025-10-11 10:52:57.250 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ 增强内容生成成功
2025-10-11 10:52:57.250 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始添加报告各部分内容...
2025-10-11 10:52:57.353 [Async-2] INFO  c.r.L.s.ReportGenerationService - 所有PDF内容添加完成
2025-10-11 10:52:57.395 [Async-2] INFO  c.r.L.s.ReportGenerationService - PDF报告生成成功，审查ID: 28, 文件大小: 349323 bytes
2025-10-11 10:52:57.398 [Async-2] INFO  c.r.L.service.ContractReviewService - PDF报告已保存到文件系统: F:\LegalAssistant\uploads\reports\28_report.pdf
2025-10-11 10:52:57.419 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤5完成：PDF报告生成并保存成功, reviewId=28, 文件大小: 349323 bytes
2025-10-11 10:52:57.452 [Async-2] INFO  c.r.L.service.ContractReviewService - 合同异步分析流程全部完成, reviewId=28
2025-10-11 10:52:57.464 [http-nio-8080-exec-4] INFO  c.r.L.service.ContractReviewService - SSE连接完成: reviewId=28
2025-10-11 10:54:37.575 [http-nio-8080-exec-5] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 28
2025-10-11 10:54:37.586 [http-nio-8080-exec-5] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 28, 文件大小: 349323 bytes
2025-10-11 10:54:37.586 [http-nio-8080-exec-5] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 杭州市消防检测技术服务合同分析报告.pdf
2025-10-11 10:54:37.587 [http-nio-8080-exec-5] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 28, 文件大小: 349323 bytes, 文件名: 杭州市消防检测技术服务合同分析报告.pdf
2025-10-11 10:54:37.589 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=71917781, method=GET, uri=/api/v1/contracts/28/report, status=200, duration=16ms
2025-10-11 10:55:09.533 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 10:55:09.539 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 11:00:28.144 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 13248 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 11:00:28.145 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 11:00:30.521 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 11:00:30.645 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@6dadcf58
2025-10-11 11:00:30.688 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 11:00:30.709 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 11:00:30.715 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 11:00:30.795 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 11:00:30.796 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 11:00:31.154 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 11:00:32.545 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 11:00:32.601 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 11:00:32.605 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 11:00:32.628 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 11:00:32.628 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 11:00:32.628 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 11:00:32.629 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 11:00:32.629 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 11:00:32.629 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 11:00:32.629 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 11:00:32.660 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 11:00:32.754 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 11:00:32.754 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 11:00:33.201 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 11:00:33.231 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 11:00:33.233 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 11:00:33.238 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 11:00:33.239 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 11:00:33.240 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 11:00:33.273 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 11:00:33.460 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 11:00:33.463 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 11:00:33.463 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 11:00:33.463 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 11:00:33.653 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 11:00:33.662 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 11:00:33.663 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 11:00:33.664 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 11:00:33.664 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 11:00:33.671 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 11:00:33.671 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 11:00:33.699 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 11:00:33.699 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 11:00:33.699 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 11:00:33.699 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 11:00:33.699 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 11:00:33.700 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 11:00:33.700 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 11:00:33.712 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 11:00:33.722 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 11:00:33.734 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 11:00:33.735 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 11:00:33.746 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 11:00:33.746 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 11:00:33.748 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 11:00:33.749 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 11:00:33.750 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 11:00:33.750 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 11:00:33.801 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 11:00:34.169 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 11:00:34.289 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 11:00:34.292 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 11:00:34.311 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 11:00:34.312 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 11:00:34.446 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 11:00:34.641 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 11:00:34.941 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 11:00:35.104 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 11:00:35.958 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.23 seconds (process running for 8.588)
2025-10-11 11:00:35.965 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 11:00:35.966 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 11:00:36.057 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 11:00:43.738 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=834366c6, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=115ms
2025-10-11 11:00:45.616 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=1aabd6f7, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=15ms
2025-10-11 11:00:50.461 [http-nio-8080-exec-5] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 11:00:50.488 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=35bb635c, method=GET, uri=/api/v1/chat/sessions, status=200, duration=34ms
2025-10-11 11:00:52.052 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=2b052951, method=GET, uri=/api/v1/users, status=200, duration=19ms
2025-10-11 11:00:53.378 [http-nio-8080-exec-10] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 11:00:53.384 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0bb1903c, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=21ms
2025-10-11 11:01:31.735 [http-nio-8080-exec-4] INFO  c.r.L.service.FileStorageService - 文件保存成功: F:\LegalAssistant\uploads\contracts\7b1fcbfbd4db85a6911309de3c1c9cd9a44694719e08d19c4a8facbc22302bda_上海市机关食堂餐饮服务合同.pdf, 大小: 225696 bytes
2025-10-11 11:01:31.736 [http-nio-8080-exec-4] INFO  c.r.L.service.ContractReviewService - 创建待处理审查记录，用户: admin, 文件: 上海市机关食堂餐饮服务合同.pdf
2025-10-11 11:01:31.777 [http-nio-8080-exec-4] INFO  c.r.L.service.ContractReviewService - 待处理审查记录已创建 - ID: 29, 文件: 上海市机关食堂餐饮服务合同.pdf
2025-10-11 11:01:31.796 [Async-1] INFO  c.r.L.service.ContractReviewService - 开始异步处理合同文件，审查ID: 29
2025-10-11 11:01:31.796 [Async-1] INFO  c.r.L.service.ContractReviewService - 异步处理线程: Async-1
2025-10-11 11:01:31.799 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=d2c6bfcb, method=POST, uri=/api/v1/contracts/upload, status=202, duration=108ms
2025-10-11 11:01:31.808 [Async-1] INFO  c.r.L.service.ContractReviewService - 开始解析文件: 上海市机关食堂餐饮服务合同.pdf, 路径: F:\LegalAssistant\uploads\contracts\7b1fcbfbd4db85a6911309de3c1c9cd9a44694719e08d19c4a8facbc22302bda_上海市机关食堂餐饮服务合同.pdf
2025-10-11 11:01:31.809 [Async-1] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 上海市机关食堂餐饮服务合同.pdf, 类型: pdf, 大小: 225696 bytes
2025-10-11 11:01:31.820 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 开始异步合同分析，审查ID: 29
2025-10-11 11:01:31.823 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 用户 admin 通过JWT验证，开始处理合同分析，reviewId: 29
2025-10-11 11:01:31.823 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - SSE连接已建立: reviewId=29
2025-10-11 11:01:31.825 [Async-2] INFO  c.r.L.service.ContractReviewService - 开始异步分析合同（四步流程版），审查ID: 29
2025-10-11 11:01:31.827 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:31.829 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:01:31.840 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ad41e4a6, method=GET, uri=/api/v1/contracts/29/analyze-async, status=200, duration=23ms
2025-10-11 11:01:32.180 [Async-1] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 上海市机关食堂餐饮服务合同.pdf, 内容长度: 8870 字符
2025-10-11 11:01:32.180 [Async-1] INFO  c.r.L.service.ContractReviewService - 文件解析成功: 上海市机关食堂餐饮服务合同.pdf, 内容长度: 8870
2025-10-11 11:01:32.181 [Async-1] INFO  c.r.L.service.ContractReviewService - 文档解析完成，文本内容已保存: reviewId=29, 文本长度: 8870
2025-10-11 11:01:32.181 [Async-1] INFO  c.r.L.service.EtlService - 开始处理文本内容，长度: 8870 字符
2025-10-11 11:01:32.187 [Async-1] INFO  c.r.L.service.EtlService - 文本分块完成，生成 406 个文本块
2025-10-11 11:01:32.856 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:32.858 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:01:33.875 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:33.877 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:01:34.890 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:34.894 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:01:35.901 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:35.902 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:01:36.911 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:36.913 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:01:37.925 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:37.927 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:01:38.934 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:38.936 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:01:39.849 [Async-1] INFO  c.r.L.service.EtlService - 文本内容处理完成，406 个向量块已存储
2025-10-11 11:01:39.849 [Async-1] INFO  c.r.L.service.ContractReviewService - 已成功将合同内容添加到AI知识库，审查ID: 29, 块数: 406
2025-10-11 11:01:39.850 [Async-1] INFO  c.r.L.service.ContractReviewService - 合同文件处理完成，审查ID: 29
2025-10-11 11:01:39.850 [Async-1] INFO  c.r.L.service.ContractReviewService - 异步处理合同文件方法结束，审查ID: 29
2025-10-11 11:01:39.945 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=29
2025-10-11 11:01:39.946 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 8870
2025-10-11 11:01:39.947 [Async-2] INFO  c.r.L.service.ContractReviewService - 文件解析完成，等待时间: 8秒, reviewId=29
2025-10-11 11:01:39.948 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤1完成：文档解析成功, reviewId=29
2025-10-11 11:01:39.955 [Async-2] INFO  c.r.LegalAssistant.service.AiService - 进行结构化合同风险分析，内容长度: 8870
2025-10-11 11:02:58.272 [Async-2] INFO  c.r.LegalAssistant.service.AiService - 结构化风险分析完成，识别出 10 个风险维度
2025-10-11 11:02:58.275 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤2完成：风险识别成功, reviewId=29
2025-10-11 11:02:58.276 [Async-2] INFO  c.r.L.service.AgentService - 开始分析合同关键条款，内容长度: 8870
2025-10-11 11:04:50.913 [Async-2] INFO  c.r.L.service.AgentService - JSON格式验证成功，包含 7 个关键条款
2025-10-11 11:04:50.914 [Async-2] INFO  c.r.L.service.AgentService - 关键条款分析完成，原始响应长度: 2034, 清理后长度: 2034
2025-10-11 11:04:50.914 [Async-2] INFO  c.r.L.service.ContractReviewService - 关键条款分析成功，识别出 7 个关键条款
2025-10-11 11:04:50.914 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤3完成：条款分析成功, reviewId=29
2025-10-11 11:04:50.944 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤4完成：分析结果保存成功, reviewId=29
2025-10-11 11:04:50.961 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始生成PDF报告，审查ID: 29
2025-10-11 11:04:50.961 [Async-2] INFO  c.r.L.s.ReportGenerationService - 初始化PDF中文字体支持...
2025-10-11 11:04:51.010 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ 成功加载系统字体: C:/Windows/Fonts/STSONG.TTF (华文宋体优先，PDF兼容性最佳)
2025-10-11 11:04:51.037 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ PDF文档字体设置成功
2025-10-11 11:04:51.038 [Async-2] INFO  c.r.L.s.ReportGenerationService - 准备生成增强内容...
2025-10-11 11:04:51.038 [Async-2] INFO  c.r.L.s.ReportGenerationService - 使用DeepSeek生成增强报告内容（带降级处理），审查ID: 29
2025-10-11 11:04:51.038 [Async-2] INFO  c.r.L.s.ReportGenerationService - 使用结构化方式生成增强报告内容，审查ID: 29
2025-10-11 11:04:55.422 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始使用结构化内容生成器生成报告，合同内容长度: 8870
2025-10-11 11:04:55.423 [ForkJoinPool.commonPool-worker-2] INFO  c.r.L.s.StructuredContentGenerator - 生成执行摘要结构化内容，审查ID: 29
2025-10-11 11:04:55.423 [ForkJoinPool.commonPool-worker-3] INFO  c.r.L.s.StructuredContentGenerator - 生成深度分析结构化内容，审查ID: 29
2025-10-11 11:04:55.424 [ForkJoinPool.commonPool-worker-4] INFO  c.r.L.s.StructuredContentGenerator - 生成改进建议结构化内容，审查ID: 29
2025-10-11 11:05:34.658 [Async-2] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成成功
2025-10-11 11:05:34.659 [Async-2] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成完成，耗时: 43621ms
2025-10-11 11:05:34.660 [Async-2] INFO  c.r.L.util.ReportContentValidator - 【报告完整性验证通过】所有必要内容齐全
2025-10-11 11:05:34.664 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ 增强内容生成成功
2025-10-11 11:05:34.664 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始添加报告各部分内容...
2025-10-11 11:05:34.772 [Async-2] INFO  c.r.L.s.ReportGenerationService - 所有PDF内容添加完成
2025-10-11 11:05:34.814 [Async-2] INFO  c.r.L.s.ReportGenerationService - PDF报告生成成功，审查ID: 29, 文件大小: 341748 bytes
2025-10-11 11:05:34.817 [Async-2] INFO  c.r.L.service.ContractReviewService - PDF报告已保存到文件系统: F:\LegalAssistant\uploads\reports\29_report.pdf
2025-10-11 11:05:34.830 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤5完成：PDF报告生成并保存成功, reviewId=29, 文件大小: 341748 bytes
2025-10-11 11:05:34.842 [Async-2] INFO  c.r.L.service.ContractReviewService - 合同异步分析流程全部完成, reviewId=29
2025-10-11 11:05:34.850 [http-nio-8080-exec-6] INFO  c.r.L.service.ContractReviewService - SSE连接完成: reviewId=29
2025-10-11 11:05:45.395 [http-nio-8080-exec-9] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 29
2025-10-11 11:05:45.407 [http-nio-8080-exec-9] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 29, 文件大小: 341748 bytes
2025-10-11 11:05:45.407 [http-nio-8080-exec-9] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 上海市机关食堂餐饮服务合同分析报告.pdf
2025-10-11 11:05:45.407 [http-nio-8080-exec-9] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 29, 文件大小: 341748 bytes, 文件名: 上海市机关食堂餐饮服务合同分析报告.pdf
2025-10-11 11:05:45.410 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6a20b1a9, method=GET, uri=/api/v1/contracts/29/report, status=200, duration=16ms
2025-10-11 11:06:18.090 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 11:06:18.093 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 11:13:23.225 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 17944 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 11:13:23.227 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 11:13:25.906 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 11:13:26.112 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@7359f3ac
2025-10-11 11:13:26.184 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 11:13:26.205 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 11:13:26.211 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 11:13:26.307 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 11:13:26.310 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 11:13:26.739 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 11:13:28.274 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 11:13:28.333 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 11:13:28.338 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 11:13:28.362 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 11:13:28.363 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 11:13:28.363 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 11:13:28.363 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 11:13:28.363 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 11:13:28.363 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 11:13:28.363 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 11:13:28.394 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 11:13:28.533 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 11:13:28.533 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 11:13:28.997 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 11:13:29.028 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 11:13:29.031 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 11:13:29.035 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 11:13:29.035 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 11:13:29.036 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 11:13:29.084 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 11:13:29.277 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 11:13:29.282 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 11:13:29.282 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 11:13:29.283 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 11:13:29.471 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 11:13:29.485 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 11:13:29.486 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 11:13:29.487 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 11:13:29.487 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 11:13:29.494 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 11:13:29.494 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 11:13:29.519 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 11:13:29.519 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 11:13:29.519 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 11:13:29.519 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 11:13:29.519 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 11:13:29.519 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 11:13:29.519 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 11:13:29.535 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 11:13:29.543 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 11:13:29.555 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 11:13:29.555 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 11:13:29.565 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 11:13:29.565 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 11:13:29.567 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 11:13:29.567 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 11:13:29.570 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 11:13:29.570 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 11:13:29.622 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 11:13:30.526 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 11:13:30.688 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 11:13:30.690 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 11:13:30.719 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 11:13:30.720 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 11:13:30.856 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 11:13:31.089 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 11:13:31.384 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 11:13:31.548 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 11:13:32.494 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.68 seconds (process running for 9.973)
2025-10-11 11:13:32.501 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 11:13:32.502 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 11:13:32.604 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 11:13:46.084 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4b3b4be8, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=99ms
2025-10-11 11:13:54.211 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 11:13:54.243 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=fd42f1de, method=GET, uri=/api/v1/chat/sessions, status=200, duration=39ms
2025-10-11 11:13:55.544 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3ca3b58c, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=14ms
2025-10-11 11:14:07.737 [http-nio-8080-exec-4] INFO  c.r.L.service.FileStorageService - 文件已存在，跳过保存: F:\LegalAssistant\uploads\contracts\0ef4ad0f8392f4e8c55fd9f4b95d9bb83837cb1161ecf2aa87a8d2f1ec2b3014_上海市养老服务合同.doc
2025-10-11 11:14:07.738 [http-nio-8080-exec-4] INFO  c.r.L.service.ContractReviewService - 创建待处理审查记录，用户: admin, 文件: 上海市养老服务合同.doc
2025-10-11 11:14:07.781 [http-nio-8080-exec-4] INFO  c.r.L.service.ContractReviewService - 待处理审查记录已创建 - ID: 30, 文件: 上海市养老服务合同.doc
2025-10-11 11:14:07.801 [Async-1] INFO  c.r.L.service.ContractReviewService - 开始异步处理合同文件，审查ID: 30
2025-10-11 11:14:07.801 [Async-1] INFO  c.r.L.service.ContractReviewService - 异步处理线程: Async-1
2025-10-11 11:14:07.804 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=34b3282c, method=POST, uri=/api/v1/contracts/upload, status=202, duration=106ms
2025-10-11 11:14:07.815 [Async-1] INFO  c.r.L.service.ContractReviewService - 开始解析文件: 上海市养老服务合同.doc, 路径: F:\LegalAssistant\uploads\contracts\0ef4ad0f8392f4e8c55fd9f4b95d9bb83837cb1161ecf2aa87a8d2f1ec2b3014_上海市养老服务合同.doc
2025-10-11 11:14:07.816 [Async-1] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 上海市养老服务合同.doc, 类型: doc, 大小: 77312 bytes
2025-10-11 11:14:07.826 [http-nio-8080-exec-5] INFO  c.r.L.c.ContractReviewController - 开始异步合同分析，审查ID: 30
2025-10-11 11:14:07.829 [http-nio-8080-exec-5] INFO  c.r.L.c.ContractReviewController - 用户 admin 通过JWT验证，开始处理合同分析，reviewId: 30
2025-10-11 11:14:07.830 [http-nio-8080-exec-5] INFO  c.r.L.c.ContractReviewController - SSE连接已建立: reviewId=30
2025-10-11 11:14:07.833 [Async-2] INFO  c.r.L.service.ContractReviewService - 开始异步分析合同（四步流程版），审查ID: 30
2025-10-11 11:14:07.833 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:07.836 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:14:07.840 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6b3501c4, method=GET, uri=/api/v1/contracts/30/analyze-async, status=200, duration=17ms
2025-10-11 11:14:08.021 [Async-1] WARN  o.apache.poi.hwpf.model.PAPBinTable - Paragraph [6291; 6292) has no PAPX. Creating new one.
2025-10-11 11:14:08.022 [Async-1] WARN  o.apache.poi.hwpf.model.PAPBinTable - Paragraph [6615; 6616) has no PAPX. Creating new one.
2025-10-11 11:14:08.052 [Async-1] WARN  o.apache.poi.hwpf.model.SectionTable - Your document seemed to be mostly unicode, but the section definition was in bytes! Trying anyway, but things may well go wrong!
2025-10-11 11:14:08.124 [Async-1] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 上海市养老服务合同.doc, 内容长度: 6200 字符
2025-10-11 11:14:08.125 [Async-1] INFO  c.r.L.service.ContractReviewService - 文件解析成功: 上海市养老服务合同.doc, 内容长度: 6200
2025-10-11 11:14:08.125 [Async-1] INFO  c.r.L.service.ContractReviewService - 文档解析完成，文本内容已保存: reviewId=30, 文本长度: 6200
2025-10-11 11:14:08.126 [Async-1] INFO  c.r.L.service.EtlService - 开始处理文本内容，长度: 6200 字符
2025-10-11 11:14:08.131 [Async-1] INFO  c.r.L.service.EtlService - 文本分块完成，生成 404 个文本块
2025-10-11 11:14:08.864 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:08.865 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:14:09.871 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:09.873 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:14:10.881 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:10.883 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:14:11.892 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:11.894 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:14:12.903 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:12.905 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:14:13.915 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:13.917 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:14:14.930 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:14.932 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 11:14:15.250 [Async-1] INFO  c.r.L.service.EtlService - 文本内容处理完成，404 个向量块已存储
2025-10-11 11:14:15.250 [Async-1] INFO  c.r.L.service.ContractReviewService - 已成功将合同内容添加到AI知识库，审查ID: 30, 块数: 404
2025-10-11 11:14:15.251 [Async-1] INFO  c.r.L.service.ContractReviewService - 合同文件处理完成，审查ID: 30
2025-10-11 11:14:15.251 [Async-1] INFO  c.r.L.service.ContractReviewService - 异步处理合同文件方法结束，审查ID: 30
2025-10-11 11:14:15.941 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=30
2025-10-11 11:14:15.942 [Async-2] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 6200
2025-10-11 11:14:15.943 [Async-2] INFO  c.r.L.service.ContractReviewService - 文件解析完成，等待时间: 8秒, reviewId=30
2025-10-11 11:14:15.944 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤1完成：文档解析成功, reviewId=30
2025-10-11 11:14:15.951 [Async-2] INFO  c.r.LegalAssistant.service.AiService - 进行结构化合同风险分析，内容长度: 6200
2025-10-11 11:15:29.118 [Async-2] INFO  c.r.LegalAssistant.service.AiService - 结构化风险分析完成，识别出 10 个风险维度
2025-10-11 11:15:29.120 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤2完成：风险识别成功, reviewId=30
2025-10-11 11:15:29.121 [Async-2] INFO  c.r.L.service.AgentService - 开始分析合同关键条款，内容长度: 6200
2025-10-11 11:17:15.264 [Async-2] INFO  c.r.L.service.AgentService - JSON格式验证成功，包含 10 个关键条款
2025-10-11 11:17:15.265 [Async-2] INFO  c.r.L.service.AgentService - 关键条款分析完成，原始响应长度: 3159, 清理后长度: 3159
2025-10-11 11:17:15.265 [Async-2] INFO  c.r.L.service.ContractReviewService - 关键条款分析成功，识别出 10 个关键条款
2025-10-11 11:17:15.266 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤3完成：条款分析成功, reviewId=30
2025-10-11 11:17:15.293 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤4完成：分析结果保存成功, reviewId=30
2025-10-11 11:17:15.310 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始生成PDF报告，审查ID: 30
2025-10-11 11:17:15.310 [Async-2] INFO  c.r.L.s.ReportGenerationService - 初始化PDF中文字体支持...
2025-10-11 11:17:15.389 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ 成功加载系统字体: C:/Windows/Fonts/STSONG.TTF (华文宋体优先，PDF兼容性最佳)
2025-10-11 11:17:15.427 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ PDF文档字体设置成功
2025-10-11 11:17:15.427 [Async-2] INFO  c.r.L.s.ReportGenerationService - 准备生成增强内容...
2025-10-11 11:17:15.427 [Async-2] INFO  c.r.L.s.ReportGenerationService - 使用DeepSeek生成增强报告内容（带降级处理），审查ID: 30
2025-10-11 11:17:15.427 [Async-2] INFO  c.r.L.s.ReportGenerationService - 使用结构化方式生成增强报告内容，审查ID: 30
2025-10-11 11:17:20.579 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始使用结构化内容生成器生成报告，合同内容长度: 6200
2025-10-11 11:17:20.580 [ForkJoinPool.commonPool-worker-2] INFO  c.r.L.s.StructuredContentGenerator - 生成执行摘要结构化内容，审查ID: 30
2025-10-11 11:17:20.580 [ForkJoinPool.commonPool-worker-3] INFO  c.r.L.s.StructuredContentGenerator - 生成深度分析结构化内容，审查ID: 30
2025-10-11 11:17:20.580 [ForkJoinPool.commonPool-worker-4] INFO  c.r.L.s.StructuredContentGenerator - 生成改进建议结构化内容，审查ID: 30
2025-10-11 11:18:06.773 [Async-2] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成成功
2025-10-11 11:18:06.774 [Async-2] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成完成，耗时: 51347ms
2025-10-11 11:18:06.774 [Async-2] INFO  c.r.L.util.ReportContentValidator - 【报告完整性验证通过】所有必要内容齐全
2025-10-11 11:18:06.776 [Async-2] INFO  c.r.L.s.ReportGenerationService - ✓ 增强内容生成成功
2025-10-11 11:18:06.776 [Async-2] INFO  c.r.L.s.ReportGenerationService - 开始添加报告各部分内容...
2025-10-11 11:18:06.908 [Async-2] INFO  c.r.L.s.ReportGenerationService - 所有PDF内容添加完成
2025-10-11 11:18:06.956 [Async-2] INFO  c.r.L.s.ReportGenerationService - PDF报告生成成功，审查ID: 30, 文件大小: 337434 bytes
2025-10-11 11:18:06.959 [Async-2] INFO  c.r.L.service.ContractReviewService - PDF报告已保存到文件系统: F:\LegalAssistant\uploads\reports\30_report.pdf
2025-10-11 11:18:06.973 [Async-2] INFO  c.r.L.service.ContractReviewService - 步骤5完成：PDF报告生成并保存成功, reviewId=30, 文件大小: 337434 bytes
2025-10-11 11:18:06.990 [Async-2] INFO  c.r.L.service.ContractReviewService - 合同异步分析流程全部完成, reviewId=30
2025-10-11 11:18:07.000 [http-nio-8080-exec-6] INFO  c.r.L.service.ContractReviewService - SSE连接完成: reviewId=30
2025-10-11 11:18:18.951 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 30
2025-10-11 11:18:18.965 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 30, 文件大小: 337434 bytes
2025-10-11 11:18:18.965 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 上海市养老服务合同分析报告.pdf
2025-10-11 11:18:18.966 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 30, 文件大小: 337434 bytes, 文件名: 上海市养老服务合同分析报告.pdf
2025-10-11 11:18:18.968 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=92e33904, method=GET, uri=/api/v1/contracts/30/report, status=200, duration=18ms
2025-10-11 11:19:06.371 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 11:19:06.375 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:12:54.490 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 9592 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 16:12:54.492 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 16:12:57.264 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:12:57.444 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@8eeb4c5
2025-10-11 16:12:57.519 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:12:57.537 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 16:12:57.543 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 16:12:57.628 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 16:12:57.631 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 16:12:58.104 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:12:59.680 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:12:59.733 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:12:59.735 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:12:59.757 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:12:59.758 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:12:59.758 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:12:59.758 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:12:59.758 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:12:59.759 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:12:59.759 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:12:59.788 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:12:59.959 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 16:12:59.960 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 16:13:00.098 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:13:00.099 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:13:00.099 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:13:00.099 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:13:00.100 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:13:00.104 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:13:00.465 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:13:00.496 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:13:00.498 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:13:00.501 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:13:00.502 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:13:00.502 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:13:00.538 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:13:00.720 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:13:00.722 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:13:00.722 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:13:00.722 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:13:00.915 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:13:00.924 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:13:00.925 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:13:00.925 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:13:00.925 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:13:00.932 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:13:00.932 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:13:00.958 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:13:00.959 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:13:00.959 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:13:00.960 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:13:00.960 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:13:00.960 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:13:00.960 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:13:00.971 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:13:00.979 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:13:00.992 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:13:00.992 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:13:01.003 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:13:01.004 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:13:01.006 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:13:01.006 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:13:01.008 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:13:01.008 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:13:01.076 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 16:13:02.127 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:13:02.257 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用法律文档分割器
2025-10-11 16:13:02.282 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:13:02.285 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:13:02.314 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:13:02.315 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:13:02.452 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:13:02.702 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:13:03.043 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:13:03.208 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:13:04.196 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 10.204 seconds (process running for 10.5)
2025-10-11 16:13:04.203 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 16:13:04.204 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 16:13:04.317 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 16:13:14.018 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 16:13:14.038 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=7c5c0627, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=82ms
2025-10-11 16:13:19.319 [http-nio-8080-exec-5] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 21
2025-10-11 16:13:19.320 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 21
2025-10-11 16:13:19.327 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=05774de3, method=POST, uri=/api/v1/knowledge-base/documents/21/reprocess, status=200, duration=25ms
2025-10-11 16:13:19.344 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 民事诉讼法.pdf, 开始重新处理
2025-10-11 16:13:19.345 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 删除文档块功能需要根据具体的VectorStore实现来完成: uploads/民事诉讼法.pdf
2025-10-11 16:13:19.346 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 删除文档旧的向量数据: uploads/民事诉讼法.pdf
2025-10-11 16:13:19.346 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.EtlService - 开始处理文本内容，长度: 2003 字符
2025-10-11 16:13:19.355 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.EtlService - 文本分块完成，生成 402 个文本块
2025-10-11 16:13:21.657 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 16:13:21.659 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=53fe4c74, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=14ms
2025-10-11 16:13:29.016 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.EtlService - 文本内容处理完成，402 个向量块已存储
2025-10-11 16:13:29.052 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 民事诉讼法.pdf, 新的块数: 402
2025-10-11 16:14:10.977 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:14:10.981 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:14:24.036 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 35984 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 16:14:24.037 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 16:14:26.193 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:14:26.310 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@36696821
2025-10-11 16:14:26.354 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:14:26.373 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 16:14:26.379 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 16:14:26.455 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 16:14:26.456 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 16:14:26.772 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:14:28.136 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:14:28.188 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:14:28.190 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:14:28.214 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:14:28.214 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:14:28.214 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:14:28.214 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:14:28.214 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:14:28.214 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:14:28.214 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:14:28.250 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:14:28.344 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 16:14:28.345 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 16:14:28.465 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:14:28.465 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:14:28.465 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:14:28.465 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:14:28.466 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:14:28.470 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:14:28.761 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:14:28.787 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:14:28.789 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:14:28.792 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:14:28.793 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:14:28.794 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:14:28.822 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:14:28.984 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:14:28.986 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:14:28.986 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:14:28.987 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:14:29.136 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:14:29.143 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:14:29.144 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:14:29.144 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:14:29.145 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:14:29.163 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:14:29.163 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:14:29.203 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:14:29.204 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:14:29.204 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:14:29.204 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:14:29.204 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:14:29.204 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:14:29.205 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:14:29.217 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:14:29.226 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:14:29.237 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:14:29.237 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:14:29.249 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:14:29.249 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:14:29.251 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:14:29.251 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:14:29.252 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:14:29.252 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:14:29.306 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 16:14:29.685 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:14:29.798 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用法律文档分割器
2025-10-11 16:14:29.821 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:14:29.823 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:14:29.845 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:14:29.847 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:14:29.960 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:14:30.152 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:14:30.442 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:14:30.587 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:14:31.401 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 7.793 seconds (process running for 8.052)
2025-10-11 16:14:31.406 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 16:14:31.407 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 16:14:31.493 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 16:14:35.605 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 16:14:35.624 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=47179f4c, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=76ms
2025-10-11 16:14:39.154 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 11
2025-10-11 16:14:39.154 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 11
2025-10-11 16:14:39.158 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=1d7c197b, method=POST, uri=/api/v1/knowledge-base/documents/11/reprocess, status=200, duration=15ms
2025-10-11 16:14:39.177 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 民法典.pdf, 开始重新处理
2025-10-11 16:14:39.178 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 删除文档块功能需要根据具体的VectorStore实现来完成: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:14:39.178 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 删除文档旧的向量数据: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:14:39.178 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.EtlService - 开始处理文本内容，长度: 2003 字符
2025-10-11 16:14:39.185 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.EtlService - 文本分块完成，生成 402 个文本块
2025-10-11 16:14:41.655 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 16:14:41.657 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4767bc90, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=12ms
2025-10-11 16:14:46.228 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.EtlService - 文本内容处理完成，402 个向量块已存储
2025-10-11 16:14:46.255 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 民法典.pdf, 新的块数: 402
2025-10-11 16:15:06.800 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:15:06.803 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:18:37.692 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 20392 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 16:18:37.694 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 16:18:40.523 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:18:40.689 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@6dadcf58
2025-10-11 16:18:40.753 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:18:40.773 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 16:18:40.780 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 16:18:40.876 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 16:18:40.878 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 16:18:41.368 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:18:42.992 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:18:43.049 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:18:43.053 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:18:43.080 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:18:43.081 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:18:43.081 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:18:43.081 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:18:43.082 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:18:43.082 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:18:43.082 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:18:43.116 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:18:43.266 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 16:18:43.266 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 16:18:43.412 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:18:43.412 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:18:43.412 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:18:43.413 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:18:43.413 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:18:43.419 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:18:43.785 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:18:43.814 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:18:43.816 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:18:43.820 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:18:43.821 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:18:43.822 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:18:43.852 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:18:44.050 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:18:44.052 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:18:44.053 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:18:44.053 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:18:44.246 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:18:44.255 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:18:44.257 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:18:44.257 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:18:44.257 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:18:44.266 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:18:44.267 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:18:44.299 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:18:44.299 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:18:44.300 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:18:44.300 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:18:44.300 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:18:44.300 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:18:44.300 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:18:44.314 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:18:44.324 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:18:44.338 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:18:44.339 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:18:44.351 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:18:44.351 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:18:44.354 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:18:44.354 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:18:44.356 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:18:44.357 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:18:44.416 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 16:18:44.987 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:18:45.198 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用法律文档分割器
2025-10-11 16:18:45.245 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:18:45.248 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:18:45.291 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:18:45.294 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:18:45.563 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:18:45.954 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:18:46.525 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:18:46.811 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:18:48.419 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 11.231 seconds (process running for 11.577)
2025-10-11 16:18:48.427 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 16:18:48.429 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 16:18:48.578 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 所有法律文档都已被索引，跳过自动索引
2025-10-11 16:19:08.223 [http-nio-8080-exec-1] INFO  c.r.L.c.KnowledgeBaseController - 管理员删除单个文档: 25
2025-10-11 16:19:08.228 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 开始删除文档: 25
2025-10-11 16:19:08.246 [http-nio-8080-exec-1] WARN  c.r.L.service.KnowledgeBaseService - 删除文档块功能需要根据具体的VectorStore实现来完成: F:\LegalAssistant\uploads\law\民事诉讼法.pdf
2025-10-11 16:19:08.281 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 文档删除成功: 民事诉讼法.pdf (ID: 25)
2025-10-11 16:19:08.300 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=a2d55968, method=DELETE, uri=/api/v1/knowledge-base/documents/25, status=200, duration=111ms
2025-10-11 16:19:08.348 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=8
2025-10-11 16:19:08.353 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=7fdbe580, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=27ms
2025-10-11 16:19:10.770 [http-nio-8080-exec-2] INFO  c.r.L.c.VectorIndexController - 管理员请求重建知识库索引
2025-10-11 16:19:10.771 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始重建知识库索引...
2025-10-11 16:19:10.773 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 清空向量存储功能需要根据具体的VectorStore实现来完成
2025-10-11 16:19:10.776 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=04b9ceb1, method=POST, uri=/api/v1/vector-index/rebuild, status=200, duration=11ms
2025-10-11 16:19:10.793 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 拍卖法.pdf (ID: 19)
2025-10-11 16:19:10.794 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 环境保护法.pdf (ID: 6)
2025-10-11 16:19:10.794 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 刑法.pdf (ID: 7)
2025-10-11 16:19:10.795 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 劳动法.pdf (ID: 8)
2025-10-11 16:19:10.795 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 社会保险法.pdf (ID: 20)
2025-10-11 16:19:10.796 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 民事诉讼法.pdf (ID: 21)
2025-10-11 16:19:10.796 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 宪法.pdf (ID: 9)
2025-10-11 16:19:10.796 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 民法典.pdf (ID: 11)
2025-10-11 16:19:10.796 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 知识库索引重建完成，共处理 8 个文档
2025-10-11 16:20:28.159 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:20:28.162 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:34:43.454 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 13696 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 16:34:43.455 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 16:34:45.673 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:34:45.795 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@73633230
2025-10-11 16:34:45.839 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:34:45.861 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 16:34:45.867 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 16:34:45.950 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 16:34:45.951 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 16:34:46.335 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:34:47.801 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:34:47.847 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:34:47.849 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:34:47.872 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:34:47.872 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:34:47.872 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:34:47.872 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:34:47.872 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:34:47.872 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:34:47.872 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:34:47.899 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:34:47.988 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 16:34:47.988 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 16:34:48.111 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:34:48.111 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:34:48.111 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:34:48.111 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:34:48.113 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:34:48.116 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:34:48.404 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:34:48.435 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:34:48.437 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:34:48.447 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:34:48.448 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:34:48.449 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:34:48.478 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:34:48.683 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:34:48.686 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:34:48.686 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:34:48.686 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:34:48.881 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:34:48.888 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:34:48.890 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:34:48.890 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:34:48.890 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:34:48.895 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:34:48.896 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:34:48.918 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:34:48.918 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:34:48.918 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:34:48.918 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:34:48.919 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:34:48.919 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:34:48.919 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:34:48.929 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:34:48.938 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:34:48.949 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:34:48.950 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:34:48.967 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:34:48.968 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:34:48.969 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:34:48.970 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:34:48.971 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:34:48.971 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:34:49.017 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 16:34:49.442 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:34:49.526 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 16:34:49.529 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 16:34:49.571 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 16:34:49.596 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:34:49.598 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:34:49.623 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:34:49.624 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:34:49.740 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:34:49.944 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:34:50.309 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:34:50.548 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:34:51.327 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.262 seconds (process running for 8.626)
2025-10-11 16:34:51.334 [main] INFO  c.r.L.config.StartupIndexer - 检查是否需要索引法律文档...
2025-10-11 16:34:51.335 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 发现 6 个法律文档，检查是否需要索引...
2025-10-11 16:34:51.419 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 开始自动索引...
2025-10-11 16:34:51.419 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始批量索引目录: uploads/law, 递归: false
2025-10-11 16:34:51.420 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 发现 6 个文档待索引
2025-10-11 16:34:51.420 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\刑法.pdf
2025-10-11 16:34:51.422 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\刑法.pdf
2025-10-11 16:34:51.422 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\劳动法.pdf
2025-10-11 16:34:51.423 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\劳动法.pdf
2025-10-11 16:34:51.423 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\宪法.pdf
2025-10-11 16:34:51.425 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\宪法.pdf
2025-10-11 16:34:51.425 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\民事诉讼法.pdf
2025-10-11 16:34:51.989 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 307 个片段
2025-10-11 16:34:56.257 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档索引完成: F:\LegalAssistant\uploads\law\民事诉讼法.pdf, 片段数: 256, 耗时: 4832ms
2025-10-11 16:34:56.258 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:34:56.259 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:34:56.260 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\环境保护法.pdf
2025-10-11 16:34:56.261 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 文档已存在于数据库中，跳过索引: F:\LegalAssistant\uploads\law\环境保护法.pdf
2025-10-11 16:34:56.261 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentIndexingService - 批量索引完成: 总计 6 个文档, 成功 6 个, 生成 256 个片段, 耗时 4842ms
2025-10-11 16:34:56.261 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 自动索引完成 - 总文档: 6, 成功: 6, 总片段: 256, 耗时: 4842ms
2025-10-11 16:34:56.261 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.config.StartupIndexer - 法律文档索引完成，AI聊天功能现在可以使用这些文档进行问答
2025-10-11 16:35:20.064 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 16:35:20.085 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=20188abb, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=77ms
2025-10-11 16:35:25.003 [http-nio-8080-exec-1] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 11
2025-10-11 16:35:25.004 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 11
2025-10-11 16:35:25.008 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=97687e7c, method=POST, uri=/api/v1/knowledge-base/documents/11/reprocess, status=200, duration=16ms
2025-10-11 16:35:25.023 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 民法典.pdf, 开始重新处理
2025-10-11 16:35:25.023 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 删除文档块功能需要根据具体的VectorStore实现来完成: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:35:25.023 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 删除文档旧的向量数据: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:35:25.024 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 2003 字符
2025-10-11 16:35:25.025 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 7 个片段
2025-10-11 16:35:25.323 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 1, 存储数: 1, 耗时: 299ms
2025-10-11 16:35:25.330 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 民法典.pdf, 新的块数: 1, 分割器: LegalDocumentSplitter
2025-10-11 16:35:27.659 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 16:35:27.660 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=21c643a5, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=11ms
2025-10-11 16:36:07.230 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:36:07.233 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:41:14.474 [main] INFO  c.r.LegalAssistant.DatabaseInspector - Starting DatabaseInspector using Java 21.0.5 with PID 25668 (started by river in F:\LegalAssistant)
2025-10-11 16:41:14.476 [main] INFO  c.r.LegalAssistant.DatabaseInspector - The following 1 profile is active: "test"
2025-10-11 16:41:19.572 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:41:19.965 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection conn0: url=jdbc:h2:mem:testdb user=SA
2025-10-11 16:41:20.062 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:41:20.101 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: H2Dialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:41:21.488 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:41:21.494 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:41:21.537 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:41:21.537 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:41:21.538 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:41:21.538 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:41:21.538 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:41:21.538 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:41:21.538 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:41:24.172 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:41:24.228 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:41:24.232 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:41:24.240 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:41:24.241 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:41:24.242 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:41:24.274 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:41:24.496 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:41:24.501 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:41:24.501 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:41:24.501 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:41:24.530 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化测试环境内存嵌入存储
2025-10-11 16:41:24.540 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:41:25.028 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:41:25.044 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:41:25.046 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:41:25.046 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:41:25.046 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:41:25.062 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:41:25.062 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:41:25.131 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:41:25.131 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:41:25.132 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:41:25.132 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:41:25.132 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:41:25.132 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:41:25.132 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:41:25.147 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:41:25.156 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:41:25.171 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:41:25.172 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:41:25.188 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:41:25.188 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:41:25.194 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:41:25.194 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:41:25.198 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:41:25.198 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:41:26.070 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:41:26.173 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:41:26.174 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:41:26.174 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:41:26.174 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:41:26.174 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:41:26.182 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 16:41:26.185 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 16:41:26.294 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:41:26.338 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 16:41:26.376 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:41:26.379 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:41:26.431 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:41:26.432 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:41:26.624 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:41:26.874 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:41:27.331 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:41:27.634 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:41:27.790 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:41:28.687 [main] INFO  c.r.LegalAssistant.DatabaseInspector - Started DatabaseInspector in 14.961 seconds (process running for 17.035)
2025-10-11 16:41:29.193 [main] INFO  c.r.LegalAssistant.DatabaseInspector - ===== 开始检查民法典的分割情况 =====
2025-10-11 16:41:29.201 [main] WARN  c.r.LegalAssistant.DatabaseInspector - ❌ 数据库中没有找到民法典相关文档
2025-10-11 16:41:29.201 [main] INFO  c.r.LegalAssistant.DatabaseInspector - 建议：请先索引民法典文档
2025-10-11 16:41:31.527 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:41:31.531 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:43:35.702 [main] INFO  c.r.LegalAssistant.DatabaseInspector - Starting DatabaseInspector using Java 21.0.5 with PID 1652 (started by river in F:\LegalAssistant)
2025-10-11 16:43:35.704 [main] INFO  c.r.LegalAssistant.DatabaseInspector - No active profile set, falling back to 1 default profile: "default"
2025-10-11 16:43:40.061 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:43:40.442 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@163b8c14
2025-10-11 16:43:40.569 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:43:40.643 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 16:43:40.673 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 16:43:40.805 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 16:43:40.813 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 16:43:41.713 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:43:42.960 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:43:42.963 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:43:43.006 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:43:43.007 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:43:43.007 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:43:43.007 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:43:43.007 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:43:43.007 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:43:43.007 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:43:45.411 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:43:45.464 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:43:45.466 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:43:45.474 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:43:45.476 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:43:45.477 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:43:45.530 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:43:45.723 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:43:45.726 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:43:45.726 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:43:45.726 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:43:45.739 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 16:43:45.740 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 16:43:45.822 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:43:46.238 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:43:46.252 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:43:46.253 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:43:46.253 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:43:46.254 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:43:46.267 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:43:46.267 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:43:46.333 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:43:46.334 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:43:46.334 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:43:46.334 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:43:46.334 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:43:46.334 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:43:46.334 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:43:46.349 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:43:46.359 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:43:46.371 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:43:46.372 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:43:46.383 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:43:46.383 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:43:46.390 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:43:46.390 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:43:46.393 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:43:46.394 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:43:46.516 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 16:43:47.201 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:43:47.296 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:43:47.296 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:43:47.296 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:43:47.296 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:43:47.297 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:43:47.304 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 16:43:47.307 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 16:43:47.436 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:43:47.476 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 16:43:47.511 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:43:47.513 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:43:47.566 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:43:47.568 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:43:47.759 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:43:48.027 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:43:48.514 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:43:48.805 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:43:48.964 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:43:49.775 [main] INFO  c.r.LegalAssistant.DatabaseInspector - Started DatabaseInspector in 14.798 seconds (process running for 16.817)
2025-10-11 16:43:50.187 [main] INFO  c.r.LegalAssistant.DatabaseInspector - ===== 开始检查民法典的分割情况 =====
2025-10-11 16:43:50.202 [main] INFO  c.r.LegalAssistant.DatabaseInspector - 
📄 找到 1 个民法典相关文档：
2025-10-11 16:43:50.202 [main] INFO  c.r.LegalAssistant.DatabaseInspector -   - ID: 11, 标题: 民法典.pdf, 类型: LAW
2025-10-11 16:43:50.202 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     源文件: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:43:50.202 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     内容长度: 2003 字符
2025-10-11 16:43:50.202 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     创建时间: 2025-09-30 21:46:15.928174
2025-10-11 16:43:50.202 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     更新时间: 2025-10-11 16:35:25.327572
2025-10-11 16:43:52.533 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:43:52.538 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:45:02.781 [main] INFO  c.r.LegalAssistant.DatabaseInspector - Starting DatabaseInspector using Java 21.0.5 with PID 27464 (started by river in F:\LegalAssistant)
2025-10-11 16:45:02.783 [main] INFO  c.r.LegalAssistant.DatabaseInspector - No active profile set, falling back to 1 default profile: "default"
2025-10-11 16:45:07.436 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:45:07.789 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@6e189ee3
2025-10-11 16:45:07.913 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:45:07.984 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 16:45:08.005 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 16:45:08.147 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 16:45:08.160 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 16:45:09.110 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:45:10.496 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:45:10.499 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:45:10.547 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:45:10.547 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:45:10.547 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:45:10.547 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:45:10.547 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:45:10.547 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:45:10.547 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:45:13.173 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:45:13.235 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:45:13.239 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:45:13.248 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:45:13.249 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:45:13.249 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:45:13.281 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:45:13.453 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:45:13.457 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:45:13.457 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:45:13.457 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:45:13.470 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 16:45:13.470 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 16:45:13.532 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:45:13.903 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:45:13.916 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:45:13.918 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:45:13.919 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:45:13.919 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:45:13.934 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:45:13.934 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:45:13.976 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:45:13.976 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:45:13.977 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:45:13.977 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:45:13.977 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:45:13.977 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:45:13.977 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:45:13.990 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:45:14.000 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:45:14.011 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:45:14.011 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:45:14.020 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:45:14.020 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:45:14.036 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:45:14.036 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:45:14.039 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:45:14.039 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:45:14.126 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 16:45:14.793 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:45:14.899 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:45:14.899 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:45:14.899 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:45:14.899 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:45:14.900 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:45:14.907 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 16:45:14.910 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 16:45:15.033 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:45:15.074 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 16:45:15.113 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:45:15.115 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:45:15.177 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:45:15.179 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:45:15.320 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:45:15.588 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:45:16.131 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:45:16.573 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:45:16.779 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:45:18.100 [main] INFO  c.r.LegalAssistant.DatabaseInspector - Started DatabaseInspector in 15.945 seconds (process running for 18.139)
2025-10-11 16:45:18.669 [main] INFO  c.r.LegalAssistant.DatabaseInspector - ===== 开始检查民法典的分割情况 =====
2025-10-11 16:45:18.677 [main] INFO  c.r.LegalAssistant.DatabaseInspector - 
📄 找到 1 个民法典相关文档：
2025-10-11 16:45:18.677 [main] INFO  c.r.LegalAssistant.DatabaseInspector -   - ID: 11, 标题: 民法典.pdf, 类型: LAW
2025-10-11 16:45:18.677 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     源文件: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:45:18.677 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     内容长度: 2003 字符
2025-10-11 16:45:18.677 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     创建时间: 2025-09-30 21:46:15.928174
2025-10-11 16:45:18.678 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     更新时间: 2025-10-11 16:35:25.327572
2025-10-11 16:45:18.761 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     ✅ 向量分割片段数: 804
2025-10-11 16:45:18.761 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     📊 片段统计:
2025-10-11 16:45:18.762 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        - 平均长度: 205 字符
2025-10-11 16:45:18.763 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        - 最小长度: 1 字符
2025-10-11 16:45:18.763 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        - 最大长度: 1989 字符
2025-10-11 16:45:18.766 [main] INFO  c.r.LegalAssistant.DatabaseInspector -     📝 示例片段 (前5个):
2025-10-11 16:45:18.766 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        片段 1: 章节=未知, 节=未知, 条文=未知
2025-10-11 16:45:18.767 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        内容预览: 1

中华人民共和国民法典

（2020 年 5 月 28 日第十三届全国人民代表大会第三次会议

通过，2021 年 1 月 1 日开始施行）

目录

第一编 总则

第一章 基本规定

第二章 ...
2025-10-11 16:45:18.767 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        片段 2: 章节=未知, 节=未知, 条文=未知
2025-10-11 16:45:18.767 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        内容预览: 四章 产品责任

第五章 机动车交通事故责任

第六章 医疗损害责任

第七章 环境污染和生态破坏责任

第八章 高度危险责任

第九章 饲养动物损害责任

第十章 建筑物和物件损害责任

附则

第...
2025-10-11 16:45:18.767 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        片段 3: 章节=未知, 节=未知, 条文=未知
2025-10-11 16:45:18.767 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        内容预览: 机动车交通事故责任

第六章 医疗损害责任

第七章 环境污染和生态破坏责任

第八章 高度危险责任

第九章 饲养动物损害责任

第十章 建筑物和物件损害责任

附则

第一编 总则

第一章 基本...
2025-10-11 16:45:18.767 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        片段 4: 章节=未知, 节=未知, 条文=未知
2025-10-11 16:45:18.767 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        内容预览: 动车交通事故责任

第六章 医疗损害责任

第七章 环境污染和生态破坏责任

第八章 高度危险责任

第九章 饲养动物损害责任

第十章 建筑物和物件损害责任

附则

第一编 总则

第一章 基本规...
2025-10-11 16:45:18.767 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        片段 5: 章节=未知, 节=未知, 条文=未知
2025-10-11 16:45:18.768 [main] INFO  c.r.LegalAssistant.DatabaseInspector -        内容预览: 车交通事故责任

第六章 医疗损害责任

第七章 环境污染和生态破坏责任

第八章 高度危险责任

第九章 饲养动物损害责任

第十章 建筑物和物件损害责任

附则

第一编 总则

第一章 基本规定...
2025-10-11 16:45:18.768 [main] INFO  c.r.LegalAssistant.DatabaseInspector - 
2025-10-11 16:45:18.772 [main] INFO  c.r.LegalAssistant.DatabaseInspector - 🔍 LangChain4j嵌入表中民法典相关记录数: 0
2025-10-11 16:45:18.772 [main] INFO  c.r.LegalAssistant.DatabaseInspector - 
===== 检查完成 =====
2025-10-11 16:45:18.772 [main] INFO  c.r.LegalAssistant.DatabaseInspector - 
💡 建议：
2025-10-11 16:45:18.772 [main] INFO  c.r.LegalAssistant.DatabaseInspector -   1. 如果更新时间较旧，可能需要重新索引
2025-10-11 16:45:18.773 [main] INFO  c.r.LegalAssistant.DatabaseInspector -   2. 如果片段数量异常少，建议检查分割配置
2025-10-11 16:45:18.773 [main] INFO  c.r.LegalAssistant.DatabaseInspector -   3. 如果没有向量片段，需要重新执行索引操作
2025-10-11 16:45:21.223 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:45:21.230 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:47:25.930 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 21220 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 16:47:25.931 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 16:47:28.191 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:47:28.316 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@4964d801
2025-10-11 16:47:28.355 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:47:28.375 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 16:47:28.382 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 16:47:28.463 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 16:47:28.464 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 16:47:28.810 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:47:30.143 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:47:30.199 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:47:30.201 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:47:30.224 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:47:30.224 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:47:30.224 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:47:30.225 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:47:30.225 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:47:30.225 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:47:30.225 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:47:30.537 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:47:30.566 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:47:30.567 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:47:30.571 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:47:30.572 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:47:30.572 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:47:30.603 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:47:30.787 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:47:30.789 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:47:30.790 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:47:30.790 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:47:30.800 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 16:47:30.801 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 16:47:30.969 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:47:31.221 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:47:31.229 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:47:31.230 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:47:31.230 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:47:31.230 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:47:31.237 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:47:31.237 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:47:31.259 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:47:31.259 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:47:31.259 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:47:31.260 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:47:31.260 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:47:31.260 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:47:31.260 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:47:31.271 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:47:31.279 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:47:31.290 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:47:31.290 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:47:31.299 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:47:31.300 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:47:31.302 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:47:31.302 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:47:31.303 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:47:31.304 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:47:31.351 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 16:47:31.713 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:47:31.788 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:47:31.788 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:47:31.788 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:47:31.788 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:47:31.788 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:47:31.794 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 16:47:31.797 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 16:47:31.871 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:47:31.896 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 16:47:31.918 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:47:31.920 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:47:31.942 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:47:31.943 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:47:32.056 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:47:32.264 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:47:32.530 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:47:32.677 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:47:33.457 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 7.919 seconds (process running for 8.179)
2025-10-11 16:47:38.876 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 16:47:38.904 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=312e3999, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=108ms
2025-10-11 16:47:39.174 [http-nio-8080-exec-10] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=9
2025-10-11 16:47:39.175 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=184217a0, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=9ms
2025-10-11 16:47:43.840 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员删除单个文档: 26
2025-10-11 16:47:43.841 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始删除文档: 26
2025-10-11 16:47:43.855 [http-nio-8080-exec-2] WARN  c.r.L.service.KnowledgeBaseService - 删除文档块功能需要根据具体的VectorStore实现来完成: F:\LegalAssistant\uploads\law\民事诉讼法.pdf
2025-10-11 16:47:43.911 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 文档删除成功: 民事诉讼法.pdf (ID: 26)
2025-10-11 16:47:43.924 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=cab602f8, method=DELETE, uri=/api/v1/knowledge-base/documents/26, status=200, duration=101ms
2025-10-11 16:47:43.985 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=8
2025-10-11 16:47:43.990 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ce564e91, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=18ms
2025-10-11 16:48:54.218 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:48:54.222 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 16:57:12.563 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - Starting ReindexCivilCode using Java 21.0.5 with PID 36096 (started by river in F:\LegalAssistant)
2025-10-11 16:57:12.566 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - No active profile set, falling back to 1 default profile: "default"
2025-10-11 16:57:16.986 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 16:57:17.396 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@367d083e
2025-10-11 16:57:17.531 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 16:57:17.602 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 16:57:17.619 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 16:57:17.773 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 16:57:17.784 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 16:57:18.666 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 16:57:20.043 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 16:57:20.045 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 16:57:20.092 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 16:57:20.092 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 16:57:20.092 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 16:57:20.092 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 16:57:20.092 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 16:57:20.092 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 16:57:20.093 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 16:57:22.571 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 16:57:22.624 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 16:57:22.627 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 16:57:22.632 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 16:57:22.633 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 16:57:22.634 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 16:57:22.665 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 16:57:22.863 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 16:57:22.868 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 16:57:22.868 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 16:57:22.868 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 16:57:22.881 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 16:57:22.881 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 16:57:22.960 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 16:57:23.414 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 16:57:23.428 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 16:57:23.430 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 16:57:23.430 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 16:57:23.430 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 16:57:23.445 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 16:57:23.445 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 16:57:23.512 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 16:57:23.512 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 16:57:23.513 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 16:57:23.513 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 16:57:23.513 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 16:57:23.513 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 16:57:23.513 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 16:57:23.532 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 16:57:23.542 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 16:57:23.558 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 16:57:23.558 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 16:57:23.572 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 16:57:23.572 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 16:57:23.577 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 16:57:23.577 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 16:57:23.579 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 16:57:23.579 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 16:57:23.643 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 16:57:24.271 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 16:57:24.370 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 16:57:24.370 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 16:57:24.370 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 16:57:24.370 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 16:57:24.371 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 16:57:24.378 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 16:57:24.381 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 16:57:24.499 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 16:57:24.541 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 16:57:24.581 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 16:57:24.584 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 16:57:24.649 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 16:57:24.651 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 16:57:24.846 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 16:57:25.142 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 16:57:25.520 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 16:57:25.820 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 16:57:25.939 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 16:57:26.819 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - Started ReindexCivilCode in 15.032 seconds (process running for 17.079)
2025-10-11 16:57:27.315 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - ========== 开始重新索引民法典 ==========
2025-10-11 16:57:27.315 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - 步骤1: 强制重建索引...
2025-10-11 16:57:27.315 [main] INFO  c.r.L.s.DocumentIndexingService - 开始索引文档: F:\LegalAssistant\uploads\law\民法典.pdf, 强制重建: true
2025-10-11 16:57:27.439 [main] INFO  c.r.L.s.DocumentIndexingService - 文档已存在，但强制重建，先删除旧数据: F:\LegalAssistant\uploads\law\民法典.pdf
2025-10-11 16:57:27.482 [main] INFO  c.r.L.s.DocumentIndexingService - 删除LangChain4j嵌入表中的 0 条记录
2025-10-11 16:57:27.547 [main] INFO  c.r.L.s.DocumentIndexingService - 删除文档记录: 民法典.pdf (ID: 11)
2025-10-11 16:57:28.802 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 1263 个片段
2025-10-11 16:57:43.503 [main] INFO  c.r.L.s.DocumentIndexingService - 文档索引完成: F:\LegalAssistant\uploads\law\民法典.pdf, 片段数: 972, 耗时: 16187ms
2025-10-11 16:57:43.504 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - 索引结果: success=true, segmentCount=972, duration=16187ms, message=null
2025-10-11 16:57:43.504 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - 
步骤2: 验证LangChain4j嵌入表数据...
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - LangChain4j嵌入表中的民法典片段示例（前10个）：
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十一章保管合同, 节: 未知, 条: 第八百八十八条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十章技术合同, 节: 第四节技术咨询合同和技术服务合同, 条: 第八百八十二条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十一章保管合同, 节: 未知, 条: 第八百八十九条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十章技术合同, 节: 第四节技术咨询合同和技术服务合同, 条: 第八百八十六条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十章技术合同, 节: 第四节技术咨询合同和技术服务合同, 条: 第八百八十三条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十章技术合同, 节: 第四节技术咨询合同和技术服务合同, 条: 第八百八十四条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十章技术合同, 节: 第四节技术咨询合同和技术服务合同, 条: 第八百八十条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十章技术合同, 节: 第四节技术咨询合同和技术服务合同, 条: 第八百八十五条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第二十章技术合同, 节: 第四节技术咨询合同和技术服务合同, 条: 第八百八十一条
2025-10-11 16:57:43.511 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 数量: 1, 章节: 第十九章运输合同, 节: 第三节货运合同, 条: 第八百二十八条
2025-10-11 16:57:43.515 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - 
LangChain4j嵌入表中民法典总片段数: 972
2025-10-11 16:57:43.515 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - 
步骤3: 验证vector_store表数据...
2025-10-11 16:57:43.547 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - vector_store表中民法典片段数: 402
2025-10-11 16:57:43.555 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - 
vector_store表中的民法典片段元数据示例：
2025-10-11 16:57:43.556 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   片段 1: {"category": "LAW", "chunk_end": 1990, "file_hash": "14ffcd5353b10d341ad578672ca763511d586d2c73351dc98864922568b6832f", "chunk_index": 0, "chunk_start": 0, "description": "重新处理的文档", "source_type": "knowledge_base_reprocess", "upload_time": "2025-10-11T16:14:39.178678900", "total_chunks": 402, "original_filename": "民法典.pdf"}
2025-10-11 16:57:43.556 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   片段 2: {"category": "LAW", "chunk_end": 2003, "file_hash": "14ffcd5353b10d341ad578672ca763511d586d2c73351dc98864922568b6832f", "chunk_index": 1, "chunk_start": 1590, "description": "重新处理的文档", "source_type": "knowledge_base_reprocess", "upload_time": "2025-10-11T16:14:39.178678900", "total_chunks": 402, "original_filename": "民法典.pdf"}
2025-10-11 16:57:43.556 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   片段 3: {"category": "LAW", "chunk_end": 2003, "file_hash": "14ffcd5353b10d341ad578672ca763511d586d2c73351dc98864922568b6832f", "chunk_index": 168, "chunk_start": 1769, "description": "重新处理的文档", "source_type": "knowledge_base_reprocess", "upload_time": "2025-10-11T16:14:39.178678900", "total_chunks": 402, "original_filename": "民法典.pdf"}
2025-10-11 16:57:43.556 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - 
========== 重新索引完成 ==========
2025-10-11 16:57:43.556 [main] INFO  c.r.LegalAssistant.ReindexCivilCode - 结果摘要：
2025-10-11 16:57:43.556 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 索引成功: true
2025-10-11 16:57:43.556 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 片段数量: 972
2025-10-11 16:57:43.556 [main] INFO  c.r.LegalAssistant.ReindexCivilCode -   - 耗时: 16187ms
2025-10-11 16:57:45.880 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 16:57:45.885 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 17:01:12.844 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 28468 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 17:01:12.846 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 17:01:15.051 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 17:01:15.168 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@231c521e
2025-10-11 17:01:15.209 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 17:01:15.228 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 17:01:15.234 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 17:01:15.309 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 17:01:15.311 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 17:01:15.645 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 17:01:16.976 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 17:01:17.023 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 17:01:17.025 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 17:01:17.048 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 17:01:17.048 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 17:01:17.048 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 17:01:17.049 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 17:01:17.049 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 17:01:17.049 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 17:01:17.049 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 17:01:17.365 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 17:01:17.393 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 17:01:17.395 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 17:01:17.398 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 17:01:17.399 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 17:01:17.399 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 17:01:17.436 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 17:01:17.610 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 17:01:17.613 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 17:01:17.613 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 17:01:17.613 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 17:01:17.627 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 17:01:17.628 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 17:01:17.688 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 17:01:17.939 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 17:01:17.948 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 17:01:17.949 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 17:01:17.949 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 17:01:17.949 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 17:01:17.955 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 17:01:17.956 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 17:01:17.979 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 17:01:17.979 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 17:01:17.979 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 17:01:17.980 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 17:01:17.980 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 17:01:17.980 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 17:01:17.980 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 17:01:17.991 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 17:01:17.999 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 17:01:18.011 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 17:01:18.011 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 17:01:18.022 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 17:01:18.022 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 17:01:18.024 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 17:01:18.024 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 17:01:18.025 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 17:01:18.025 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 17:01:18.081 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 17:01:18.431 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 17:01:18.503 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 17:01:18.504 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 17:01:18.504 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 17:01:18.504 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 17:01:18.504 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 17:01:18.511 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 17:01:18.513 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 17:01:18.592 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 17:01:18.618 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 17:01:18.641 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 17:01:18.643 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 17:01:18.664 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 17:01:18.666 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 17:01:18.785 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 17:01:19.002 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 17:01:19.287 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 17:01:19.426 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 17:01:20.198 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 7.739 seconds (process running for 8.004)
2025-10-11 17:01:23.660 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=8
2025-10-11 17:01:23.679 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f24ea2c2, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=77ms
2025-10-11 17:01:30.027 [http-nio-8080-exec-8] INFO  c.r.L.c.VectorIndexController - 管理员请求重建知识库索引
2025-10-11 17:01:30.028 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 开始重建知识库索引...
2025-10-11 17:01:30.034 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 清空向量存储功能需要根据具体的VectorStore实现来完成
2025-10-11 17:01:30.038 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b650028b, method=POST, uri=/api/v1/vector-index/rebuild, status=200, duration=15ms
2025-10-11 17:01:30.048 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 拍卖法.pdf (ID: 19)
2025-10-11 17:01:30.049 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 环境保护法.pdf (ID: 6)
2025-10-11 17:01:30.049 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 刑法.pdf (ID: 7)
2025-10-11 17:01:30.050 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 劳动法.pdf (ID: 8)
2025-10-11 17:01:30.050 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 社会保险法.pdf (ID: 20)
2025-10-11 17:01:30.051 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 民法典.pdf (ID: 27)
2025-10-11 17:01:30.051 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 民事诉讼法.pdf (ID: 21)
2025-10-11 17:01:30.051 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 宪法.pdf (ID: 9)
2025-10-11 17:01:30.052 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 知识库索引重建完成，共处理 8 个文档
2025-10-11 17:01:41.664 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 17:01:41.668 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 17:09:12.190 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 41268 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 17:09:12.191 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 17:09:14.419 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 17:09:14.540 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@2686a801
2025-10-11 17:09:14.583 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 17:09:14.604 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 17:09:14.610 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 17:09:14.685 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 17:09:14.687 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 17:09:15.017 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 17:09:16.396 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 17:09:16.449 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 17:09:16.452 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 17:09:16.476 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 17:09:16.477 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 17:09:16.477 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 17:09:16.477 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 17:09:16.477 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 17:09:16.477 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 17:09:16.477 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 17:09:16.810 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 17:09:16.840 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 17:09:16.842 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 17:09:16.846 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 17:09:16.847 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 17:09:16.848 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 17:09:16.883 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 17:09:17.047 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 17:09:17.049 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 17:09:17.049 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 17:09:17.050 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 17:09:17.062 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 17:09:17.062 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 17:09:17.122 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 17:09:17.363 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 17:09:17.370 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 17:09:17.372 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 17:09:17.372 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 17:09:17.372 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 17:09:17.378 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 17:09:17.378 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 17:09:17.401 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 17:09:17.401 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 17:09:17.401 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 17:09:17.402 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 17:09:17.402 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 17:09:17.402 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 17:09:17.402 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 17:09:17.422 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 17:09:17.430 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 17:09:17.442 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 17:09:17.442 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 17:09:17.452 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 17:09:17.453 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 17:09:17.455 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 17:09:17.455 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 17:09:17.457 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 17:09:17.457 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 17:09:17.505 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 17:09:17.877 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 17:09:17.977 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 17:09:17.977 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 17:09:17.977 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 17:09:17.977 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 17:09:17.978 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 17:09:17.984 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 17:09:17.986 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 17:09:18.057 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 17:09:18.085 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 17:09:18.114 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 17:09:18.116 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 17:09:18.140 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 17:09:18.142 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 17:09:18.265 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 17:09:18.477 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 17:09:18.838 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 17:09:19.088 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 17:09:19.889 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.131 seconds (process running for 8.419)
2025-10-11 17:09:22.802 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=0
2025-10-11 17:09:22.823 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6bf5226c, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=69ms
2025-10-11 17:09:37.755 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 环境保护法.pdf
2025-10-11 17:09:37.770 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 环境保护法.pdf, 大小: 216419 bytes
2025-10-11 17:09:37.770 [http-nio-8080-exec-2] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 环境保护法.pdf, 类型: pdf, 大小: 216419 bytes
2025-10-11 17:09:38.117 [http-nio-8080-exec-2] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 环境保护法.pdf, 内容长度: 8554 字符
2025-10-11 17:09:38.123 [http-nio-8080-exec-2] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 17:09:38.124 [http-nio-8080-exec-2] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 0 个片段
2025-10-11 17:09:38.125 [http-nio-8080-exec-2] WARN  c.r.L.s.DocumentProcessingService - 分割后无有效片段
2025-10-11 17:09:38.126 [http-nio-8080-exec-2] ERROR c.r.L.service.KnowledgeBaseService - 文档处理失败: 分割后无有效片段
2025-10-11 17:09:38.146 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=fe79661e, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=417ms
2025-10-11 17:09:38.206 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=0
2025-10-11 17:09:38.209 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f5dbc61f, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=13ms
2025-10-11 17:09:48.159 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 17:09:48.163 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 17:18:42.889 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 39128 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 17:18:42.892 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 17:18:45.667 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 17:18:45.835 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@1be3a294
2025-10-11 17:18:45.909 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 17:18:45.932 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 17:18:45.939 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 17:18:46.067 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 17:18:46.070 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 17:18:46.540 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 17:18:48.132 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 17:18:48.188 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 17:18:48.193 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 17:18:48.216 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 17:18:48.217 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 17:18:48.217 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 17:18:48.217 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 17:18:48.217 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 17:18:48.217 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 17:18:48.218 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 17:18:48.588 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 17:18:48.618 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 17:18:48.619 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 17:18:48.624 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 17:18:48.625 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 17:18:48.626 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 17:18:48.658 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 17:18:48.849 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 17:18:48.852 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 17:18:48.852 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 17:18:48.853 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 17:18:48.868 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 17:18:48.868 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 17:18:48.947 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 17:18:49.270 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 17:18:49.278 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 17:18:49.279 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 17:18:49.280 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 17:18:49.280 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 17:18:49.287 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 17:18:49.288 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 17:18:49.314 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 17:18:49.314 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 17:18:49.315 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 17:18:49.315 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 17:18:49.315 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 17:18:49.315 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 17:18:49.316 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 17:18:49.329 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 17:18:49.336 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 17:18:49.349 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 17:18:49.349 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 17:18:49.359 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 17:18:49.359 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 17:18:49.362 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 17:18:49.363 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 17:18:49.364 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 17:18:49.365 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 17:18:49.422 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 17:18:49.889 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 17:18:49.991 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 17:18:49.991 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 17:18:49.991 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 17:18:49.991 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 17:18:49.992 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 17:18:49.998 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 17:18:50.001 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 17:18:50.087 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 17:18:50.121 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 17:18:50.149 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 17:18:50.152 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 17:18:50.184 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 17:18:50.185 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 17:18:50.320 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 17:18:50.554 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 17:18:50.868 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 17:18:51.030 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 17:18:52.014 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.604 seconds (process running for 9.918)
2025-10-11 17:21:28.222 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=0
2025-10-11 17:21:28.241 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=154db83f, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=70ms
2025-10-11 17:21:35.446 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 环境保护法.pdf
2025-10-11 17:21:35.463 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 环境保护法.pdf, 大小: 216419 bytes
2025-10-11 17:21:35.463 [http-nio-8080-exec-2] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 环境保护法.pdf, 类型: pdf, 大小: 216419 bytes
2025-10-11 17:21:35.864 [http-nio-8080-exec-2] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 环境保护法.pdf, 内容长度: 8554 字符
2025-10-11 17:21:35.870 [http-nio-8080-exec-2] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 17:21:35.872 [http-nio-8080-exec-2] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 17:21:35.875 [http-nio-8080-exec-2] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 17:21:38.153 [http-nio-8080-exec-2] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 60, 存储数: 60, 耗时: 2283ms
2025-10-11 17:21:38.200 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：环境保护法.pdf
2025-10-11 17:21:38.200 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 环境保护法.pdf, 文档ID: 1, 块数: 60, 分割器: LegalDocumentSplitter
2025-10-11 17:21:38.210 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=d13d0cc3, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=2790ms
2025-10-11 17:21:38.265 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 17:21:38.275 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=26549e62, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=22ms
2025-10-11 17:23:52.226 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 17:23:52.229 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 17:45:00.778 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 35056 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 17:45:00.779 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 17:45:03.346 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 17:45:03.468 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@263f6e96
2025-10-11 17:45:03.517 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 17:45:03.538 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 17:45:03.544 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 17:45:03.627 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 17:45:03.629 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 17:45:04.011 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 17:45:05.533 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 17:45:05.595 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 17:45:05.599 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 17:45:05.629 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 17:45:05.630 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 17:45:05.630 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 17:45:05.630 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 17:45:05.630 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 17:45:05.630 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 17:45:05.630 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 17:45:06.028 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 17:45:06.066 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 17:45:06.068 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 17:45:06.073 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 17:45:06.075 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 17:45:06.076 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 17:45:06.122 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 17:45:06.321 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 17:45:06.323 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 17:45:06.325 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 17:45:06.325 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 17:45:06.338 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 17:45:06.339 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 17:45:06.402 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 17:45:06.671 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 17:45:06.678 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 17:45:06.680 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 17:45:06.680 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 17:45:06.680 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 17:45:06.687 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 17:45:06.687 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 17:45:06.710 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 17:45:06.710 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 17:45:06.710 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 17:45:06.711 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 17:45:06.711 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 17:45:06.711 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 17:45:06.711 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 17:45:06.723 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 17:45:06.731 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 17:45:06.745 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 17:45:06.746 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 17:45:06.763 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 17:45:06.763 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 17:45:06.765 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 17:45:06.765 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 17:45:06.766 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 17:45:06.767 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 17:45:06.817 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 17:45:07.231 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 17:45:07.315 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 17:45:07.315 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 17:45:07.315 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 17:45:07.315 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 17:45:07.316 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 17:45:07.323 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 17:45:07.325 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 17:45:07.403 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 17:45:07.431 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 17:45:07.456 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 17:45:07.459 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 17:45:07.480 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 17:45:07.482 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 17:45:07.602 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 17:45:07.811 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 17:45:08.233 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 17:45:08.556 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 17:45:10.151 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.808 seconds (process running for 10.089)
2025-10-11 17:45:20.765 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 17:45:20.784 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4213458e, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=76ms
2025-10-11 17:45:27.629 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 1
2025-10-11 17:45:27.629 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 1
2025-10-11 17:45:27.634 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0b18b02a, method=POST, uri=/api/v1/knowledge-base/documents/1/reprocess, status=200, duration=15ms
2025-10-11 17:45:27.649 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 环境保护法.pdf, 开始重新处理
2025-10-11 17:45:27.673 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 未找到需要删除的向量数据: uploads/环境保护法.pdf
2025-10-11 17:45:27.673 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 删除文档旧的向量数据: uploads/环境保护法.pdf
2025-10-11 17:45:27.674 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 2003 字符
2025-10-11 17:45:27.678 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 17:45:27.679 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 19 个片段
2025-10-11 17:45:29.143 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 19, 存储数: 19, 耗时: 1469ms
2025-10-11 17:45:29.175 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 环境保护法.pdf, 新的块数: 19, 分割器: LegalDocumentSplitter
2025-10-11 17:45:29.671 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 17:45:29.672 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b2bc3ab7, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=6ms
2025-10-11 17:45:54.266 [http-nio-8080-exec-4] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 环境保护法.pdf
2025-10-11 17:45:54.281 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 环境保护法.pdf, 大小: 216419 bytes
2025-10-11 17:45:54.281 [http-nio-8080-exec-4] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 环境保护法.pdf, 类型: pdf, 大小: 216419 bytes
2025-10-11 17:45:54.569 [http-nio-8080-exec-4] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 环境保护法.pdf, 内容长度: 8554 字符
2025-10-11 17:45:54.573 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 检测到已存在的文档: 环境保护法.pdf, 将进行更新
2025-10-11 17:45:54.582 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 按fileHash删除向量数据: a2e0b4fa85b8a267, 共删除 79 条记录
2025-10-11 17:45:54.589 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 已删除旧文档数据，准备重新上传: 环境保护法.pdf
2025-10-11 17:45:54.590 [http-nio-8080-exec-4] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 17:45:54.590 [http-nio-8080-exec-4] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 17:45:54.591 [http-nio-8080-exec-4] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 17:45:55.692 [http-nio-8080-exec-4] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 1102ms
2025-10-11 17:45:55.713 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：环境保护法.pdf
2025-10-11 17:45:55.713 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 环境保护法.pdf, 文档ID: 2, 块数: 70, 分割器: LegalDocumentSplitter
2025-10-11 17:45:55.719 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=afd66046, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=1471ms
2025-10-11 17:45:55.757 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 17:45:55.759 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=bd079149, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=10ms
2025-10-11 18:10:53.183 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 18:10:53.188 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 18:11:10.798 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 26368 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 18:11:10.801 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 18:11:13.145 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 18:11:13.299 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@4425b6ed
2025-10-11 18:11:13.353 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 18:11:13.371 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 18:11:13.377 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 18:11:13.457 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 18:11:13.460 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 18:11:13.917 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 18:11:15.417 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 18:11:15.488 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 18:11:15.490 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 18:11:15.514 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 18:11:15.514 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 18:11:15.514 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 18:11:15.514 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 18:11:15.514 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 18:11:15.514 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 18:11:15.514 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 18:11:15.838 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 18:11:15.868 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 18:11:15.871 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 18:11:15.875 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 18:11:15.876 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 18:11:15.878 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 18:11:15.910 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 18:11:16.081 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 18:11:16.083 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 18:11:16.084 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 18:11:16.084 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 18:11:16.096 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 18:11:16.097 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 18:11:16.161 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 18:11:16.466 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 18:11:16.473 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 18:11:16.475 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 18:11:16.475 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 18:11:16.475 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 18:11:16.481 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 18:11:16.481 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 18:11:16.504 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 18:11:16.504 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 18:11:16.505 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 18:11:16.505 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 18:11:16.505 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 18:11:16.505 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 18:11:16.505 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 18:11:16.518 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 18:11:16.526 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 18:11:16.540 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 18:11:16.540 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 18:11:16.556 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 18:11:16.557 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 18:11:16.559 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 18:11:16.559 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 18:11:16.561 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 18:11:16.561 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 18:11:16.623 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 18:11:17.016 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 18:11:17.095 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 18:11:17.095 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 18:11:17.095 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 18:11:17.095 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 18:11:17.096 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 18:11:17.110 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 18:11:17.116 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 18:11:17.204 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 18:11:17.233 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 18:11:17.257 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 18:11:17.260 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 18:11:17.282 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 18:11:17.284 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 18:11:17.426 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 18:11:17.632 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 18:11:17.927 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 18:11:18.067 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 18:11:18.917 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.51 seconds (process running for 8.806)
2025-10-11 18:11:23.019 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:11:23.036 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=bc82f7f5, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=71ms
2025-10-11 18:11:26.440 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 2
2025-10-11 18:11:26.441 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 2
2025-10-11 18:11:26.445 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=a4b644ab, method=POST, uri=/api/v1/knowledge-base/documents/2/reprocess, status=200, duration=16ms
2025-10-11 18:11:26.459 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 环境保护法.pdf, 开始重新处理
2025-10-11 18:11:26.482 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 未找到需要删除的向量数据: uploads/环境保护法.pdf
2025-10-11 18:11:26.482 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 删除文档旧的向量数据: uploads/环境保护法.pdf
2025-10-11 18:11:26.483 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 2)
2025-10-11 18:11:26.483 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 2003 字符
2025-10-11 18:11:26.485 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:11:26.488 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 19 个片段
2025-10-11 18:11:28.084 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 19, 存储数: 19, 耗时: 1601ms
2025-10-11 18:11:28.126 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 环境保护法.pdf, 新的块数: 19, 分割器: LegalDocumentSplitter
2025-10-11 18:11:28.483 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:11:28.485 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=94c9a1da, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=7ms
2025-10-11 18:12:02.273 [http-nio-8080-exec-8] INFO  c.r.L.c.VectorIndexController - 管理员请求重建知识库索引
2025-10-11 18:12:02.273 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 开始重建知识库索引（使用法律文档分割器）...
2025-10-11 18:12:02.275 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 清空向量存储功能需要根据具体的VectorStore实现来完成
2025-10-11 18:12:02.277 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=cbadb0ae, method=POST, uri=/api/v1/vector-index/rebuild, status=200, duration=5ms
2025-10-11 18:12:02.283 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 环境保护法.pdf (ID: 2)
2025-10-11 18:12:02.283 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 2)
2025-10-11 18:12:02.284 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 2003 字符
2025-10-11 18:12:02.284 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:12:02.285 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 19 个片段
2025-10-11 18:12:02.752 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 19, 存储数: 19, 耗时: 468ms
2025-10-11 18:12:02.756 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档索引成功: 环境保护法.pdf, 片段数: 19, 分割器: LegalDocumentSplitter
2025-10-11 18:12:02.757 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 知识库索引重建完成 - 总数: 1, 成功: 1, 失败: 0
2025-10-11 18:12:22.434 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 18:12:22.439 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 18:17:27.357 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 21084 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 18:17:27.358 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 18:17:29.685 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 18:17:29.828 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@231c521e
2025-10-11 18:17:29.872 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 18:17:29.893 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 18:17:29.900 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 18:17:29.979 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 18:17:29.981 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 18:17:30.307 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 18:17:31.701 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 18:17:31.750 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 18:17:31.752 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 18:17:31.778 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 18:17:31.778 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 18:17:31.778 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 18:17:31.778 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 18:17:31.778 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 18:17:31.778 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 18:17:31.779 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 18:17:32.111 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 18:17:32.141 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 18:17:32.144 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 18:17:32.148 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 18:17:32.149 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 18:17:32.149 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 18:17:32.183 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 18:17:32.362 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 18:17:32.365 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 18:17:32.365 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 18:17:32.365 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 18:17:32.377 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 18:17:32.378 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 18:17:32.439 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 18:17:32.685 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 18:17:32.692 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 18:17:32.693 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 18:17:32.693 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 18:17:32.693 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 18:17:32.699 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 18:17:32.699 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 18:17:32.722 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 18:17:32.722 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 18:17:32.722 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 18:17:32.723 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 18:17:32.723 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 18:17:32.723 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 18:17:32.723 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 18:17:32.736 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 18:17:32.744 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 18:17:32.756 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 18:17:32.756 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 18:17:32.777 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 18:17:32.777 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 18:17:32.780 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 18:17:32.780 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 18:17:32.782 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 18:17:32.782 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 18:17:32.833 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 18:17:33.205 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 18:17:33.312 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 18:17:33.313 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 18:17:33.313 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 18:17:33.313 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 18:17:33.314 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 18:17:33.321 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 18:17:33.323 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 18:17:33.400 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 18:17:33.428 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 18:17:33.454 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 18:17:33.456 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 18:17:33.479 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 18:17:33.480 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 18:17:33.606 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 18:17:33.807 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 18:17:34.199 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 18:17:34.424 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 18:17:35.262 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.307 seconds (process running for 8.611)
2025-10-11 18:17:40.015 [http-nio-8080-exec-1] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 2
2025-10-11 18:17:40.015 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 2
2025-10-11 18:17:40.035 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 环境保护法.pdf, 开始重新处理
2025-10-11 18:17:40.035 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=a7d71d62, method=POST, uri=/api/v1/knowledge-base/documents/2/reprocess, status=200, duration=50ms
2025-10-11 18:17:40.043 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 按doc_id删除文档旧的向量数据成功: 38 条记录
2025-10-11 18:17:40.043 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 2)
2025-10-11 18:17:40.044 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 2003 字符
2025-10-11 18:17:40.045 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:17:40.046 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 19 个片段
2025-10-11 18:17:41.115 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 19, 存储数: 19, 耗时: 1071ms
2025-10-11 18:17:41.143 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 环境保护法.pdf, 新的块数: 19, 分割器: LegalDocumentSplitter
2025-10-11 18:17:42.666 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:17:42.673 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=8678f197, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=25ms
2025-10-11 18:17:52.702 [http-nio-8080-exec-3] INFO  c.r.L.c.VectorIndexController - 管理员请求重建知识库索引
2025-10-11 18:17:52.703 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 开始重建知识库索引（使用法律文档分割器）...
2025-10-11 18:17:52.703 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 清空向量存储功能需要根据具体的VectorStore实现来完成
2025-10-11 18:17:52.705 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=c2108759, method=POST, uri=/api/v1/vector-index/rebuild, status=200, duration=4ms
2025-10-11 18:17:52.709 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 环境保护法.pdf (ID: 2)
2025-10-11 18:17:52.721 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 2)
2025-10-11 18:17:52.721 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 2003 字符
2025-10-11 18:17:52.721 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:17:52.722 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 19 个片段
2025-10-11 18:17:53.118 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 19, 存储数: 19, 耗时: 397ms
2025-10-11 18:17:53.122 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档索引成功: 环境保护法.pdf, 片段数: 19, 分割器: LegalDocumentSplitter
2025-10-11 18:17:53.122 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 知识库索引重建完成 - 总数: 1, 成功: 1, 失败: 0
2025-10-11 18:18:25.803 [http-nio-8080-exec-4] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 环境保护法.pdf
2025-10-11 18:18:25.816 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 环境保护法.pdf, 大小: 216419 bytes
2025-10-11 18:18:25.816 [http-nio-8080-exec-4] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 环境保护法.pdf, 类型: pdf, 大小: 216419 bytes
2025-10-11 18:18:26.040 [http-nio-8080-exec-4] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 环境保护法.pdf, 内容长度: 8554 字符
2025-10-11 18:18:26.044 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 检测到已存在的文档: 环境保护法.pdf, 将进行更新
2025-10-11 18:18:26.060 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 按fileHash删除向量数据: a2e0b4fa85b8a267, 共删除 89 条记录
2025-10-11 18:18:26.068 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 已删除旧文档数据，准备重新上传: 环境保护法.pdf
2025-10-11 18:18:26.068 [http-nio-8080-exec-4] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:18:26.068 [http-nio-8080-exec-4] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:18:26.069 [http-nio-8080-exec-4] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:18:27.054 [http-nio-8080-exec-4] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 986ms
2025-10-11 18:18:27.070 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：环境保护法.pdf
2025-10-11 18:18:27.070 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 环境保护法.pdf, 文档ID: 3, 块数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:18:27.076 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=09b6405c, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=1288ms
2025-10-11 18:18:27.131 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:18:27.136 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f06b6908, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=24ms
2025-10-11 18:18:42.437 [http-nio-8080-exec-6] INFO  c.r.L.c.VectorIndexController - 管理员请求重建知识库索引
2025-10-11 18:18:42.438 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 开始重建知识库索引（使用法律文档分割器）...
2025-10-11 18:18:42.438 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 清空向量存储功能需要根据具体的VectorStore实现来完成
2025-10-11 18:18:42.439 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=e4767ebd, method=POST, uri=/api/v1/vector-index/rebuild, status=200, duration=3ms
2025-10-11 18:18:42.444 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 环境保护法.pdf (ID: 3)
2025-10-11 18:18:42.447 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 3)
2025-10-11 18:18:42.448 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:18:42.448 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:18:42.450 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:18:43.678 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 1230ms
2025-10-11 18:18:43.684 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档索引成功: 环境保护法.pdf, 片段数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:18:43.684 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 知识库索引重建完成 - 总数: 1, 成功: 1, 失败: 0
2025-10-11 18:19:07.235 [http-nio-8080-exec-7] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 3
2025-10-11 18:19:07.236 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 3
2025-10-11 18:19:07.239 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3d013956, method=POST, uri=/api/v1/knowledge-base/documents/3/reprocess, status=200, duration=4ms
2025-10-11 18:19:07.241 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 环境保护法.pdf, 开始重新处理
2025-10-11 18:19:07.256 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 按doc_id删除文档旧的向量数据成功: 70 条记录
2025-10-11 18:19:07.257 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 3)
2025-10-11 18:19:07.257 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:19:07.258 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:19:07.259 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:19:08.228 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 971ms
2025-10-11 18:19:08.233 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 环境保护法.pdf, 新的块数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:19:09.594 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:19:09.596 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0b3ef968, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=8ms
2025-10-11 18:19:27.112 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 18:19:27.116 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 18:26:40.092 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 7428 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 18:26:40.094 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 18:26:42.521 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 18:26:42.654 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@5af1b221
2025-10-11 18:26:42.707 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 18:26:42.725 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 18:26:42.731 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 18:26:42.808 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 18:26:42.810 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 18:26:43.222 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 18:26:44.783 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 18:26:44.834 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 18:26:44.837 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 18:26:44.868 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 18:26:44.868 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 18:26:44.868 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 18:26:44.869 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 18:26:44.869 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 18:26:44.869 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 18:26:44.869 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 18:26:45.203 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 18:26:45.236 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 18:26:45.238 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 18:26:45.243 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 18:26:45.245 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 18:26:45.245 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 18:26:45.282 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 18:26:45.488 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 18:26:45.493 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 18:26:45.493 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 18:26:45.493 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 18:26:45.522 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 18:26:45.523 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 18:26:45.621 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 18:26:45.991 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 18:26:46.001 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 18:26:46.003 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 18:26:46.003 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 18:26:46.003 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 18:26:46.009 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 18:26:46.010 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 18:26:46.033 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 18:26:46.034 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 18:26:46.034 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 18:26:46.035 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 18:26:46.035 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 18:26:46.035 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 18:26:46.035 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 18:26:46.046 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 18:26:46.055 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 18:26:46.069 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 18:26:46.069 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 18:26:46.080 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 18:26:46.081 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 18:26:46.084 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 18:26:46.084 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 18:26:46.086 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 18:26:46.086 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 18:26:46.163 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 18:26:46.627 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 18:26:46.771 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 18:26:46.772 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 18:26:46.772 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 18:26:46.772 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 18:26:46.772 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 18:26:46.786 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 18:26:46.791 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 18:26:46.893 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 18:26:46.929 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 18:26:46.956 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 18:26:46.958 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 18:26:46.982 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 18:26:46.983 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 18:26:47.105 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 18:26:47.319 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 18:26:47.594 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 18:26:47.761 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 18:26:48.606 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.909 seconds (process running for 9.174)
2025-10-11 18:27:06.032 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:27:06.051 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=808b41ec, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=72ms
2025-10-11 18:27:19.667 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员删除单个文档: 3
2025-10-11 18:27:19.668 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始删除文档: 3
2025-10-11 18:27:19.699 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 成功删除向量数据: uploads/环境保护法.pdf, 共删除 70 条记录 (LangChain4j: 70, SpringAI: 0)
2025-10-11 18:27:19.739 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 文档删除成功: 环境保护法.pdf (ID: 3)
2025-10-11 18:27:19.757 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=848ecb40, method=DELETE, uri=/api/v1/knowledge-base/documents/3, status=200, duration=97ms
2025-10-11 18:27:19.787 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=0
2025-10-11 18:27:19.789 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=e8685cff, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=6ms
2025-10-11 18:27:56.952 [http-nio-8080-exec-4] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 环境保护法.pdf
2025-10-11 18:27:56.965 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 环境保护法.pdf, 大小: 216419 bytes
2025-10-11 18:27:56.965 [http-nio-8080-exec-4] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 环境保护法.pdf, 类型: pdf, 大小: 216419 bytes
2025-10-11 18:27:57.201 [http-nio-8080-exec-4] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 环境保护法.pdf, 内容长度: 8554 字符
2025-10-11 18:27:57.204 [http-nio-8080-exec-4] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:27:57.206 [http-nio-8080-exec-4] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:27:57.208 [http-nio-8080-exec-4] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:27:59.096 [http-nio-8080-exec-4] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 1891ms
2025-10-11 18:27:59.114 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：环境保护法.pdf
2025-10-11 18:27:59.115 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 环境保护法.pdf, 文档ID: 4, 块数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:27:59.119 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=7371fe8a, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=2182ms
2025-10-11 18:27:59.156 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:27:59.157 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b65be86e, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=5ms
2025-10-11 18:28:33.684 [http-nio-8080-exec-6] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 4
2025-10-11 18:28:33.685 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 4
2025-10-11 18:28:33.689 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=209532a5, method=POST, uri=/api/v1/knowledge-base/documents/4/reprocess, status=200, duration=7ms
2025-10-11 18:28:33.694 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 环境保护法.pdf, 开始重新处理
2025-10-11 18:28:33.701 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.service.KnowledgeBaseService - 未找到需要删除的向量数据: uploads/环境保护法.pdf
2025-10-11 18:28:33.701 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 按sourceFile删除文档旧的向量数据: uploads/环境保护法.pdf
2025-10-11 18:28:33.701 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 4)
2025-10-11 18:28:33.702 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:28:33.702 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:28:33.706 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:28:35.039 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 1337ms
2025-10-11 18:28:35.055 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 环境保护法.pdf, 新的块数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:28:36.656 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:28:36.658 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=e6f076e1, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=6ms
2025-10-11 18:28:45.408 [http-nio-8080-exec-8] INFO  c.r.L.c.VectorIndexController - 管理员请求重建知识库索引
2025-10-11 18:28:45.409 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 开始重建知识库索引（使用法律文档分割器）...
2025-10-11 18:28:45.409 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 开始清空向量存储...
2025-10-11 18:28:45.410 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=e8c627f8, method=POST, uri=/api/v1/vector-index/rebuild, status=200, duration=6ms
2025-10-11 18:28:45.421 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 从langchain4j_embeddings删除 140 条记录
2025-10-11 18:28:45.423 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 从vector_store删除 0 条记录
2025-10-11 18:28:45.423 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 向量存储清空完成，共删除 140 条记录
2025-10-11 18:28:45.431 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 环境保护法.pdf (ID: 4)
2025-10-11 18:28:45.431 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 4)
2025-10-11 18:28:45.432 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:28:45.433 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:28:45.435 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:28:46.831 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 1399ms
2025-10-11 18:28:46.838 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档索引成功: 环境保护法.pdf, 片段数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:28:46.838 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 知识库索引重建完成 - 总数: 1, 成功: 1, 失败: 0
2025-10-11 18:29:03.278 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 18:29:03.282 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 18:32:01.984 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 3040 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 18:32:01.986 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 18:32:04.344 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 18:32:04.467 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@2487b621
2025-10-11 18:32:04.512 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 18:32:04.532 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 18:32:04.538 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 18:32:04.625 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 18:32:04.627 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 18:32:05.067 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 18:32:06.516 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 18:32:06.569 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 18:32:06.571 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 18:32:06.598 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 18:32:06.598 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 18:32:06.598 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 18:32:06.598 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 18:32:06.598 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 18:32:06.598 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 18:32:06.599 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 18:32:06.923 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 18:32:06.950 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 18:32:06.952 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 18:32:06.956 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 18:32:06.957 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 18:32:06.958 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 18:32:06.988 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 18:32:07.185 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 18:32:07.188 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 18:32:07.188 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 18:32:07.188 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 18:32:07.201 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 18:32:07.202 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 18:32:07.268 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 18:32:07.552 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 18:32:07.561 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 18:32:07.562 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 18:32:07.562 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 18:32:07.563 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 18:32:07.570 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 18:32:07.570 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 18:32:07.598 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 18:32:07.599 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 18:32:07.599 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 18:32:07.599 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 18:32:07.599 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 18:32:07.599 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 18:32:07.599 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 18:32:07.613 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 18:32:07.625 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 18:32:07.641 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 18:32:07.642 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 18:32:07.655 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 18:32:07.655 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 18:32:07.657 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 18:32:07.657 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 18:32:07.660 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 18:32:07.660 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 18:32:07.720 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 18:32:08.134 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 18:32:08.219 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 18:32:08.219 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 18:32:08.219 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 18:32:08.219 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 18:32:08.220 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 18:32:08.227 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 18:32:08.230 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 18:32:08.305 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 18:32:08.340 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 18:32:08.368 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 18:32:08.371 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 18:32:08.396 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 18:32:08.397 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 18:32:08.520 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 18:32:08.766 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 18:32:09.097 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 18:32:09.262 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 18:32:10.129 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.525 seconds (process running for 8.816)
2025-10-11 18:32:15.992 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:32:16.009 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4caae3e6, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=71ms
2025-10-11 18:32:17.341 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员删除单个文档: 4
2025-10-11 18:32:17.343 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始删除文档: 4
2025-10-11 18:32:17.372 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 成功删除向量数据: uploads/环境保护法.pdf, 共删除 70 条记录 (LangChain4j: 70, SpringAI: 0)
2025-10-11 18:32:17.421 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 文档删除成功: 环境保护法.pdf (ID: 4)
2025-10-11 18:32:17.445 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=aa1fb036, method=DELETE, uri=/api/v1/knowledge-base/documents/4, status=200, duration=111ms
2025-10-11 18:32:17.500 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=0
2025-10-11 18:32:17.504 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ae4e8c08, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=12ms
2025-10-11 18:32:31.729 [http-nio-8080-exec-7] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 环境保护法.pdf
2025-10-11 18:32:31.741 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 环境保护法.pdf, 大小: 216419 bytes
2025-10-11 18:32:31.741 [http-nio-8080-exec-7] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 环境保护法.pdf, 类型: pdf, 大小: 216419 bytes
2025-10-11 18:32:31.964 [http-nio-8080-exec-7] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 环境保护法.pdf, 内容长度: 8554 字符
2025-10-11 18:32:31.967 [http-nio-8080-exec-7] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:32:31.968 [http-nio-8080-exec-7] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:32:31.971 [http-nio-8080-exec-7] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:32:33.120 [http-nio-8080-exec-7] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 1153ms
2025-10-11 18:32:33.141 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：环境保护法.pdf
2025-10-11 18:32:33.141 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 环境保护法.pdf, 文档ID: 5, 块数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:32:33.147 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=26f5096b, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=1435ms
2025-10-11 18:32:33.188 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:32:33.189 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=60cbca4b, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=6ms
2025-10-11 18:32:47.055 [http-nio-8080-exec-3] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 5
2025-10-11 18:32:47.056 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 5
2025-10-11 18:32:47.071 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 获取到 110 个向量块
2025-10-11 18:32:47.100 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=167d3915, method=GET, uri=/api/v1/knowledge-base/documents/5/chunks, status=200, duration=50ms
2025-10-11 18:32:56.407 [http-nio-8080-exec-5] INFO  c.r.L.c.VectorIndexController - 管理员请求重建知识库索引
2025-10-11 18:32:56.407 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 开始重建知识库索引（使用法律文档分割器）...
2025-10-11 18:32:56.411 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 开始清空向量存储...
2025-10-11 18:32:56.412 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=aa444c5c, method=POST, uri=/api/v1/vector-index/rebuild, status=200, duration=6ms
2025-10-11 18:32:56.421 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 从langchain4j_embeddings删除 70 条记录
2025-10-11 18:32:56.423 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 从vector_store删除 0 条记录
2025-10-11 18:32:56.423 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 向量存储清空完成，共删除 70 条记录
2025-10-11 18:32:56.432 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 重新索引文档: 环境保护法.pdf (ID: 5)
2025-10-11 18:32:56.433 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 5)
2025-10-11 18:32:56.433 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:32:56.433 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:32:56.436 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:32:57.765 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 1332ms
2025-10-11 18:32:57.780 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档索引成功: 环境保护法.pdf, 片段数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:32:57.781 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 知识库索引重建完成 - 总数: 1, 成功: 1, 失败: 0
2025-10-11 18:33:07.495 [http-nio-8080-exec-8] INFO  c.r.L.c.KnowledgeBaseController - 管理员请求重新处理文档: 5
2025-10-11 18:33:07.496 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 开始重新处理文档: 5
2025-10-11 18:33:07.499 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=43808154, method=POST, uri=/api/v1/knowledge-base/documents/5/reprocess, status=200, duration=7ms
2025-10-11 18:33:07.503 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 找到文档: 环境保护法.pdf, 开始重新处理
2025-10-11 18:33:07.508 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 检查doc_id 5 的向量数据数量: 70
2025-10-11 18:33:07.519 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 从langchain4j_embeddings按doc_id删除 70 条记录
2025-10-11 18:33:07.520 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 按doc_id删除文档旧的向量数据成功: 70 条记录
2025-10-11 18:33:07.521 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 处理知识库文档: 环境保护法.pdf (ID: 5)
2025-10-11 18:33:07.522 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8554 字符
2025-10-11 18:33:07.522 [ForkJoinPool.commonPool-worker-1] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:33:07.524 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 70 个片段
2025-10-11 18:33:08.935 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 70, 存储数: 70, 耗时: 1413ms
2025-10-11 18:33:08.941 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.KnowledgeBaseService - 文档重新处理成功: 环境保护法.pdf, 新的块数: 70, 分割器: LegalDocumentSplitter
2025-10-11 18:33:09.656 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:33:09.658 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=aa6924be, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=5ms
2025-10-11 18:33:15.816 [http-nio-8080-exec-10] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 5
2025-10-11 18:33:15.818 [http-nio-8080-exec-10] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 5
2025-10-11 18:33:15.828 [http-nio-8080-exec-10] INFO  c.r.L.service.KnowledgeBaseService - 获取到 110 个向量块
2025-10-11 18:33:15.837 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0cf8b361, method=GET, uri=/api/v1/knowledge-base/documents/5/chunks, status=200, duration=23ms
2025-10-11 18:34:20.684 [http-nio-8080-exec-1] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 5
2025-10-11 18:34:20.684 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 5
2025-10-11 18:34:20.690 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 获取到 110 个向量块
2025-10-11 18:34:20.697 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=72c78822, method=GET, uri=/api/v1/knowledge-base/documents/5/chunks, status=200, duration=14ms
2025-10-11 18:35:56.793 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 5
2025-10-11 18:35:56.795 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 5
2025-10-11 18:35:56.804 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 获取到 110 个向量块
2025-10-11 18:35:56.811 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=60c3c2fe, method=GET, uri=/api/v1/knowledge-base/documents/5/chunks, status=200, duration=19ms
2025-10-11 18:36:04.896 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 18:36:04.900 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 18:36:19.635 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 20892 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 18:36:19.637 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 18:36:21.919 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 18:36:22.032 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@252d2ac0
2025-10-11 18:36:22.074 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 18:36:22.091 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 18:36:22.097 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 18:36:22.175 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 18:36:22.176 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 18:36:22.504 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 18:36:23.939 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 18:36:23.992 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 18:36:23.994 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 18:36:24.018 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 18:36:24.018 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 18:36:24.018 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 18:36:24.018 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 18:36:24.018 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 18:36:24.018 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 18:36:24.018 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 18:36:24.363 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 18:36:24.390 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 18:36:24.396 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 18:36:24.400 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 18:36:24.401 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 18:36:24.402 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 18:36:24.432 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 18:36:24.615 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 18:36:24.617 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 18:36:24.618 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 18:36:24.618 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 18:36:24.634 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 18:36:24.634 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 18:36:24.697 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 18:36:24.949 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 18:36:24.956 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 18:36:24.958 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 18:36:24.958 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 18:36:24.958 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 18:36:24.963 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 18:36:24.964 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 18:36:24.987 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 18:36:24.987 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 18:36:24.987 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 18:36:24.987 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 18:36:24.987 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 18:36:24.988 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 18:36:24.988 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 18:36:25.000 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 18:36:25.008 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 18:36:25.020 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 18:36:25.020 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 18:36:25.032 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 18:36:25.032 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 18:36:25.034 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 18:36:25.035 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 18:36:25.036 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 18:36:25.036 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 18:36:25.092 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 18:36:25.476 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 18:36:25.553 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 18:36:25.553 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 18:36:25.553 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 18:36:25.553 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 18:36:25.554 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 18:36:25.560 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 18:36:25.562 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 18:36:25.648 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 18:36:25.691 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 18:36:25.715 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 18:36:25.717 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 18:36:25.742 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 18:36:25.743 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 18:36:25.875 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 18:36:26.082 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 18:36:26.387 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 18:36:26.545 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 18:36:27.434 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.205 seconds (process running for 8.519)
2025-10-11 18:36:28.734 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:36:28.753 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6ff9e3c0, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=73ms
2025-10-11 18:36:29.561 [http-nio-8080-exec-3] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 5
2025-10-11 18:36:29.561 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 5
2025-10-11 18:36:29.578 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从向量存储中获取文档向量块: 5
2025-10-11 18:36:29.630 [http-nio-8080-exec-3] WARN  c.r.L.service.KnowledgeBaseService - 通过doc_id查询向量块失败: PreparedStatementCallback; bad SQL grammar [SELECT content, metadata, embedding
FROM langchain4j_embeddings
WHERE metadata->>'doc_id' = ?
ORDER BY CAST(metadata->>'chunk_index' AS INTEGER)
]
2025-10-11 18:36:29.633 [http-nio-8080-exec-3] WARN  c.r.L.service.KnowledgeBaseService - 通过文件名查询向量块失败: PreparedStatementCallback; bad SQL grammar [SELECT content, metadata, embedding
FROM langchain4j_embeddings
WHERE metadata->>'original_filename' = ?
ORDER BY CAST(metadata->>'chunk_index' AS INTEGER)
]
2025-10-11 18:36:29.634 [http-nio-8080-exec-3] WARN  c.r.L.service.KnowledgeBaseService - 通过sourceFile查询向量块失败: PreparedStatementCallback; bad SQL grammar [SELECT content, metadata, embedding
FROM langchain4j_embeddings
WHERE metadata->>'source_file' = ?
ORDER BY CAST(metadata->>'chunk_index' AS INTEGER)
]
2025-10-11 18:36:29.634 [http-nio-8080-exec-3] WARN  c.r.L.service.KnowledgeBaseService - 向量存储中未找到文档的向量块数据: 5
2025-10-11 18:36:29.634 [http-nio-8080-exec-3] WARN  c.r.L.service.KnowledgeBaseService - 未找到文档的向量块数据，尝试从数据库内容重新计算: 5
2025-10-11 18:36:29.639 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从文档内容重新计算得到 110 个向量块
2025-10-11 18:36:29.640 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 获取到 110 个向量块
2025-10-11 18:36:29.658 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3d640ab5, method=GET, uri=/api/v1/knowledge-base/documents/5/chunks, status=200, duration=109ms
2025-10-11 18:36:45.144 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 18:36:45.147 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 18:39:52.364 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 36100 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 18:39:52.366 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 18:39:54.662 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 18:39:54.887 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@252d2ac0
2025-10-11 18:39:54.931 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 18:39:54.951 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 18:39:54.956 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 18:39:55.036 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 18:39:55.037 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 18:39:55.401 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 18:39:56.781 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 18:39:56.835 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 18:39:56.836 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 18:39:56.859 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 18:39:56.860 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 18:39:56.860 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 18:39:56.860 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 18:39:56.860 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 18:39:56.860 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 18:39:56.860 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 18:39:57.190 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 18:39:57.222 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 18:39:57.223 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 18:39:57.227 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 18:39:57.227 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 18:39:57.228 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 18:39:57.258 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 18:39:57.425 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 18:39:57.426 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 18:39:57.428 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 18:39:57.428 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 18:39:57.439 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 18:39:57.440 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 18:39:57.498 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 18:39:57.742 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 18:39:57.749 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 18:39:57.751 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 18:39:57.751 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 18:39:57.751 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 18:39:57.756 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 18:39:57.756 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 18:39:57.777 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 18:39:57.777 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 18:39:57.778 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 18:39:57.778 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 18:39:57.778 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 18:39:57.778 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 18:39:57.778 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 18:39:57.796 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 18:39:57.804 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 18:39:57.815 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 18:39:57.816 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 18:39:57.827 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 18:39:57.828 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 18:39:57.830 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 18:39:57.830 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 18:39:57.831 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 18:39:57.831 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 18:39:57.881 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 18:39:58.241 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 18:39:58.328 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 18:39:58.328 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 18:39:58.328 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 18:39:58.328 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 18:39:58.329 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 18:39:58.336 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 18:39:58.339 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 18:39:58.411 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 18:39:58.437 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 18:39:58.461 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 18:39:58.463 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 18:39:58.485 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 18:39:58.486 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 18:39:58.611 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 18:39:58.816 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 18:39:59.132 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 18:39:59.284 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 18:40:00.105 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.136 seconds (process running for 8.43)
2025-10-11 18:40:10.154 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:40:10.173 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ff7b3929, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=79ms
2025-10-11 18:40:10.716 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 5
2025-10-11 18:40:10.716 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 5
2025-10-11 18:40:10.740 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 从向量存储中获取文档向量块: 5
2025-10-11 18:40:10.799 [http-nio-8080-exec-2] WARN  c.r.L.service.KnowledgeBaseService - 通过doc_id查询向量块失败: class org.postgresql.util.PGobject cannot be cast to class java.lang.String (org.postgresql.util.PGobject is in unnamed module of loader 'app'; java.lang.String is in module java.base of loader 'bootstrap')
2025-10-11 18:40:10.810 [http-nio-8080-exec-2] WARN  c.r.L.service.KnowledgeBaseService - 通过文件名查询向量块失败: class org.postgresql.util.PGobject cannot be cast to class java.lang.String (org.postgresql.util.PGobject is in unnamed module of loader 'app'; java.lang.String is in module java.base of loader 'bootstrap')
2025-10-11 18:40:10.825 [http-nio-8080-exec-2] WARN  c.r.L.service.KnowledgeBaseService - 通过sourceFile查询向量块失败: class org.postgresql.util.PGobject cannot be cast to class java.lang.String (org.postgresql.util.PGobject is in unnamed module of loader 'app'; java.lang.String is in module java.base of loader 'bootstrap')
2025-10-11 18:40:10.826 [http-nio-8080-exec-2] WARN  c.r.L.service.KnowledgeBaseService - 向量存储中未找到文档的向量块数据: 5
2025-10-11 18:40:10.826 [http-nio-8080-exec-2] WARN  c.r.L.service.KnowledgeBaseService - 未找到文档的向量块数据，尝试从数据库内容重新计算: 5
2025-10-11 18:40:10.835 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 从文档内容重新计算得到 110 个向量块
2025-10-11 18:40:10.836 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 获取到 110 个向量块
2025-10-11 18:40:10.858 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=2ba9943e, method=GET, uri=/api/v1/knowledge-base/documents/5/chunks, status=200, duration=150ms
2025-10-11 18:40:22.667 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 18:40:22.670 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 18:43:25.275 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 39380 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 18:43:25.276 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 18:43:27.563 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 18:43:27.685 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@4ef10d3b
2025-10-11 18:43:27.727 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 18:43:27.747 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 18:43:27.752 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 18:43:27.835 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 18:43:27.837 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 18:43:28.168 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 18:43:29.530 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 18:43:29.580 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 18:43:29.581 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 18:43:29.605 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 18:43:29.605 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 18:43:29.605 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 18:43:29.605 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 18:43:29.605 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 18:43:29.606 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 18:43:29.606 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 18:43:29.929 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 18:43:29.956 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 18:43:29.962 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 18:43:29.966 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 18:43:29.967 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 18:43:29.969 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 18:43:30.000 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 18:43:30.175 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 18:43:30.177 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 18:43:30.177 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 18:43:30.177 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 18:43:30.191 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 18:43:30.191 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 18:43:30.254 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 18:43:30.509 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 18:43:30.516 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 18:43:30.518 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 18:43:30.518 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 18:43:30.518 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 18:43:30.525 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 18:43:30.525 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 18:43:30.548 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 18:43:30.548 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 18:43:30.548 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 18:43:30.549 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 18:43:30.549 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 18:43:30.549 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 18:43:30.549 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 18:43:30.561 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 18:43:30.577 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 18:43:30.590 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 18:43:30.590 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 18:43:30.600 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 18:43:30.601 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 18:43:30.603 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 18:43:30.603 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 18:43:30.604 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 18:43:30.605 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 18:43:30.654 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 18:43:31.058 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 18:43:31.139 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 18:43:31.139 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 18:43:31.140 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 18:43:31.140 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 18:43:31.140 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 18:43:31.147 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 18:43:31.150 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 18:43:31.234 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 18:43:31.265 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 18:43:31.294 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 18:43:31.297 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 18:43:31.321 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 18:43:31.322 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 18:43:31.455 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 18:43:31.654 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 18:43:32.034 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 18:43:32.315 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 18:43:33.381 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.505 seconds (process running for 8.807)
2025-10-11 18:43:41.193 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=1
2025-10-11 18:43:41.214 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=94ed4cb4, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=77ms
2025-10-11 18:43:41.875 [http-nio-8080-exec-8] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 5
2025-10-11 18:43:41.877 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 5
2025-10-11 18:43:41.897 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 从向量存储中获取文档向量块: 5
2025-10-11 18:43:41.972 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 通过doc_id获取到 70 个向量块
2025-10-11 18:43:41.972 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 获取到 70 个向量块
2025-10-11 18:43:41.988 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ad569045, method=GET, uri=/api/v1/knowledge-base/documents/5/chunks, status=200, duration=122ms
2025-10-11 18:44:07.783 [http-nio-8080-exec-4] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 民法典.pdf
2025-10-11 18:44:07.797 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 民法典.pdf, 大小: 755803 bytes
2025-10-11 18:44:07.797 [http-nio-8080-exec-4] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 民法典.pdf, 类型: pdf, 大小: 755803 bytes
2025-10-11 18:44:08.750 [http-nio-8080-exec-4] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 民法典.pdf, 内容长度: 114965 字符
2025-10-11 18:44:08.759 [http-nio-8080-exec-4] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 114965 字符
2025-10-11 18:44:08.760 [http-nio-8080-exec-4] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 18:44:08.785 [http-nio-8080-exec-4] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 1298 个片段
2025-10-11 18:44:24.765 [http-nio-8080-exec-4] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 1293, 存储数: 1293, 耗时: 16006ms
2025-10-11 18:44:24.805 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：民法典.pdf
2025-10-11 18:44:24.805 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 民法典.pdf, 文档ID: 6, 块数: 1293, 分割器: LegalDocumentSplitter
2025-10-11 18:44:24.810 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3d212aa7, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=17052ms
2025-10-11 18:44:24.845 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=2
2025-10-11 18:44:24.846 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=59c9e2ff, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=8ms
2025-10-11 18:45:37.794 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 18:45:37.798 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 19:51:42.152 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 38804 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 19:51:42.154 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 19:51:44.730 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 19:51:44.886 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@355b4c34
2025-10-11 19:51:44.946 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 19:51:44.964 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 19:51:44.970 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 19:51:45.054 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 19:51:45.056 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 19:51:45.509 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 19:51:46.981 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 19:51:47.038 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 19:51:47.042 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 19:51:47.067 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 19:51:47.068 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 19:51:47.068 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 19:51:47.068 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 19:51:47.068 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 19:51:47.068 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 19:51:47.068 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 19:51:47.410 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 19:51:47.445 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 19:51:47.447 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 19:51:47.451 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 19:51:47.452 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 19:51:47.453 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 19:51:47.488 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 19:51:47.665 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 19:51:47.668 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 19:51:47.669 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 19:51:47.669 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 19:51:47.680 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 19:51:47.681 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 19:51:47.753 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 19:51:48.032 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 19:51:48.040 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 19:51:48.041 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 19:51:48.041 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 19:51:48.042 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 19:51:48.048 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 19:51:48.048 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 19:51:48.071 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 19:51:48.072 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 19:51:48.072 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 19:51:48.072 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 19:51:48.072 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 19:51:48.072 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 19:51:48.072 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 19:51:48.084 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 19:51:48.093 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 19:51:48.104 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 19:51:48.104 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 19:51:48.115 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 19:51:48.115 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 19:51:48.117 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 19:51:48.117 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 19:51:48.119 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 19:51:48.120 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 19:51:48.168 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 19:51:48.816 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 19:51:48.897 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 19:51:48.897 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 19:51:48.897 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 19:51:48.897 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 19:51:48.898 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 19:51:48.908 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 19:51:48.910 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 19:51:48.993 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 19:51:49.024 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 19:51:49.051 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 19:51:49.053 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 19:51:49.081 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 19:51:49.083 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 19:51:49.208 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 19:51:49.416 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 19:51:49.718 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 19:51:49.886 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 19:51:50.800 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.131 seconds (process running for 9.442)
2025-10-11 19:51:56.434 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0ccf318d, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=91ms
2025-10-11 19:52:02.793 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 19:52:02.828 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5b317bc1, method=GET, uri=/api/v1/chat/sessions, status=200, duration=42ms
2025-10-11 19:52:05.633 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f06cf051, method=GET, uri=/api/v1/users, status=200, duration=16ms
2025-10-11 19:52:07.380 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=2
2025-10-11 19:52:07.385 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=517773a4, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=19ms
2025-10-11 19:52:09.473 [http-nio-8080-exec-5] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 6
2025-10-11 19:52:09.474 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 6
2025-10-11 19:52:09.500 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 从向量存储中获取文档向量块: 6
2025-10-11 19:52:09.816 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 通过文件名获取到 1293 个向量块
2025-10-11 19:52:09.817 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 获取到 1293 个向量块
2025-10-11 19:52:09.847 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=947d17d3, method=GET, uri=/api/v1/knowledge-base/documents/6/chunks, status=200, duration=386ms
2025-10-11 19:52:20.313 [http-nio-8080-exec-7] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=厂排污导致居民健康受损，同时解雇了进行抗议的员工，这合法吗, modelType=UNIFIED
2025-10-11 19:52:20.316 [http-nio-8080-exec-7] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 19:52:20.352 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760183540236_f1yikrdyu, userId=1, title=厂排污导致居民健康受损，同时解雇了进行抗议的员工，这合法吗
2025-10-11 19:52:20.403 [http-nio-8080-exec-7] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 19:52:20.403 [http-nio-8080-exec-7] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 19:52:20.406 [Async-1] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='厂排污导致居民健康受损，同时解雇了进行抗议的员工，这合法吗', length=29
2025-10-11 19:52:20.406 [Async-1] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 19:52:20.406 [Async-1] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 19:52:20.414 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0ef3d75e, method=POST, uri=/api/v1/chat/stream, status=200, duration=161ms
2025-10-11 19:53:20.745 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 2873
2025-10-11 19:53:20.757 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 19:53:20.775 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 19:53:20.785 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=dafb89a2, method=GET, uri=/api/v1/chat/sessions, status=200, duration=11ms
2025-10-11 19:58:30.716 [http-nio-8080-exec-9] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760147266185_pl9emds6w 的消息
2025-10-11 19:58:30.729 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=22493b01, method=GET, uri=/api/v1/chat/sessions/session_1760147266185_pl9emds6w, status=200, duration=14ms
2025-10-11 19:58:53.498 [http-nio-8080-exec-10] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760018506076_0uolseobk 的消息
2025-10-11 19:58:53.503 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=05c87bea, method=GET, uri=/api/v1/chat/sessions/session_1760018506076_0uolseobk, status=200, duration=7ms
2025-10-11 19:59:03.233 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760183540236_f1yikrdyu 的消息
2025-10-11 19:59:03.239 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=c2469104, method=GET, uri=/api/v1/chat/sessions/session_1760183540236_f1yikrdyu, status=200, duration=6ms
2025-10-11 20:01:14.468 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:01:14.475 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=261c1290, method=GET, uri=/api/v1/chat/sessions, status=200, duration=7ms
2025-10-11 20:01:27.841 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:01:27.846 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=e56b56e0, method=GET, uri=/api/v1/chat/sessions, status=200, duration=6ms
2025-10-11 20:01:43.226 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:01:43.231 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4f9146e1, method=GET, uri=/api/v1/chat/sessions, status=200, duration=5ms
2025-10-11 20:02:06.574 [http-nio-8080-exec-5] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:02:06.580 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=8cef2f3f, method=GET, uri=/api/v1/chat/sessions, status=200, duration=6ms
2025-10-11 20:03:16.784 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760147266185_pl9emds6w 的消息
2025-10-11 20:03:16.789 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=b1b8b58d, method=GET, uri=/api/v1/chat/sessions/session_1760147266185_pl9emds6w, status=200, duration=6ms
2025-10-11 20:03:17.697 [http-nio-8080-exec-6] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760183540236_f1yikrdyu 的消息
2025-10-11 20:03:17.702 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ef921f29, method=GET, uri=/api/v1/chat/sessions/session_1760183540236_f1yikrdyu, status=200, duration=6ms
2025-10-11 20:03:23.442 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760147266185_pl9emds6w 的消息
2025-10-11 20:03:23.449 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5ad70371, method=GET, uri=/api/v1/chat/sessions/session_1760147266185_pl9emds6w, status=200, duration=7ms
2025-10-11 20:04:25.705 [http-nio-8080-exec-9] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760183540236_f1yikrdyu 的消息
2025-10-11 20:04:25.711 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=984159b0, method=GET, uri=/api/v1/chat/sessions/session_1760183540236_f1yikrdyu, status=200, duration=7ms
2025-10-11 20:05:02.100 [http-nio-8080-exec-10] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:05:02.109 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f1a24499, method=GET, uri=/api/v1/chat/sessions, status=200, duration=10ms
2025-10-11 20:05:23.672 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:05:23.678 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=775e0b27, method=GET, uri=/api/v1/chat/sessions, status=200, duration=7ms
2025-10-11 20:05:36.375 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:05:36.381 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=1abba11d, method=GET, uri=/api/v1/chat/sessions, status=200, duration=6ms
2025-10-11 20:05:53.631 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:05:53.638 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5fe47910, method=GET, uri=/api/v1/chat/sessions, status=200, duration=8ms
2025-10-11 20:06:09.887 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:06:09.893 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=33258874, method=GET, uri=/api/v1/chat/sessions, status=200, duration=6ms
2025-10-11 20:07:01.701 [http-nio-8080-exec-5] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760147266185_pl9emds6w 的消息
2025-10-11 20:07:01.708 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=c7135cb7, method=GET, uri=/api/v1/chat/sessions/session_1760147266185_pl9emds6w, status=200, duration=9ms
2025-10-11 20:07:06.875 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:07:06.882 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5032fc78, method=GET, uri=/api/v1/chat/sessions, status=200, duration=8ms
2025-10-11 20:07:08.232 [http-nio-8080-exec-6] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760183540236_f1yikrdyu 的消息
2025-10-11 20:07:08.237 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=14bda44e, method=GET, uri=/api/v1/chat/sessions/session_1760183540236_f1yikrdyu, status=200, duration=6ms
2025-10-11 20:07:23.800 [http-nio-8080-exec-8] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我民法典第500条的内容, modelType=UNIFIED
2025-10-11 20:07:23.801 [http-nio-8080-exec-8] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 20:07:23.805 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760184443786_xx5k0i8ee, userId=1, title=请你告诉我民法典第500条的内容
2025-10-11 20:07:23.819 [http-nio-8080-exec-8] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 20:07:23.820 [http-nio-8080-exec-8] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 20:07:23.821 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=30d39be3, method=POST, uri=/api/v1/chat/stream, status=200, duration=23ms
2025-10-11 20:07:23.822 [Async-2] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='请你告诉我民法典第500条的内容', length=16
2025-10-11 20:07:23.822 [Async-2] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 20:07:23.822 [Async-2] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 20:08:19.006 [ForkJoinPool.commonPool-worker-3] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 2375
2025-10-11 20:08:19.096 [http-nio-8080-exec-9] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 20:08:19.172 [http-nio-8080-exec-10] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:08:19.196 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=8318f412, method=GET, uri=/api/v1/chat/sessions, status=200, duration=26ms
2025-10-11 20:12:14.623 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:12:14.631 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=d592692c, method=GET, uri=/api/v1/chat/sessions, status=200, duration=9ms
2025-10-11 20:12:15.665 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760184443786_xx5k0i8ee 的消息
2025-10-11 20:12:15.669 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=00171dfa, method=GET, uri=/api/v1/chat/sessions/session_1760184443786_xx5k0i8ee, status=200, duration=5ms
2025-10-11 20:12:21.866 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760183540236_f1yikrdyu 的消息
2025-10-11 20:12:21.874 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=19a9a769, method=GET, uri=/api/v1/chat/sessions/session_1760183540236_f1yikrdyu, status=200, duration=8ms
2025-10-11 20:12:34.882 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我环境保护法第30条的内容, modelType=UNIFIED
2025-10-11 20:12:34.884 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 20:12:34.887 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760184754868_tjvfnbqwo, userId=1, title=请你告诉我环境保护法第30条的内容
2025-10-11 20:12:34.902 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 20:12:34.902 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 20:12:34.904 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=67295849, method=POST, uri=/api/v1/chat/stream, status=200, duration=24ms
2025-10-11 20:12:34.904 [Async-3] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='请你告诉我环境保护法第30条的内容', length=17
2025-10-11 20:12:34.904 [Async-3] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 20:12:34.905 [Async-3] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 20:13:26.362 [ForkJoinPool.commonPool-worker-5] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 2363
2025-10-11 20:13:26.364 [http-nio-8080-exec-5] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 20:13:26.380 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:13:26.394 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=11ceac17, method=GET, uri=/api/v1/chat/sessions, status=200, duration=15ms
2025-10-11 20:13:32.279 [http-nio-8080-exec-6] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760147266185_pl9emds6w 的消息
2025-10-11 20:13:32.285 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=916e04ef, method=GET, uri=/api/v1/chat/sessions/session_1760147266185_pl9emds6w, status=200, duration=6ms
2025-10-11 20:13:39.355 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 用户 1 删除会话 session_1760147266185_pl9emds6w
2025-10-11 20:13:39.376 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 会话 session_1760147266185_pl9emds6w 已删除
2025-10-11 20:13:39.403 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=57a8294f, method=DELETE, uri=/api/v1/chat/sessions/session_1760147266185_pl9emds6w, status=200, duration=50ms
2025-10-11 20:14:38.160 [http-nio-8080-exec-9] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760184754868_tjvfnbqwo 的消息
2025-10-11 20:14:38.166 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3af09c4c, method=GET, uri=/api/v1/chat/sessions/session_1760184754868_tjvfnbqwo, status=200, duration=7ms
2025-10-11 20:14:50.931 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4ff71017, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=11ms
2025-10-11 20:14:54.008 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f5e5701d, method=GET, uri=/api/v1/users, status=200, duration=5ms
2025-10-11 20:14:55.280 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=2
2025-10-11 20:14:55.282 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=42d61245, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=8ms
2025-10-11 20:15:15.469 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5035d838, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=12ms
2025-10-11 20:19:10.695 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760184443786_xx5k0i8ee 的消息
2025-10-11 20:19:10.702 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=a62b61ba, method=GET, uri=/api/v1/chat/sessions/session_1760184443786_xx5k0i8ee, status=200, duration=8ms
2025-10-11 20:19:11.831 [http-nio-8080-exec-5] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760183540236_f1yikrdyu 的消息
2025-10-11 20:19:11.836 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=2660d65d, method=GET, uri=/api/v1/chat/sessions/session_1760183540236_f1yikrdyu, status=200, duration=5ms
2025-10-11 20:19:16.339 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760184754868_tjvfnbqwo 的消息
2025-10-11 20:19:16.346 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4a41bb02, method=GET, uri=/api/v1/chat/sessions/session_1760184754868_tjvfnbqwo, status=200, duration=8ms
2025-10-11 20:21:10.707 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我环境保护法第30条的内容, modelType=UNIFIED
2025-10-11 20:21:10.708 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 20:21:10.712 [http-nio-8080-exec-6] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760185270694_vqlk1bx54, userId=1, title=请你告诉我环境保护法第30条的内容
2025-10-11 20:21:10.731 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 20:21:10.731 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 20:21:10.732 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3a0fe1f0, method=POST, uri=/api/v1/chat/stream, status=200, duration=26ms
2025-10-11 20:21:10.732 [Async-4] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='请你告诉我环境保护法第30条的内容', length=17
2025-10-11 20:21:10.733 [Async-4] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 20:21:10.733 [Async-4] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 20:21:32.612 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760184754868_tjvfnbqwo 的消息
2025-10-11 20:21:32.623 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=410d359e, method=GET, uri=/api/v1/chat/sessions/session_1760184754868_tjvfnbqwo, status=200, duration=12ms
2025-10-11 20:21:40.876 [http-nio-8080-exec-9] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760184443786_xx5k0i8ee 的消息
2025-10-11 20:21:40.888 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=1d7e2c80, method=GET, uri=/api/v1/chat/sessions/session_1760184443786_xx5k0i8ee, status=200, duration=13ms
2025-10-11 20:21:41.352 [http-nio-8080-exec-10] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760184754868_tjvfnbqwo 的消息
2025-10-11 20:21:41.357 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=19a165b6, method=GET, uri=/api/v1/chat/sessions/session_1760184754868_tjvfnbqwo, status=200, duration=6ms
2025-10-11 20:21:44.089 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760184754868_tjvfnbqwo 的消息
2025-10-11 20:21:44.094 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0929c02b, method=GET, uri=/api/v1/chat/sessions/session_1760184754868_tjvfnbqwo, status=200, duration=7ms
2025-10-11 20:22:00.081 [ForkJoinPool.commonPool-worker-7] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 2260
2025-10-11 20:22:00.082 [http-nio-8080-exec-2] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 20:26:29.478 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:26:29.485 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=8985a0b1, method=GET, uri=/api/v1/chat/sessions, status=200, duration=8ms
2025-10-11 20:26:47.987 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:26:47.997 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=05521261, method=GET, uri=/api/v1/chat/sessions, status=200, duration=12ms
2025-10-11 20:27:17.296 [http-nio-8080-exec-5] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760185270694_vqlk1bx54 的消息
2025-10-11 20:27:17.300 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=14c83356, method=GET, uri=/api/v1/chat/sessions/session_1760185270694_vqlk1bx54, status=200, duration=5ms
2025-10-11 20:27:55.052 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 20:27:55.057 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 20:34:24.465 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 37992 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 20:34:24.467 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 20:34:27.004 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 20:34:27.157 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@7a79d99c
2025-10-11 20:34:27.210 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 20:34:27.230 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 20:34:27.236 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 20:34:27.426 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 20:34:27.428 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 20:34:27.852 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 20:34:29.320 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 20:34:29.373 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 20:34:29.376 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 20:34:29.421 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 20:34:29.421 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 20:34:29.421 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 20:34:29.422 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 20:34:29.422 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 20:34:29.422 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 20:34:29.422 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 20:34:29.801 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 20:34:29.834 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 20:34:29.836 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 20:34:29.841 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 20:34:29.842 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 20:34:29.842 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 20:34:29.877 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 20:34:30.054 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 20:34:30.056 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 20:34:30.057 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 20:34:30.057 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 20:34:30.070 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 20:34:30.070 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 20:34:30.145 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 20:34:30.435 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 20:34:30.442 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 20:34:30.445 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 20:34:30.445 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 20:34:30.445 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 20:34:30.453 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 20:34:30.453 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 20:34:30.476 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 20:34:30.477 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 20:34:30.477 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 20:34:30.477 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 20:34:30.477 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 20:34:30.478 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 20:34:30.478 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 20:34:30.489 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 20:34:30.497 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 20:34:30.511 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 20:34:30.511 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 20:34:30.521 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 20:34:30.521 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 20:34:30.524 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 20:34:30.524 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 20:34:30.526 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 20:34:30.526 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 20:34:30.573 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 20:34:30.978 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 20:34:31.065 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 20:34:31.066 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 20:34:31.066 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 20:34:31.066 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 20:34:31.067 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 20:34:31.074 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 20:34:31.077 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 20:34:31.160 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 20:34:31.200 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 20:34:31.225 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 20:34:31.228 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 20:34:31.256 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 20:34:31.259 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 20:34:31.384 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 20:34:31.601 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 20:34:32.121 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 20:34:32.395 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 20:34:33.842 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.869 seconds (process running for 10.154)
2025-10-11 20:34:42.343 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:34:42.396 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f4d002d1, method=GET, uri=/api/v1/chat/sessions, status=200, duration=81ms
2025-10-11 20:34:45.795 [http-nio-8080-exec-6] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:34:45.805 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=354b0ea5, method=GET, uri=/api/v1/chat/sessions, status=200, duration=11ms
2025-10-11 20:34:45.843 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=案例类型： 非法解除劳动合同
案情简介：
申请人（员工）： 李工
被申请人（公司）： 某科技公司
李工在该科技公司担任软件工程师已满三年，劳动合同尚有一年才到期。近期，公司因业务调整，计划裁撤李工所在的整个项目组。
公司人事部找到李工谈话，表示由于“客观情况发生重大变化”，希望与他协商解除劳动合同，并愿意支付“N+1”的经济补偿金。李工不同意解除，认为自己工作表现良好，公司应安排其他岗位。
协商未果后，公司单方面向李工发出了《解除劳动合同通知书》，理由是“客观情况发生重大变化，致使劳动合同无法继续履行，且经协商未能就变更劳动合同内容达成协议”。
核心法律问题：
公司“业务调整、裁撤项目组”是否属于《劳动合同法》规定的“客观情况发生重大变化”？
公司在单方面解除合同前，是否履行了必要的程序？（例如，是否真正提供了其他岗位供协商变更）
公司的解除行为是合法解除还是违法解除？
如果被认定为违法解除，李工有哪些选择？（是要求公司支付赔偿金（2N），还是可以要求继续履行劳动合同？）, modelType=UNIFIED
2025-10-11 20:34:45.844 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 20:34:45.875 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760186085771_xgsl38n75, userId=1, title=案例类型： 非法解除劳动合同
案情简介：
申请人（员工）： 李工
被申请人（公司）： 某科技公司
李...
2025-10-11 20:34:45.921 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 20:34:45.922 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (复杂分析)
2025-10-11 20:34:45.925 [Async-1] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='案例类型： 非法解除劳动合同
案情简介：
申请人（员工）： 李工
被申请人（公司）： 某科技公司
李工在该科技公司担任软件工程师已满三年，劳动合同尚有一年才到期。近期，公司因业务调整，计划裁撤李工所在的整个项目组。
公司人事部找到李工谈话，表示由于“客观情况发生重大变化”，希望与他协商解除劳动合同，并愿意支付“N+1”的经济补偿金。李工不同意解除，认为自己工作表现良好，公司应安排其他岗位。
协商未果后，公司单方面向李工发出了《解除劳动合同通知书》，理由是“客观情况发生重大变化，致使劳动合同无法继续履行，且经协商未能就变更劳动合同内容达成协议”。
核心法律问题：
公司“业务调整、裁撤项目组”是否属于《劳动合同法》规定的“客观情况发生重大变化”？
公司在单方面解除合同前，是否履行了必要的程序？（例如，是否真正提供了其他岗位供协商变更）
公司的解除行为是合法解除还是违法解除？
如果被认定为违法解除，李工有哪些选择？（是要求公司支付赔偿金（2N），还是可以要求继续履行劳动合同？）', length=442
2025-10-11 20:34:45.925 [Async-1] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 20:34:45.925 [Async-1] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 20:34:45.929 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=1dfde24e, method=POST, uri=/api/v1/chat/stream, status=200, duration=144ms
2025-10-11 20:35:50.865 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 3129
2025-10-11 20:35:50.877 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 20:35:55.739 [http-nio-8080-exec-5] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:35:55.758 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=682db41c, method=GET, uri=/api/v1/chat/sessions, status=200, duration=20ms
2025-10-11 20:35:56.823 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:35:56.836 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=23da9ba7, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=18ms
2025-10-11 20:47:34.931 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 20:47:34.935 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 20:47:52.861 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 13672 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 20:47:52.863 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 20:47:55.623 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 20:47:55.766 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@7a79d99c
2025-10-11 20:47:55.817 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 20:47:55.840 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 20:47:55.846 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 20:47:55.930 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 20:47:55.933 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 20:47:56.360 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 20:47:57.924 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 20:47:57.972 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 20:47:57.974 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 20:47:57.999 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 20:47:57.999 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 20:47:57.999 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 20:47:57.999 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 20:47:58.000 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 20:47:58.000 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 20:47:58.000 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 20:47:58.347 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 20:47:58.387 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 20:47:58.389 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 20:47:58.394 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 20:47:58.396 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 20:47:58.397 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 20:47:58.437 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 20:47:58.634 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 20:47:58.636 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 20:47:58.637 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 20:47:58.637 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 20:47:58.649 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 20:47:58.649 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 20:47:58.713 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 20:47:58.997 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 20:47:59.005 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 20:47:59.007 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 20:47:59.007 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 20:47:59.007 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 20:47:59.015 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 20:47:59.015 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 20:47:59.042 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 20:47:59.042 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 20:47:59.042 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 20:47:59.043 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 20:47:59.043 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 20:47:59.043 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 20:47:59.043 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 20:47:59.057 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 20:47:59.066 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 20:47:59.080 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 20:47:59.081 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 20:47:59.093 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 20:47:59.094 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 20:47:59.096 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 20:47:59.096 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 20:47:59.098 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 20:47:59.099 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 20:47:59.162 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 20:47:59.646 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 20:47:59.746 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 20:47:59.746 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 20:47:59.747 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 20:47:59.747 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 20:47:59.747 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 20:47:59.755 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 20:47:59.758 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 20:47:59.847 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 20:47:59.877 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 20:47:59.905 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 20:47:59.907 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 20:47:59.932 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 20:47:59.934 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 20:48:00.078 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 20:48:00.335 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 20:48:00.686 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 20:48:00.881 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 20:48:01.928 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.572 seconds (process running for 9.909)
2025-10-11 20:48:20.183 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:48:20.238 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=a4a779a5, method=GET, uri=/api/v1/chat/sessions, status=200, duration=79ms
2025-10-11 20:48:33.770 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:48:33.784 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6aa728da, method=GET, uri=/api/v1/chat/sessions, status=200, duration=15ms
2025-10-11 20:48:33.848 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我民法典第32条是什么, modelType=UNIFIED
2025-10-11 20:48:33.851 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 20:48:33.893 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760186913744_w0dgzgd5r, userId=1, title=请你告诉我民法典第32条是什么
2025-10-11 20:48:33.950 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 20:48:33.951 [http-nio-8080-exec-4] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced RAG (简单查询)
2025-10-11 20:48:33.951 [http-nio-8080-exec-4] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG 流式处理法律咨询: 请你告诉我民法典第32条是什么, 会话: session_1760186913744_w0dgzgd5r
2025-10-11 20:48:33.952 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.a.AdvancedLegalRagService - 识别为法律问题，开始检索相关法律知识...
2025-10-11 20:48:33.953 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.a.LegalContentRetriever - 多源检索法律内容: 请你告诉我民法典第32条是什么
2025-10-11 20:48:33.959 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0766ec6e, method=POST, uri=/api/v1/chat/stream, status=200, duration=192ms
2025-10-11 20:48:35.864 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.a.LegalContentRetriever - 多源检索完成，返回 10 个结果
2025-10-11 20:48:35.865 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索到 10 条相关内容
2025-10-11 20:48:39.317 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG 流式响应完成，总长度: 96
2025-10-11 20:48:39.332 [http-nio-8080-exec-2] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 20:49:55.754 [http-nio-8080-exec-5] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:49:55.767 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4c7c473c, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=23ms
2025-10-11 20:49:58.331 [http-nio-8080-exec-10] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760185270694_vqlk1bx54 的消息
2025-10-11 20:49:58.338 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=93e286bb, method=GET, uri=/api/v1/chat/sessions/session_1760185270694_vqlk1bx54, status=200, duration=9ms
2025-10-11 20:49:58.899 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:49:58.906 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=63a97b2e, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=8ms
2025-10-11 20:50:01.053 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 20:50:01.068 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=429d4d87, method=GET, uri=/api/v1/chat/sessions, status=200, duration=16ms
2025-10-11 20:50:01.596 [http-nio-8080-exec-9] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186913744_w0dgzgd5r 的消息
2025-10-11 20:50:01.603 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=dd4f12ee, method=GET, uri=/api/v1/chat/sessions/session_1760186913744_w0dgzgd5r, status=200, duration=8ms
2025-10-11 20:50:02.593 [http-nio-8080-exec-6] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:50:02.600 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ccf3b2b0, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=7ms
2025-10-11 20:50:03.202 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186913744_w0dgzgd5r 的消息
2025-10-11 20:50:03.209 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=622ff9ee, method=GET, uri=/api/v1/chat/sessions/session_1760186913744_w0dgzgd5r, status=200, duration=8ms
2025-10-11 20:50:03.957 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:50:03.964 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=cbc28c00, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=8ms
2025-10-11 20:50:07.728 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760185270694_vqlk1bx54 的消息
2025-10-11 20:50:07.734 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=bff604a0, method=GET, uri=/api/v1/chat/sessions/session_1760185270694_vqlk1bx54, status=200, duration=7ms
2025-10-11 20:50:08.351 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:50:08.358 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6ff01f99, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=8ms
2025-10-11 20:50:11.845 [http-nio-8080-exec-5] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186913744_w0dgzgd5r 的消息
2025-10-11 20:50:11.851 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=8e307ee0, method=GET, uri=/api/v1/chat/sessions/session_1760186913744_w0dgzgd5r, status=200, duration=7ms
2025-10-11 20:50:17.978 [http-nio-8080-exec-10] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=案例类型： 著作权（版权）侵权
案情简介：
权利人： 摄影师陈女士
侵权方： “美食攻略”微信公众号运营公司
摄影师陈女士是一位美食摄影爱好者，她拍摄了一组关于城市特色小吃的精美照片，并发布在自己的个人微博上，但未添加水印。
“美食攻略”公众号在未经陈女士许可的情况下，直接从其微博下载了9张照片，用于一篇介绍该城市美食的商业推广文章中，文章阅读量超过10万。文章中未注明照片来源和作者。
陈女士发现后，联系该公众号要求删除照片、公开道歉并赔偿损失。对方仅删除了照片，但拒绝道歉和赔偿，声称照片来自网络，属于“合理使用”。
核心法律问题：
陈女士发布在微博上的照片是否享有著作权？
“美食攻略”公众号的使用行为是否构成对陈女士著作权的侵犯？具体侵犯了哪些权利（如复制权、信息网络传播权、署名权）？
公众号“图片来自网络”和“合理使用”的抗辩理由是否成立？
如果构成侵权，陈女士可以提出的赔偿请求应如何计算？（在无法证明其实际损失和对方违法所得的情况下，法院如何适用法定赔偿？）, modelType=UNIFIED
2025-10-11 20:50:17.979 [http-nio-8080-exec-10] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 20:50:17.997 [http-nio-8080-exec-10] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 20:50:17.998 [http-nio-8080-exec-10] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (复杂分析)
2025-10-11 20:50:18.000 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=16603621, method=POST, uri=/api/v1/chat/stream, status=200, duration=24ms
2025-10-11 20:50:18.001 [Async-1] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='案例类型： 著作权（版权）侵权
案情简介：
权利人： 摄影师陈女士
侵权方： “美食攻略”微信公众号运营公司
摄影师陈女士是一位美食摄影爱好者，她拍摄了一组关于城市特色小吃的精美照片，并发布在自己的个人微博上，但未添加水印。
“美食攻略”公众号在未经陈女士许可的情况下，直接从其微博下载了9张照片，用于一篇介绍该城市美食的商业推广文章中，文章阅读量超过10万。文章中未注明照片来源和作者。
陈女士发现后，联系该公众号要求删除照片、公开道歉并赔偿损失。对方仅删除了照片，但拒绝道歉和赔偿，声称照片来自网络，属于“合理使用”。
核心法律问题：
陈女士发布在微博上的照片是否享有著作权？
“美食攻略”公众号的使用行为是否构成对陈女士著作权的侵犯？具体侵犯了哪些权利（如复制权、信息网络传播权、署名权）？
公众号“图片来自网络”和“合理使用”的抗辩理由是否成立？
如果构成侵权，陈女士可以提出的赔偿请求应如何计算？（在无法证明其实际损失和对方违法所得的情况下，法院如何适用法定赔偿？）', length=438
2025-10-11 20:50:18.001 [Async-1] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 20:50:18.002 [Async-1] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 20:50:35.179 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:50:35.190 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=735788dc, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=12ms
2025-10-11 20:50:36.053 [http-nio-8080-exec-8] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186913744_w0dgzgd5r 的消息
2025-10-11 20:50:36.058 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=dd764b91, method=GET, uri=/api/v1/chat/sessions/session_1760186913744_w0dgzgd5r, status=200, duration=5ms
2025-10-11 20:51:17.243 [http-nio-8080-exec-9] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:51:17.248 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=d01b5077, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=6ms
2025-10-11 20:51:19.235 [http-nio-8080-exec-6] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186913744_w0dgzgd5r 的消息
2025-10-11 20:51:19.239 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=60a53716, method=GET, uri=/api/v1/chat/sessions/session_1760186913744_w0dgzgd5r, status=200, duration=5ms
2025-10-11 20:51:44.791 [ForkJoinPool.commonPool-worker-2] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 4095
2025-10-11 20:51:44.794 [http-nio-8080-exec-1] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 20:51:48.111 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186085771_xgsl38n75 的消息
2025-10-11 20:51:48.116 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5b3b3f97, method=GET, uri=/api/v1/chat/sessions/session_1760186085771_xgsl38n75, status=200, duration=5ms
2025-10-11 20:51:48.524 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186913744_w0dgzgd5r 的消息
2025-10-11 20:51:48.529 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=e846684e, method=GET, uri=/api/v1/chat/sessions/session_1760186913744_w0dgzgd5r, status=200, duration=6ms
2025-10-11 20:52:36.992 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 20:52:36.996 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 21:02:27.707 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 30676 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 21:02:27.708 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 21:02:30.149 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 21:02:30.306 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@33502cfe
2025-10-11 21:02:30.362 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 21:02:30.383 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 21:02:30.389 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 21:02:30.491 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 21:02:30.494 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 21:02:31.002 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 21:02:32.475 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 21:02:32.526 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 21:02:32.530 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 21:02:32.555 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 21:02:32.556 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 21:02:32.556 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 21:02:32.556 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 21:02:32.556 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 21:02:32.556 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 21:02:32.556 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 21:02:32.924 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 21:02:32.977 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 21:02:32.980 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 21:02:32.988 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 21:02:32.990 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 21:02:32.991 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 21:02:33.076 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 21:02:33.327 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 21:02:33.331 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 21:02:33.331 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 21:02:33.331 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 21:02:33.346 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 21:02:33.347 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 21:02:33.434 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 21:02:33.831 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 21:02:33.857 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 21:02:33.859 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 21:02:33.859 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 21:02:33.859 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 21:02:33.867 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 21:02:33.867 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 21:02:33.898 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 21:02:33.898 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 21:02:33.898 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 21:02:33.898 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 21:02:33.899 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 21:02:33.899 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 21:02:33.899 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 21:02:33.913 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 21:02:33.922 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 21:02:33.936 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 21:02:33.937 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 21:02:33.949 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 21:02:33.949 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 21:02:33.951 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 21:02:33.952 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 21:02:33.953 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 21:02:33.953 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 21:02:34.006 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 21:02:34.464 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 21:02:34.543 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 21:02:34.543 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 21:02:34.543 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 21:02:34.544 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 21:02:34.544 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 21:02:34.551 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 21:02:34.554 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 21:02:34.630 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 21:02:34.670 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 21:02:34.712 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 21:02:34.715 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 21:02:34.745 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 21:02:34.749 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 21:02:34.934 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 21:02:35.202 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 21:02:35.550 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 21:02:35.705 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 21:02:36.555 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 9.305 seconds (process running for 9.649)
2025-10-11 21:02:40.114 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 21:02:40.164 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0786a13c, method=GET, uri=/api/v1/chat/sessions, status=200, duration=70ms
2025-10-11 21:02:41.107 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760186913744_w0dgzgd5r 的消息
2025-10-11 21:02:41.125 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0111664c, method=GET, uri=/api/v1/chat/sessions/session_1760186913744_w0dgzgd5r, status=200, duration=27ms
2025-10-11 21:03:25.693 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 21:03:25.711 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=cdcd455b, method=GET, uri=/api/v1/chat/sessions, status=200, duration=19ms
2025-10-11 21:03:25.767 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=案例类型： 饲养动物损害责任
案情简介：
受害人： 小学生王某（8岁）
责任方： 宠物狗主人赵某
某周日下午，赵某在小区内遛其饲养的大型犬（金毛寻回犬），但未使用牵引绳。此时，小学生王某在小区花园玩耍，看到金毛犬跑来，出于好奇上前抚摸。金毛犬突然受惊，将王某扑倒，导致王某右臂被抓伤，并有轻微咬痕。
事后，王某的父母要求赵某赔偿医疗费、精神损害抚慰金等共计8000元。赵某认为，他的狗平时很温顺，是王某主动上前挑逗才导致狗受惊，且伤情不重，赔偿要求过高。他辩称王某的监护人也应承担部分责任。
核心法律问题：
本案属于一般侵权责任还是特殊侵权责任（饲养动物损害责任）？
赵某作为动物饲养人，其“未拴绳”的行为是否是认定其承担责任的关键？
王某“主动抚摸”的行为是否可以作为减轻或免除赵某责任的法定事由？（即是否存在受害人故意或重大过失的情形）
王某父母（监护人）是否因未尽到看护责任而应承担相应责任？
精神损害抚慰金的主张是否合理？, modelType=UNIFIED
2025-10-11 21:03:25.770 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 21:03:25.817 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760187805666_ljysgsjph, userId=1, title=案例类型： 饲养动物损害责任
案情简介：
受害人： 小学生王某（8岁）
责任方： 宠物狗主人赵某
某...
2025-10-11 21:03:25.874 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 21:03:25.875 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (复杂分析)
2025-10-11 21:03:25.879 [Async-1] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='案例类型： 饲养动物损害责任
案情简介：
受害人： 小学生王某（8岁）
责任方： 宠物狗主人赵某
某周日下午，赵某在小区内遛其饲养的大型犬（金毛寻回犬），但未使用牵引绳。此时，小学生王某在小区花园玩耍，看到金毛犬跑来，出于好奇上前抚摸。金毛犬突然受惊，将王某扑倒，导致王某右臂被抓伤，并有轻微咬痕。
事后，王某的父母要求赵某赔偿医疗费、精神损害抚慰金等共计8000元。赵某认为，他的狗平时很温顺，是王某主动上前挑逗才导致狗受惊，且伤情不重，赔偿要求过高。他辩称王某的监护人也应承担部分责任。
核心法律问题：
本案属于一般侵权责任还是特殊侵权责任（饲养动物损害责任）？
赵某作为动物饲养人，其“未拴绳”的行为是否是认定其承担责任的关键？
王某“主动抚摸”的行为是否可以作为减轻或免除赵某责任的法定事由？（即是否存在受害人故意或重大过失的情形）
王某父母（监护人）是否因未尽到看护责任而应承担相应责任？
精神损害抚慰金的主张是否合理？', length=415
2025-10-11 21:03:25.880 [Async-1] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 21:03:25.880 [Async-1] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 21:03:25.886 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=dc83db76, method=POST, uri=/api/v1/chat/stream, status=200, duration=204ms
2025-10-11 21:04:33.298 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 2953
2025-10-11 21:04:33.312 [http-nio-8080-exec-5] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 21:09:59.815 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我环境保护法第30条的内容, modelType=UNIFIED
2025-10-11 21:09:59.816 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 21:09:59.824 [http-nio-8080-exec-6] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760188199800_hwkf5aq40, userId=1, title=请你告诉我环境保护法第30条的内容
2025-10-11 21:09:59.832 [http-nio-8080-exec-7] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 21:09:59.840 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 21:09:59.840 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 21:09:59.841 [Async-2] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='请你告诉我环境保护法第30条的内容', length=17
2025-10-11 21:09:59.841 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=58a795e5, method=POST, uri=/api/v1/chat/stream, status=200, duration=27ms
2025-10-11 21:09:59.841 [Async-2] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 21:09:59.841 [Async-2] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 21:09:59.853 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=c2b86121, method=GET, uri=/api/v1/chat/sessions, status=200, duration=23ms
2025-10-11 21:10:39.467 [http-nio-8080-exec-9] WARN  c.r.L.c.UnifiedChatController - 流式聊天超时
2025-10-11 21:10:39.470 [http-nio-8080-exec-9] ERROR c.r.L.e.GlobalExceptionHandler - 运行时异常
java.lang.RuntimeException: 聊天超时
	at com.river.LegalAssistant.controller.UnifiedChatController.lambda$chatStream$1(UnifiedChatController.java:267)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter$DefaultCallback.run(ResponseBodyEmitter.java:377)
	at org.springframework.web.context.request.async.DeferredResult$1.handleTimeout(DeferredResult.java:298)
	at org.springframework.web.context.request.async.DeferredResultInterceptorChain.triggerAfterTimeout(DeferredResultInterceptorChain.java:81)
	at org.springframework.web.context.request.async.WebAsyncManager.lambda$startDeferredResultProcessing$5(WebAsyncManager.java:457)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)
	at org.springframework.web.context.request.async.StandardServletAsyncWebRequest.onTimeout(StandardServletAsyncWebRequest.java:185)
	at org.apache.catalina.core.AsyncListenerWrapper.fireOnTimeout(AsyncListenerWrapper.java:44)
	at org.apache.catalina.core.AsyncContextImpl.timeout(AsyncContextImpl.java:136)
	at org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:135)
	at org.apache.coyote.AbstractProcessor.dispatch(AbstractProcessor.java:243)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:57)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:905)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1741)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1190)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)
	at java.base/java.lang.Thread.run(Thread.java:1583)
2025-10-11 21:10:39.475 [http-nio-8080-exec-9] WARN  o.s.w.s.m.m.a.ExceptionHandlerExceptionResolver - Failure in @ExceptionHandler com.river.LegalAssistant.exception.GlobalExceptionHandler#handleRuntimeException(RuntimeException)
org.springframework.http.converter.HttpMessageNotWritableException: No converter for [class com.river.LegalAssistant.dto.ApiResponse] with preset Content-Type 'text/event-stream;charset=UTF-8'
	at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:319)
	at org.springframework.web.servlet.mvc.method.annotation.HttpEntityMethodProcessor.handleReturnValue(HttpEntityMethodProcessor.java:245)
	at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:78)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:136)
	at org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver.doResolveHandlerMethodException(ExceptionHandlerExceptionResolver.java:432)
	at org.springframework.web.servlet.handler.AbstractHandlerMethodExceptionResolver.doResolveException(AbstractHandlerMethodExceptionResolver.java:74)
	at org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver.resolveException(AbstractHandlerExceptionResolver.java:175)
	at org.springframework.web.servlet.handler.HandlerExceptionResolverComposite.resolveException(HandlerExceptionResolverComposite.java:80)
	at org.springframework.web.servlet.DispatcherServlet.processHandlerException(DispatcherServlet.java:1358)
	at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1161)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1106)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:914)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:590)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:195)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:108)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:91)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113)
	at org.springframework.web.servlet.handler.HandlerMappingIntrospector.lambda$createCacheFilter$3(HandlerMappingIntrospector.java:195)
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113)
	at org.springframework.web.filter.CompositeFilter.doFilter(CompositeFilter.java:74)
	at org.springframework.security.config.annotation.web.configuration.WebMvcSecurityConfiguration$CompositeFilterChainProxy.doFilter(WebMvcSecurityConfiguration.java:230)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:113)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:632)
	at org.apache.catalina.core.ApplicationDispatcher.doDispatch(ApplicationDispatcher.java:560)
	at org.apache.catalina.core.ApplicationDispatcher.dispatch(ApplicationDispatcher.java:531)
	at org.apache.catalina.core.AsyncContextImpl$AsyncRunnable.run(AsyncContextImpl.java:601)
	at org.apache.catalina.core.AsyncContextImpl.doInternalDispatch(AsyncContextImpl.java:344)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:165)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:483)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:115)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)
	at org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:239)
	at org.apache.coyote.AbstractProcessor.dispatch(AbstractProcessor.java:243)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:57)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:905)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1741)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1190)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)
	at java.base/java.lang.Thread.run(Thread.java:1583)
2025-10-11 21:10:39.483 [http-nio-8080-exec-9] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 21:10:39.520 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.520 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.588 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.661 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.662 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.733 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.734 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.805 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.806 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.879 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.880 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.950 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:39.951 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.022 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.023 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.094 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.095 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.166 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.167 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.243 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.244 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.314 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.314 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.383 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.384 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.457 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.458 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.528 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.528 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.599 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.672 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.673 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.744 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.833 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.891 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.892 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.961 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:40.962 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.034 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.107 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.180 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.251 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.327 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.328 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.399 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.399 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.469 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.471 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.543 [ForkJoinPool.commonPool-worker-3] ERROR c.r.L.service.AgentService - ❌ 发送内容片段失败
java.lang.IllegalStateException: ResponseBodyEmitter has already completed with error: java.lang.RuntimeException: 聊天超时
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at com.river.LegalAssistant.service.AgentService$2.onPartialResponse(AgentService.java:1198)
	at dev.langchain4j.model.chat.StreamingChatModel$1.onPartialResponse(StreamingChatModel.java:51)
	at dev.langchain4j.internal.InternalStreamingChatResponseHandlerUtils.onPartialResponse(InternalStreamingChatResponseHandlerUtils.java:36)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.handle(OpenAiStreamingChatModel.java:193)
	at dev.langchain4j.model.openai.OpenAiStreamingChatModel.lambda$doChat$0(OpenAiStreamingChatModel.java:152)
	at dev.langchain4j.model.openai.internal.StreamingRequestExecutor$2.onEvent(StreamingRequestExecutor.java:112)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.lambda$parse$0(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.sse.ServerSentEventListenerUtils.ignoringExceptions(ServerSentEventListenerUtils.java:14)
	at dev.langchain4j.http.client.sse.DefaultServerSentEventParser.parse(DefaultServerSentEventParser.java:25)
	at dev.langchain4j.http.client.jdk.JdkHttpClient.lambda$execute$0(JdkHttpClient.java:81)
	at java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)
	at java.base/java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:614)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:844)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:483)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)
2025-10-11 21:10:41.587 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 21:10:41.592 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
2025-10-11 21:31:51.827 [main] INFO  c.r.L.LegalAssistantApplication - Starting LegalAssistantApplication using Java 21.0.5 with PID 21816 (F:\LegalAssistant\target\classes started by river in F:\LegalAssistant)
2025-10-11 21:31:51.828 [main] INFO  c.r.L.LegalAssistantApplication - No active profile set, falling back to 1 default profile: "default"
2025-10-11 21:31:54.415 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Starting...
2025-10-11 21:31:54.572 [main] INFO  com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@355b4c34
2025-10-11 21:31:54.634 [main] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Start completed.
2025-10-11 21:31:54.653 [main] INFO  org.flywaydb.core.FlywayExecutor - Database: jdbc:postgresql://localhost:5432/legal_assistant (PostgreSQL 17.6)
2025-10-11 21:31:54.660 [main] WARN  o.f.c.i.database.base.Database - Flyway upgrade recommended: PostgreSQL 17.6 is newer than this version of Flyway and support has not been tested. The latest supported version of PostgreSQL is 16.
2025-10-11 21:31:54.748 [main] INFO  o.f.core.internal.command.DbMigrate - Current version of schema "public": 11
2025-10-11 21:31:54.751 [main] INFO  o.f.core.internal.command.DbMigrate - Schema "public" is up to date. No migration necessary.
2025-10-11 21:31:55.195 [main] WARN  org.hibernate.orm.deprecation - HHH90000025: PostgreSQLDialect does not need to be specified explicitly using 'hibernate.dialect' (remove the property setting and it will be selected by default)
2025-10-11 21:31:56.724 [main] INFO  c.g.x.k.s.c.Knife4jAutoConfiguration - init CorsFilter...
2025-10-11 21:31:56.777 [main] INFO  c.r.L.service.PromptTemplateService - 开始初始化提示词模板服务...
2025-10-11 21:31:56.780 [main] INFO  c.r.L.service.PromptTemplateService - 提示词模板服务初始化完成，共加载 14 个模板
2025-10-11 21:31:56.802 [main] INFO  c.r.L.config.OllamaConfig - === Ollama 配置初始化 ===
2025-10-11 21:31:56.803 [main] INFO  c.r.L.config.OllamaConfig - 使用本地 Ollama 服务，不依赖任何云端 AI 服务
2025-10-11 21:31:56.803 [main] INFO  c.r.L.config.OllamaConfig - 确保 Ollama 服务运行在 http://localhost:11434
2025-10-11 21:31:56.803 [main] INFO  c.r.L.config.OllamaConfig - 推荐模型:
2025-10-11 21:31:56.803 [main] INFO  c.r.L.config.OllamaConfig -   - 聊天模型: qwen2:1.5b, llama3.2:3b
2025-10-11 21:31:56.803 [main] INFO  c.r.L.config.OllamaConfig -   - 嵌入模型: nomic-embed-text
2025-10-11 21:31:56.803 [main] INFO  c.r.L.config.OllamaConfig - ========================
2025-10-11 21:31:57.160 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化主要聊天客户端，优先使用DeepSeek模型
2025-10-11 21:31:57.190 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆存储库（内存存储）
2025-10-11 21:31:57.191 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建Ollama聊天记忆，最大消息数: 15
2025-10-11 21:31:57.195 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆存储库（内存存储）
2025-10-11 21:31:57.195 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建DeepSeek聊天记忆，最大消息数: 30
2025-10-11 21:31:57.196 [main] INFO  c.r.L.service.ChatMemoryService - 聊天记忆服务初始化完成
2025-10-11 21:31:57.229 [main] INFO  c.r.LegalAssistant.config.AiConfig - 设置 Ollama Embedding 模型为主要嵌入模型
2025-10-11 21:31:57.407 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Using the vector table name: vector_store. Is empty: false
2025-10-11 21:31:57.411 [main] INFO  o.s.a.v.pgvector.PgVectorStore - Initializing PGVectorStore schema for table: vector_store in schema: public
2025-10-11 21:31:57.411 [main] INFO  o.s.a.v.pgvector.PgVectorStore - vectorTableValidationsEnabled false
2025-10-11 21:31:57.412 [main] DEBUG o.s.a.v.pgvector.PgVectorStore - Skipping the schema initialization for the table: public.vector_store
2025-10-11 21:31:57.424 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j PGVector 嵌入存储（独立表）
2025-10-11 21:31:57.425 [main] INFO  c.r.L.config.LangChain4jConfig - 连接 PGVector 数据库: localhost:5432/legal_assistant, 表: langchain4j_embeddings, 维度: 768
2025-10-11 21:31:57.494 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 嵌入模型: nomic-embed-text
2025-10-11 21:31:57.797 [main] INFO  c.r.L.config.AsyncConfig - 初始化支持SecurityContext的异步执行器
2025-10-11 21:31:57.805 [main] INFO  c.r.L.service.AgentService - 混合AI法律顾问代理服务启动
2025-10-11 21:31:57.807 [main] INFO  c.r.L.service.AgentService - 正在初始化混合AI法律顾问代理服务...
2025-10-11 21:31:57.807 [main] INFO  c.r.L.service.AgentService - 配置：混合模式=true, 基础提供者=ollama, 高级提供者=deepseek, 自动降级=true
2025-10-11 21:31:57.807 [main] INFO  c.r.L.service.AgentService - 初始化基础AI服务：ollama (qwen2:1.5b)
2025-10-11 21:31:57.813 [main] INFO  c.r.L.service.AgentService - 基础AI服务初始化成功：qwen2:1.5b
2025-10-11 21:31:57.813 [main] INFO  c.r.L.service.AgentService - 初始化高级AI服务：deepseek (deepseek-chat)
2025-10-11 21:31:57.837 [main] INFO  c.r.L.service.AgentService - 高级AI服务初始化成功：deepseek-chat
2025-10-11 21:31:57.837 [main] INFO  c.r.L.service.AgentService - === 混合AI法律顾问服务初始化完成 ===
2025-10-11 21:31:57.837 [main] INFO  c.r.L.service.AgentService - 基础服务状态：可用 (qwen2:1.5b)
2025-10-11 21:31:57.837 [main] INFO  c.r.L.service.AgentService - 高级服务状态：可用 (deepseek-chat)
2025-10-11 21:31:57.838 [main] INFO  c.r.L.service.AgentService - 自动降级：启用
2025-10-11 21:31:57.838 [main] INFO  c.r.L.service.AgentService - 混合AI架构完全就绪，智能路由已激活。
2025-10-11 21:31:57.838 [main] INFO  c.r.L.service.AgentService - ========================================
2025-10-11 21:31:57.850 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 聊天模型: qwen2:1.5b
2025-10-11 21:31:57.857 [main] INFO  c.r.L.config.LangChain4jConfig - 初始化 LangChain4j 流式聊天模型: qwen2:1.5b
2025-10-11 21:31:57.877 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 初始化法律查询路由器...
2025-10-11 21:31:57.878 [main] INFO  c.r.L.s.advanced.LegalQueryRouter - 法律查询路由器初始化完成，配置 6 个检索器
2025-10-11 21:31:57.891 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 开始初始化 Advanced Legal RAG 服务...
2025-10-11 21:31:57.891 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG 检索增强器...
2025-10-11 21:31:57.893 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 检索增强器构建完成
2025-10-11 21:31:57.893 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - 构建 Advanced RAG AI 服务...
2025-10-11 21:31:57.894 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced RAG AI 服务构建完成
2025-10-11 21:31:57.895 [main] INFO  c.r.L.s.a.AdvancedLegalRagService - Advanced Legal RAG 服务初始化成功
2025-10-11 21:31:57.950 [main] INFO  o.s.s.c.a.a.c.InitializeUserDetailsBeanManagerConfigurer$InitializeUserDetailsManagerConfigurer - Global AuthenticationManager configured with UserDetailsService bean with name userService
2025-10-11 21:31:58.391 [main] INFO  c.r.L.service.EtlService - ETL服务初始化完成 - chunk大小: 0, 重叠: 0, 最小块: 0
2025-10-11 21:31:58.482 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig - 初始化法律文档分割器配置:
2025-10-11 21:31:58.483 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 最大Token数: 512
2025-10-11 21:31:58.483 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 层级结构解析: true
2025-10-11 21:31:58.483 [main] INFO  c.r.L.c.LegalDocumentSplitterConfig -   - 重叠字符数: 50
2025-10-11 21:31:58.484 [main] INFO  c.r.L.s.s.LegalDocumentSplitter - 初始化法律文档分割器 - maxTokens: 512, enableHierarchicalParsing: true, chunkOverlap: 50
2025-10-11 21:31:58.491 [main] INFO  c.r.L.s.s.DocumentSplitterFactory - DocumentSplitterFactory 初始化完成 - 已注册分割器: Legal, Contract, Recursive
2025-10-11 21:31:58.493 [main] INFO  c.r.L.s.DocumentProcessingService - DocumentProcessingService 初始化完成 - 统一文档处理服务已启用
2025-10-11 21:31:58.569 [main] INFO  c.r.L.s.DocumentIndexingService - DocumentIndexingService 初始化完成,已启用法律文档分割器
2025-10-11 21:31:58.596 [main] INFO  c.r.L.s.VectorDatabaseManagementService - VectorDatabaseManagementService 初始化完成,已启用统一文档处理服务和法律文档分割器
2025-10-11 21:31:58.619 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化基础聊天客户端，使用Ollama Chat模型
2025-10-11 21:31:58.621 [main] INFO  c.r.LegalAssistant.config.AiConfig - 初始化高级聊天客户端，使用DeepSeek Chat模型
2025-10-11 21:31:58.648 [main] INFO  c.r.L.config.ChatMemoryConfig - 创建默认聊天记忆，使用Ollama聊天记忆
2025-10-11 21:31:58.649 [main] INFO  c.r.L.config.OpenApiConfig - 初始化OpenAPI配置, contextPath: /api/v1, port: 8080
2025-10-11 21:31:58.772 [main] WARN  o.s.b.a.o.j.JpaBaseConfiguration$JpaWebConfiguration - spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-11 21:31:58.998 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置现有JSON消息转换器，禁用非ASCII字符转义
2025-10-11 21:31:59.299 [main] INFO  c.r.LegalAssistant.config.SseConfig - SSE ObjectMapper配置完成，禁用非ASCII字符转义
2025-10-11 21:31:59.457 [main] INFO  c.r.LegalAssistant.config.WebConfig - 配置Web异步支持，设置超时为25分钟以支持长时间AI分析
2025-10-11 21:32:00.353 [main] INFO  c.r.L.LegalAssistantApplication - Started LegalAssistantApplication in 8.929 seconds (process running for 9.222)
2025-10-11 21:32:04.505 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 21:32:04.555 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=caf34983, method=GET, uri=/api/v1/chat/sessions, status=200, duration=70ms
2025-10-11 21:32:05.427 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760188199800_hwkf5aq40 的消息
2025-10-11 21:32:05.442 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0c9f2150, method=GET, uri=/api/v1/chat/sessions/session_1760188199800_hwkf5aq40, status=200, duration=26ms
2025-10-11 21:32:17.699 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 21:32:17.713 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4c944428, method=GET, uri=/api/v1/chat/sessions, status=200, duration=15ms
2025-10-11 21:32:17.763 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我环境保护法第32条的内容, modelType=UNIFIED
2025-10-11 21:32:17.766 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 21:32:17.803 [http-nio-8080-exec-3] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760189537676_6ogydyiik, userId=1, title=请你告诉我环境保护法第32条的内容
2025-10-11 21:32:17.861 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 21:32:17.861 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 21:32:17.865 [Async-1] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='请你告诉我环境保护法第32条的内容', length=17
2025-10-11 21:32:17.865 [Async-1] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 21:32:17.865 [Async-1] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 21:32:17.871 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f48c7ee4, method=POST, uri=/api/v1/chat/stream, status=200, duration=176ms
2025-10-11 21:33:05.753 [ForkJoinPool.commonPool-worker-1] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 2235
2025-10-11 21:33:05.766 [http-nio-8080-exec-5] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 21:34:07.125 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我环境保护法第30条的内容, modelType=UNIFIED
2025-10-11 21:34:07.126 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 21:34:07.143 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 21:34:07.143 [http-nio-8080-exec-6] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 21:34:07.144 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=80dae0e8, method=POST, uri=/api/v1/chat/stream, status=200, duration=20ms
2025-10-11 21:34:07.144 [Async-2] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='请你告诉我环境保护法第30条的内容', length=17
2025-10-11 21:34:07.145 [Async-2] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 21:34:07.145 [Async-2] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 21:34:52.692 [ForkJoinPool.commonPool-worker-2] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 2081
2025-10-11 21:34:52.695 [http-nio-8080-exec-7] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 21:35:31.912 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=8ee88785, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=69ms
2025-10-11 21:35:33.871 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0472e810, method=GET, uri=/api/v1/users, status=200, duration=9ms
2025-10-11 21:35:37.036 [http-nio-8080-exec-10] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 30
2025-10-11 21:35:37.055 [http-nio-8080-exec-10] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 30, 文件大小: 337434 bytes
2025-10-11 21:35:37.055 [http-nio-8080-exec-10] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 上海市养老服务合同分析报告.pdf
2025-10-11 21:35:37.056 [http-nio-8080-exec-10] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 30, 文件大小: 337434 bytes, 文件名: 上海市养老服务合同分析报告.pdf
2025-10-11 21:35:37.058 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=31914741, method=GET, uri=/api/v1/contracts/30/report, status=200, duration=23ms
2025-10-11 21:36:01.060 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=2
2025-10-11 21:36:01.064 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=45ce45df, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=23ms
2025-10-11 21:36:22.423 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 劳动法.pdf
2025-10-11 21:36:22.438 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 劳动法.pdf, 大小: 189938 bytes
2025-10-11 21:36:22.439 [http-nio-8080-exec-2] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 劳动法.pdf, 类型: pdf, 大小: 189938 bytes
2025-10-11 21:36:22.796 [http-nio-8080-exec-2] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 劳动法.pdf, 内容长度: 8807 字符
2025-10-11 21:36:22.799 [http-nio-8080-exec-2] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 8807 字符
2025-10-11 21:36:22.801 [http-nio-8080-exec-2] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 21:36:22.805 [http-nio-8080-exec-2] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 115 个片段
2025-10-11 21:36:26.303 [http-nio-8080-exec-2] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 112, 存储数: 112, 耗时: 3504ms
2025-10-11 21:36:26.320 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：劳动法.pdf
2025-10-11 21:36:26.320 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 劳动法.pdf, 文档ID: 7, 块数: 112, 分割器: LegalDocumentSplitter
2025-10-11 21:36:26.328 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=4ce7f6c0, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=3925ms
2025-10-11 21:36:26.430 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=3
2025-10-11 21:36:26.435 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=1fc05aab, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=26ms
2025-10-11 21:38:17.721 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=3
2025-10-11 21:38:17.723 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=d415b5ca, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=8ms
2025-10-11 21:38:33.698 [http-nio-8080-exec-5] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 民事诉讼法.pdf
2025-10-11 21:38:33.715 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 民事诉讼法.pdf, 大小: 435705 bytes
2025-10-11 21:38:33.715 [http-nio-8080-exec-5] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 民事诉讼法.pdf, 类型: pdf, 大小: 435705 bytes
2025-10-11 21:38:33.961 [http-nio-8080-exec-5] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 民事诉讼法.pdf, 内容长度: 37209 字符
2025-10-11 21:38:33.964 [http-nio-8080-exec-5] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 37209 字符
2025-10-11 21:38:33.965 [http-nio-8080-exec-5] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 21:38:33.973 [http-nio-8080-exec-5] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 319 个片段
2025-10-11 21:38:38.258 [http-nio-8080-exec-5] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 316, 存储数: 316, 耗时: 4292ms
2025-10-11 21:38:38.265 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：民事诉讼法.pdf
2025-10-11 21:38:38.266 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 民事诉讼法.pdf, 文档ID: 8, 块数: 316, 分割器: LegalDocumentSplitter
2025-10-11 21:38:38.267 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6a6be99a, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=4573ms
2025-10-11 21:38:38.304 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=4
2025-10-11 21:38:38.305 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=54bcb63e, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=7ms
2025-10-11 21:42:32.778 [http-nio-8080-exec-7] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 宪法.pdf
2025-10-11 21:42:32.790 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 宪法.pdf, 大小: 525440 bytes
2025-10-11 21:42:32.790 [http-nio-8080-exec-7] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 宪法.pdf, 类型: pdf, 大小: 525440 bytes
2025-10-11 21:42:32.992 [http-nio-8080-exec-7] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 宪法.pdf, 内容长度: 18571 字符
2025-10-11 21:42:32.995 [http-nio-8080-exec-7] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 18571 字符
2025-10-11 21:42:32.996 [http-nio-8080-exec-7] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 21:42:32.998 [http-nio-8080-exec-7] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 143 个片段
2025-10-11 21:42:35.773 [http-nio-8080-exec-7] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 143, 存储数: 143, 耗时: 2777ms
2025-10-11 21:42:35.779 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：宪法.pdf
2025-10-11 21:42:35.780 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 宪法.pdf, 文档ID: 9, 块数: 143, 分割器: LegalDocumentSplitter
2025-10-11 21:42:35.785 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3ae2d505, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=3015ms
2025-10-11 21:42:35.856 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=5
2025-10-11 21:42:35.862 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=5eafc96f, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=31ms
2025-10-11 21:42:57.221 [http-nio-8080-exec-9] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 9
2025-10-11 21:42:57.222 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 9
2025-10-11 21:42:57.225 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 从向量存储中获取文档向量块: 9
2025-10-11 21:42:57.296 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 通过文件名获取到 143 个向量块
2025-10-11 21:42:57.297 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 获取到 143 个向量块
2025-10-11 21:42:57.311 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=268d79d9, method=GET, uri=/api/v1/knowledge-base/documents/9/chunks, status=200, duration=93ms
2025-10-11 21:43:09.542 [http-nio-8080-exec-10] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 9
2025-10-11 21:43:09.543 [http-nio-8080-exec-10] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 9
2025-10-11 21:43:09.551 [http-nio-8080-exec-10] INFO  c.r.L.service.KnowledgeBaseService - 从向量存储中获取文档向量块: 9
2025-10-11 21:43:09.596 [http-nio-8080-exec-10] INFO  c.r.L.service.KnowledgeBaseService - 通过文件名获取到 143 个向量块
2025-10-11 21:43:09.598 [http-nio-8080-exec-10] INFO  c.r.L.service.KnowledgeBaseService - 获取到 143 个向量块
2025-10-11 21:43:09.606 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=d8c66615, method=GET, uri=/api/v1/knowledge-base/documents/9/chunks, status=200, duration=66ms
2025-10-11 21:43:12.339 [http-nio-8080-exec-1] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 8
2025-10-11 21:43:12.339 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 8
2025-10-11 21:43:12.348 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 从向量存储中获取文档向量块: 8
2025-10-11 21:43:12.421 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 通过文件名获取到 316 个向量块
2025-10-11 21:43:12.421 [http-nio-8080-exec-1] INFO  c.r.L.service.KnowledgeBaseService - 获取到 316 个向量块
2025-10-11 21:43:12.437 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ba5b5384, method=GET, uri=/api/v1/knowledge-base/documents/8/chunks, status=200, duration=101ms
2025-10-11 21:43:39.722 [http-nio-8080-exec-2] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 刑法.pdf
2025-10-11 21:43:39.735 [http-nio-8080-exec-2] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 刑法.pdf, 大小: 20050905 bytes
2025-10-11 21:43:39.736 [http-nio-8080-exec-2] ERROR c.r.L.service.KnowledgeBaseService - 文档上传失败: 刑法.pdf
com.river.LegalAssistant.service.DocumentParserService$DocumentParsingException: 文件大小超过限制（最大10MB）
	at com.river.LegalAssistant.service.DocumentParserService.parseDocument(DocumentParserService.java:64)
	at com.river.LegalAssistant.service.KnowledgeBaseService.uploadDocument(KnowledgeBaseService.java:69)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
	at java.base/java.lang.reflect.Method.invoke(Method.java:580)
	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:355)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:768)
	at org.springframework.cache.interceptor.CacheInterceptor.lambda$invoke$0(CacheInterceptor.java:55)
	at org.springframework.cache.interceptor.CacheAspectSupport.invokeOperation(CacheAspectSupport.java:416)
	at org.springframework.cache.interceptor.CacheAspectSupport.evaluate(CacheAspectSupport.java:551)
	at org.springframework.cache.interceptor.CacheAspectSupport.execute(CacheAspectSupport.java:433)
	at org.springframework.cache.interceptor.CacheAspectSupport.execute(CacheAspectSupport.java:395)
	at org.springframework.cache.interceptor.CacheInterceptor.invoke(CacheInterceptor.java:65)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:768)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:720)
	at com.river.LegalAssistant.service.KnowledgeBaseService$$SpringCGLIB$$0.uploadDocument(<generated>)
	at com.river.LegalAssistant.controller.KnowledgeBaseController.uploadSingleDocument(KnowledgeBaseController.java:104)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
	at java.base/java.lang.reflect.Method.invoke(Method.java:580)
	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:355)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:768)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.proceed(AuthorizationManagerBeforeMethodInterceptor.java:269)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.attemptAuthorization(AuthorizationManagerBeforeMethodInterceptor.java:264)
	at org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor.invoke(AuthorizationManagerBeforeMethodInterceptor.java:197)
	at org.springframework.security.config.annotation.method.configuration.DeferringMethodInterceptor.invoke(DeferringMethodInterceptor.java:44)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:768)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:720)
	at com.river.LegalAssistant.controller.KnowledgeBaseController$$SpringCGLIB$$0.uploadSingleDocument(<generated>)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
	at java.base/java.lang.reflect.Method.invoke(Method.java:580)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:255)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:188)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:926)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:831)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:914)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:590)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:195)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.CorsFilter.doFilterInternal(CorsFilter.java:91)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:110)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at com.river.LegalAssistant.filter.RateLimitFilter.doFilter(RateLimitFilter.java:82)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at com.river.LegalAssistant.filter.RequestTrackingFilter.doFilter(RequestTrackingFilter.java:51)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:108)
	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)
	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)
	at org.springframework.security.web.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:128)
	at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:131)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:85)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at com.river.LegalAssistant.filter.JwtAuthenticationFilter.doFilterInternal(JwtAuthenticationFilter.java:81)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.web.filter.CorsFilter.doFilterInternal(CorsFilter.java:91)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)
	at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)
	at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)
	at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)
	at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113)
	at org.springframework.web.servlet.handler.HandlerMappingIntrospector.lambda$createCacheFilter$3(HandlerMappingIntrospector.java:195)
	at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113)
	at org.springframework.web.filter.CompositeFilter.doFilter(CompositeFilter.java:74)
	at org.springframework.security.config.annotation.web.configuration.WebMvcSecurityConfiguration$CompositeFilterChainProxy.doFilter(WebMvcSecurityConfiguration.java:230)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:352)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:268)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:113)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:167)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:483)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:115)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:344)
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:384)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:905)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1741)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1190)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)
	at java.base/java.lang.Thread.run(Thread.java:1583)
2025-10-11 21:43:39.747 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=76880a4e, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=185ms
2025-10-11 21:43:39.831 [http-nio-8080-exec-4] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=5
2025-10-11 21:43:39.832 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=7f615633, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=22ms
2025-10-11 21:44:21.498 [http-nio-8080-exec-3] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=5
2025-10-11 21:44:21.499 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=14846840, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=13ms
2025-10-11 21:45:28.774 [http-nio-8080-exec-5] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 拍卖法.pdf
2025-10-11 21:45:28.783 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 拍卖法.pdf, 大小: 194898 bytes
2025-10-11 21:45:28.784 [http-nio-8080-exec-5] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 拍卖法.pdf, 类型: pdf, 大小: 194898 bytes
2025-10-11 21:45:28.835 [http-nio-8080-exec-5] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 拍卖法.pdf, 内容长度: 5198 字符
2025-10-11 21:45:28.837 [http-nio-8080-exec-5] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 5198 字符
2025-10-11 21:45:28.837 [http-nio-8080-exec-5] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 21:45:28.838 [http-nio-8080-exec-5] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 80 个片段
2025-10-11 21:45:30.436 [http-nio-8080-exec-5] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 78, 存储数: 78, 耗时: 1599ms
2025-10-11 21:45:30.442 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：拍卖法.pdf
2025-10-11 21:45:30.442 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 拍卖法.pdf, 文档ID: 10, 块数: 78, 分割器: LegalDocumentSplitter
2025-10-11 21:45:30.444 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=301ff34b, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=1674ms
2025-10-11 21:45:30.486 [http-nio-8080-exec-6] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=6
2025-10-11 21:45:30.489 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=1b2a02ae, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=10ms
2025-10-11 21:46:10.170 [http-nio-8080-exec-7] INFO  c.r.L.c.KnowledgeBaseController - 管理员上传单个法律文档: 社会保险法.pdf
2025-10-11 21:46:10.185 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 开始上传文档到知识库 (使用EtlService): 社会保险法.pdf, 大小: 204661 bytes
2025-10-11 21:46:10.185 [http-nio-8080-exec-7] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 社会保险法.pdf, 类型: pdf, 大小: 204661 bytes
2025-10-11 21:46:10.253 [http-nio-8080-exec-7] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 社会保险法.pdf, 内容长度: 10888 字符
2025-10-11 21:46:10.255 [http-nio-8080-exec-7] INFO  c.r.L.s.DocumentProcessingService - 开始处理文档 - 类型: LAW, 长度: 10888 字符
2025-10-11 21:46:10.256 [http-nio-8080-exec-7] WARN  c.r.L.s.s.LegalDocumentSplitter - 层级结构分割未识别到任何条文，降级到基础分割模式
2025-10-11 21:46:10.258 [http-nio-8080-exec-7] INFO  c.r.L.s.s.LegalDocumentSplitter - 文档分割完成,共生成 99 个片段
2025-10-11 21:46:12.006 [http-nio-8080-exec-7] INFO  c.r.L.s.DocumentProcessingService - 文档处理完成 - 片段数: 99, 存储数: 99, 耗时: 1750ms
2025-10-11 21:46:12.011 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 文档保存到数据库成功：社会保险法.pdf
2025-10-11 21:46:12.011 [http-nio-8080-exec-7] INFO  c.r.L.service.KnowledgeBaseService - 文档上传完成 (DocumentProcessingService): 社会保险法.pdf, 文档ID: 11, 块数: 99, 分割器: LegalDocumentSplitter
2025-10-11 21:46:12.013 [http-nio-8080-exec-7] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=dd20d9bd, method=POST, uri=/api/v1/knowledge-base/documents/upload-single, status=200, duration=1848ms
2025-10-11 21:46:12.081 [http-nio-8080-exec-8] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=7
2025-10-11 21:46:12.084 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6c274db1, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=22ms
2025-10-11 21:46:22.066 [http-nio-8080-exec-9] INFO  c.r.L.c.KnowledgeBaseController - 管理员获取文档向量块: 11
2025-10-11 21:46:22.067 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 获取文档向量块信息: 11
2025-10-11 21:46:22.074 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 从向量存储中获取文档向量块: 11
2025-10-11 21:46:22.110 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 通过文件名获取到 99 个向量块
2025-10-11 21:46:22.110 [http-nio-8080-exec-9] INFO  c.r.L.service.KnowledgeBaseService - 获取到 99 个向量块
2025-10-11 21:46:22.116 [http-nio-8080-exec-9] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=0b1d48ef, method=GET, uri=/api/v1/knowledge-base/documents/11/chunks, status=200, duration=54ms
2025-10-11 21:50:23.623 [http-nio-8080-exec-10] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 21:50:23.644 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=f872d451, method=GET, uri=/api/v1/chat/sessions, status=200, duration=23ms
2025-10-11 21:50:24.898 [http-nio-8080-exec-1] INFO  c.r.L.service.ChatHistoryService - 用户 1 获取会话 session_1760189537676_6ogydyiik 的消息
2025-10-11 21:50:24.903 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=1deb892f, method=GET, uri=/api/v1/chat/sessions/session_1760189537676_6ogydyiik, status=200, duration=5ms
2025-10-11 21:50:37.683 [http-nio-8080-exec-2] INFO  c.r.L.c.UnifiedChatController - 收到统一流式聊天请求: message=请你告诉我拍卖法第33条的内容\, modelType=UNIFIED
2025-10-11 21:50:37.683 [http-nio-8080-exec-2] INFO  c.r.L.c.UnifiedChatController - 用户 admin 通过JWT验证，开始处理流式聊天
2025-10-11 21:50:37.686 [http-nio-8080-exec-2] INFO  c.r.L.service.ChatHistoryService - 创建新会话: sessionId=session_1760190637668_61lcxmqvz, userId=1, title=请你告诉我拍卖法第33条的内容\
2025-10-11 21:50:37.691 [http-nio-8080-exec-4] INFO  c.r.L.service.ChatHistoryService - 获取用户 1 的所有会话
2025-10-11 21:50:37.703 [http-nio-8080-exec-2] INFO  c.r.L.c.UnifiedChatController - 使用统一模式进行流式处理
2025-10-11 21:50:37.703 [http-nio-8080-exec-2] INFO  c.r.L.c.UnifiedChatController - 统一流式模式路由到 -> Advanced Agent (默认)
2025-10-11 21:50:37.704 [Async-3] INFO  c.r.L.service.AgentService - 🚀 开始流式法律咨询处理: question='请你告诉我拍卖法第33条的内容\', length=16
2025-10-11 21:50:37.704 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=827892ec, method=POST, uri=/api/v1/chat/stream, status=200, duration=27ms
2025-10-11 21:50:37.704 [Async-3] INFO  c.r.L.service.AgentService - 使用高级流式模型进行推送
2025-10-11 21:50:37.704 [Async-3] INFO  c.r.L.service.AgentService - 📡 开始使用流式模型处理: model=OpenAiStreamingChatModel
2025-10-11 21:50:37.709 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=3d5fed25, method=GET, uri=/api/v1/chat/sessions, status=200, duration=18ms
2025-10-11 21:51:21.874 [ForkJoinPool.commonPool-worker-4] INFO  c.r.L.service.AgentService - 流式响应完成，总长度: 1866
2025-10-11 21:51:21.876 [http-nio-8080-exec-3] INFO  c.r.L.c.UnifiedChatController - 流式聊天完成
2025-10-11 21:53:19.991 [http-nio-8080-exec-5] INFO  c.r.L.service.FileStorageService - 文件保存成功: F:\LegalAssistant\uploads\contracts\38510dd150f93a254a62fb2b620563dd23c594a5810db4309ad4fa3f870d8e12_杭州市美容美发行业预付费服务合同.pdf, 大小: 307513 bytes
2025-10-11 21:53:19.993 [http-nio-8080-exec-5] INFO  c.r.L.service.ContractReviewService - 创建待处理审查记录，用户: admin, 文件: 杭州市美容美发行业预付费服务合同.pdf
2025-10-11 21:53:20.009 [http-nio-8080-exec-5] INFO  c.r.L.service.ContractReviewService - 待处理审查记录已创建 - ID: 31, 文件: 杭州市美容美发行业预付费服务合同.pdf
2025-10-11 21:53:20.014 [Async-4] INFO  c.r.L.service.ContractReviewService - 开始异步处理合同文件，审查ID: 31
2025-10-11 21:53:20.014 [Async-4] INFO  c.r.L.service.ContractReviewService - 异步处理线程: Async-4
2025-10-11 21:53:20.016 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=507aaaff, method=POST, uri=/api/v1/contracts/upload, status=202, duration=46ms
2025-10-11 21:53:20.018 [Async-4] INFO  c.r.L.service.ContractReviewService - 开始解析文件: 杭州市美容美发行业预付费服务合同.pdf, 路径: F:\LegalAssistant\uploads\contracts\38510dd150f93a254a62fb2b620563dd23c594a5810db4309ad4fa3f870d8e12_杭州市美容美发行业预付费服务合同.pdf
2025-10-11 21:53:20.019 [Async-4] INFO  c.r.L.service.DocumentParserService - 开始解析文档: 杭州市美容美发行业预付费服务合同.pdf, 类型: pdf, 大小: 307513 bytes
2025-10-11 21:53:20.045 [http-nio-8080-exec-6] INFO  c.r.L.c.ContractReviewController - 开始异步合同分析，审查ID: 31
2025-10-11 21:53:20.048 [http-nio-8080-exec-6] INFO  c.r.L.c.ContractReviewController - 用户 admin 通过JWT验证，开始处理合同分析，reviewId: 31
2025-10-11 21:53:20.048 [http-nio-8080-exec-6] INFO  c.r.L.c.ContractReviewController - SSE连接已建立: reviewId=31
2025-10-11 21:53:20.050 [http-nio-8080-exec-6] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=96be20cd, method=GET, uri=/api/v1/contracts/31/analyze-async, status=200, duration=6ms
2025-10-11 21:53:20.050 [Async-5] INFO  c.r.L.service.ContractReviewService - 开始异步分析合同（四步流程版），审查ID: 31
2025-10-11 21:53:20.051 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:20.054 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:20.059 [Async-4] INFO  c.r.L.service.DocumentParserService - 文档解析成功: 杭州市美容美发行业预付费服务合同.pdf, 内容长度: 4042 字符
2025-10-11 21:53:20.059 [Async-4] INFO  c.r.L.service.ContractReviewService - 文件解析成功: 杭州市美容美发行业预付费服务合同.pdf, 内容长度: 4042
2025-10-11 21:53:20.060 [Async-4] INFO  c.r.L.service.ContractReviewService - 文档解析完成，文本内容已保存: reviewId=31, 文本长度: 4042
2025-10-11 21:53:20.060 [Async-4] INFO  c.r.L.service.EtlService - 开始处理文本内容，长度: 4042 字符
2025-10-11 21:53:20.063 [Async-4] INFO  c.r.L.service.EtlService - 文本分块完成，生成 403 个文本块
2025-10-11 21:53:21.073 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:21.074 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:22.079 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:22.080 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:23.092 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:23.093 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:24.101 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:24.103 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:25.110 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:25.111 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:26.121 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:26.122 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:27.132 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:27.133 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:28.139 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:28.140 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 0
2025-10-11 21:53:28.231 [Async-4] INFO  c.r.L.service.EtlService - 文本内容处理完成，403 个向量块已存储
2025-10-11 21:53:28.231 [Async-4] INFO  c.r.L.service.ContractReviewService - 已成功将合同内容添加到AI知识库，审查ID: 31, 块数: 403
2025-10-11 21:53:28.232 [Async-4] INFO  c.r.L.service.ContractReviewService - 合同文件处理完成，审查ID: 31
2025-10-11 21:53:28.232 [Async-4] INFO  c.r.L.service.ContractReviewService - 异步处理合同文件方法结束，审查ID: 31
2025-10-11 21:53:29.150 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新审查记录（新事务）: reviewId=31
2025-10-11 21:53:29.151 [Async-5] INFO  c.r.L.service.ContractReviewService - 刷新完成，文本内容长度: 4042
2025-10-11 21:53:29.151 [Async-5] INFO  c.r.L.service.ContractReviewService - 文件解析完成，等待时间: 9秒, reviewId=31
2025-10-11 21:53:29.153 [Async-5] INFO  c.r.L.service.ContractReviewService - 步骤1完成：文档解析成功, reviewId=31
2025-10-11 21:53:29.162 [Async-5] INFO  c.r.LegalAssistant.service.AiService - 进行结构化合同风险分析，内容长度: 4042
2025-10-11 21:54:44.073 [Async-5] INFO  c.r.LegalAssistant.service.AiService - 结构化风险分析完成，识别出 10 个风险维度
2025-10-11 21:54:44.075 [Async-5] INFO  c.r.L.service.ContractReviewService - 步骤2完成：风险识别成功, reviewId=31
2025-10-11 21:54:44.077 [Async-5] INFO  c.r.L.service.AgentService - 开始分析合同关键条款，内容长度: 4042
2025-10-11 21:56:10.064 [Async-5] INFO  c.r.L.service.AgentService - JSON格式验证成功，包含 7 个关键条款
2025-10-11 21:56:10.064 [Async-5] INFO  c.r.L.service.AgentService - 关键条款分析完成，原始响应长度: 2443, 清理后长度: 2443
2025-10-11 21:56:10.064 [Async-5] INFO  c.r.L.service.ContractReviewService - 关键条款分析成功，识别出 7 个关键条款
2025-10-11 21:56:10.064 [Async-5] INFO  c.r.L.service.ContractReviewService - 步骤3完成：条款分析成功, reviewId=31
2025-10-11 21:56:10.101 [Async-5] INFO  c.r.L.service.ContractReviewService - 步骤4完成：分析结果保存成功, reviewId=31
2025-10-11 21:56:10.121 [Async-5] INFO  c.r.L.s.ReportGenerationService - 开始生成PDF报告，审查ID: 31
2025-10-11 21:56:10.121 [Async-5] INFO  c.r.L.s.ReportGenerationService - 初始化PDF中文字体支持...
2025-10-11 21:56:10.234 [Async-5] INFO  c.r.L.s.ReportGenerationService - ✓ 成功加载系统字体: C:/Windows/Fonts/STSONG.TTF (华文宋体优先，PDF兼容性最佳)
2025-10-11 21:56:10.283 [Async-5] INFO  c.r.L.s.ReportGenerationService - ✓ PDF文档字体设置成功
2025-10-11 21:56:10.284 [Async-5] INFO  c.r.L.s.ReportGenerationService - 准备生成增强内容...
2025-10-11 21:56:10.284 [Async-5] INFO  c.r.L.s.ReportGenerationService - 使用DeepSeek生成增强报告内容（带降级处理），审查ID: 31
2025-10-11 21:56:10.284 [Async-5] INFO  c.r.L.s.ReportGenerationService - 使用结构化方式生成增强报告内容，审查ID: 31
2025-10-11 21:56:15.178 [Async-5] INFO  c.r.L.s.ReportGenerationService - 开始使用结构化内容生成器生成报告，合同内容长度: 4042
2025-10-11 21:56:15.178 [ForkJoinPool.commonPool-worker-6] INFO  c.r.L.s.StructuredContentGenerator - 生成执行摘要结构化内容，审查ID: 31
2025-10-11 21:56:15.179 [ForkJoinPool.commonPool-worker-7] INFO  c.r.L.s.StructuredContentGenerator - 生成深度分析结构化内容，审查ID: 31
2025-10-11 21:56:15.179 [ForkJoinPool.commonPool-worker-8] INFO  c.r.L.s.StructuredContentGenerator - 生成改进建议结构化内容，审查ID: 31
2025-10-11 21:57:29.373 [Async-5] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成成功
2025-10-11 21:57:29.374 [Async-5] INFO  c.r.L.s.ReportGenerationService - 结构化内容生成完成，耗时: 79090ms
2025-10-11 21:57:29.374 [Async-5] INFO  c.r.L.util.ReportContentValidator - 【报告完整性验证通过】所有必要内容齐全
2025-10-11 21:57:29.377 [Async-5] INFO  c.r.L.s.ReportGenerationService - ✓ 增强内容生成成功
2025-10-11 21:57:29.377 [Async-5] INFO  c.r.L.s.ReportGenerationService - 开始添加报告各部分内容...
2025-10-11 21:57:29.544 [Async-5] INFO  c.r.L.s.ReportGenerationService - 所有PDF内容添加完成
2025-10-11 21:57:29.607 [Async-5] INFO  c.r.L.s.ReportGenerationService - PDF报告生成成功，审查ID: 31, 文件大小: 340679 bytes
2025-10-11 21:57:29.611 [Async-5] INFO  c.r.L.service.ContractReviewService - PDF报告已保存到文件系统: F:\LegalAssistant\uploads\reports\31_report.pdf
2025-10-11 21:57:29.625 [Async-5] INFO  c.r.L.service.ContractReviewService - 步骤5完成：PDF报告生成并保存成功, reviewId=31, 文件大小: 340679 bytes
2025-10-11 21:57:29.643 [Async-5] INFO  c.r.L.service.ContractReviewService - 合同异步分析流程全部完成, reviewId=31
2025-10-11 21:57:29.648 [http-nio-8080-exec-7] INFO  c.r.L.service.ContractReviewService - SSE连接完成: reviewId=31
2025-10-11 21:57:34.365 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 用户 admin 请求下载PDF报告，审查ID: 31
2025-10-11 21:57:34.372 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 从缓存读取PDF报告，审查ID: 31, 文件大小: 340679 bytes
2025-10-11 21:57:34.372 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - 生成最终报告文件名: 杭州市美容美发行业预付费服务合同分析报告.pdf
2025-10-11 21:57:34.372 [http-nio-8080-exec-8] INFO  c.r.L.c.ContractReviewController - PDF报告准备下载 [缓存]，审查ID: 31, 文件大小: 340679 bytes, 文件名: 杭州市美容美发行业预付费服务合同分析报告.pdf
2025-10-11 21:57:34.375 [http-nio-8080-exec-8] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=cd083df8, method=GET, uri=/api/v1/contracts/31/report, status=200, duration=12ms
2025-10-11 22:06:57.077 [http-nio-8080-exec-10] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=ac6169ce, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=17ms
2025-10-11 22:07:00.227 [http-nio-8080-exec-1] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=2bd565a3, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=10ms
2025-10-11 22:07:02.919 [http-nio-8080-exec-2] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=04411541, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=9ms
2025-10-11 22:07:04.895 [http-nio-8080-exec-4] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=54a42540, method=GET, uri=/api/v1/contracts/my-reviews, status=200, duration=10ms
2025-10-11 22:07:06.023 [http-nio-8080-exec-3] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=6d6fcf70, method=GET, uri=/api/v1/users, status=200, duration=5ms
2025-10-11 22:07:06.928 [http-nio-8080-exec-5] INFO  c.r.L.service.KnowledgeBaseService - 从数据库获取文档列表: 页码=0, 每页=20, 分类=null, 总数=7
2025-10-11 22:07:06.931 [http-nio-8080-exec-5] INFO  c.r.L.filter.RequestTrackingFilter - [REQUEST_END] traceId=e90d7435, method=GET, uri=/api/v1/knowledge-base/documents, status=200, duration=13ms
2025-10-11 22:07:23.340 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown initiated...
2025-10-11 22:07:23.347 [SpringApplicationShutdownHook] INFO  com.zaxxer.hikari.HikariDataSource - HikariPool-1 - Shutdown completed.
